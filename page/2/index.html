<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="若枫">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/head.jpg">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/assets/sundexin.jpg" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">若枫</a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a></li>
	        
				<li><a href="/archives/index.html">归档</a></li>
	        
				<li><a href="/tags/APM/">APM</a></li>
	        
				<li><a href="/tags/C++">C++</a></li>
	        
				<li><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a></li>
	        
				<li><a href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">神经网络</a></li>
	        
				<li><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F">计算机系统</a></li>
	        
				<li><a href="/tags/%E9%A3%9E%E8%A1%8C%E5%99%A8%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86">飞行器理论知识</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="weixin" target="_blank" href="/assets/wechat.jpg" title="weixin"><i class="icon-weixin"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:823784686@qq.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/assets/sundexin.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">若枫</h1>
			</hgroup>
			
			
			
				
			
				
			
				
			
				
			
				
			
				
			
				
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="weixin" target="_blank" href="/assets/wechat.jpg" title="weixin"><i class="icon-weixin"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:823784686@qq.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 70%">
				
				
					<li style="width: 11.11111111111111%"><a href="/">主页</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/archives/index.html">归档</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/tags/APM/">APM</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/tags/C++">C++</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">神经网络</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F">计算机系统</a></li>
		        
					<li style="width: 11.11111111111111%"><a href="/tags/%E9%A3%9E%E8%A1%8C%E5%99%A8%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86">飞行器理论知识</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-APM开发者手册" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/22/APM%E5%BC%80%E5%8F%91%E8%80%85%E6%89%8B%E5%86%8C/">APM开发者手册</a>
    </h1>
  

        
        <a href="/2020/05/22/APM%E5%BC%80%E5%8F%91%E8%80%85%E6%89%8B%E5%86%8C/" class="archive-article-date">
  	<time datetime="2020-05-22T13:30:31.275Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-22</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="APM开发者手册"><a href="#APM开发者手册" class="headerlink" title="APM开发者手册"></a>APM开发者手册</h1><h1 id="一：-Learning-ArduPilot-—-Introduction"><a href="#一：-Learning-ArduPilot-—-Introduction" class="headerlink" title="一： Learning ArduPilot — Introduction"></a>一： Learning ArduPilot — Introduction</h1><p>This page introduces the basic structure of ArduPilot. Before you get started you should work out what code exploring system you will use. You could just use a web browser and look at <a href="https://github.com/ArduPilot/ardupilot/" target="_blank" rel="noopener">https://github.com/ArduPilot/ardupilot/</a> but you will probably get a lot more out of it if you have <a href="where-to-get-the-code.html#where-to-get-the-code">cloned all of the git repositories</a> and use a good programmer’s IDE like the ones recommended <a href="code-editing-tools-and-ides.html#code-editing-tools-and-ides">here</a>.</p>
<h3 id="Basic-structure"><a href="#Basic-structure" class="headerlink" title="Basic structure  "></a>Basic structure  <img src="https://ardupilot.org/dev/_images/ArduPilot_HighLevelArchecture.png" alt=""></h3><hr>
<p>The basic structure of ArduPilot is broken up into 5 main parts:</p>
<ul>
<li>vehicle code</li>
<li>shared libraries</li>
<li>hardware abstraction layer (AP_HAL)</li>
<li>tools directories</li>
<li>external support code (i.e. mavlink, dronekit)</li>
</ul>
<h3 id="Vehicle-Code"><a href="#Vehicle-Code" class="headerlink" title="Vehicle Code"></a>Vehicle Code</h3><p>The vehicle directories are the top level directories that define the firmware for each vehicle type. Currently there are 5 vehicle types: Plane, Copter, Rover, Sub and AntennaTracker. Although There are a lot of common elements between different vehicle types, they are each different. For now we only have a <a href="apmcopter-code-overview.html#apmcopter-code-overview">detailed description of the code structure for the Copter code</a>.</p>
<p>Along with the *.cpp files, each vehicle directory contains a make.inc file which lists library dependencies. The Makefiles read this to create the -I and -L flags for the build.</p>
<h3 id="Libraries"><a href="#Libraries" class="headerlink" title="Libraries"></a>Libraries</h3><p>The <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries" target="_blank" rel="noopener">libraries</a> are shared amongst the four vehicle types Copter, Plane, Rover and AntennaTracker. These libraries include sensor drivers, attitude and position estimation (aka <a href="ekf.html#ekf">EKF</a>) and control code (i.e. PID controllers). See the <a href="apmcopter-programming-libraries.html#apmcopter-programming-libraries">Library Description</a>, <a href="learning-ardupilot-the-example-sketches.html#learning-ardupilot-the-example-sketches">Library Example Sketches</a> and <a href="code-overview-sensor-drivers.html#code-overview-sensor-drivers">Sensor Drivers</a> pages for more details.</p>
<h3 id="AP-HAL"><a href="#AP-HAL" class="headerlink" title="AP_HAL"></a>AP_HAL</h3><p>The AP_HAL layer (Hardware Abstraction Layer) is how we make ArduPilot portable to lots of different platforms. There is a top level AP_HAL in libraries/AP_HAL that defines the interface that the rest of the code has to specific board features, then there is a AP_HAL_XXX subdirectory for each board type, for example AP_HAL_AVR for AVR based boards, AP_HAL_PX4 for Pixhawk boards and AP_HAL_Linux for Linux based boards.</p>
<h4 id="Tools-directories"><a href="#Tools-directories" class="headerlink" title="Tools directories"></a>Tools directories</h4><p>The tools directories are miscellaneous support directories. For examples, tools/autotest provides the autotest infrastructure behind the <a href="https://autotest.ardupilot.org/" target="_blank" rel="noopener">autotest.ardupilot.org</a> site and tools/Replay provides our log replay utility.</p>
<h4 id="External-support-code"><a href="#External-support-code" class="headerlink" title="External support code"></a>External support code</h4><p>On some platforms we need external support code to provide additional features or board support. Currently the external trees are:</p>
<ul>
<li><a href="https://github.com/ArduPilot/PX4NuttX" target="_blank" rel="noopener">PX4NuttX</a> - the core NuttX RTOS used on Pixhawk boards</li>
<li><a href="https://github.com/ArduPilot/PX4Firmware" target="_blank" rel="noopener">PX4Firmware</a> - the base PX4 middleware and drivers used on Pixhawk boards</li>
<li><a href="https://github.com/ArduPilot/uavcan" target="_blank" rel="noopener">uavcan</a> - the uavcan CANBUS implementation used in ArduPilot</li>
<li><a href="https://github.com/mavlink/mavlink" target="_blank" rel="noopener">mavlink</a> - the mavlink protocol and code generator</li>
</ul>
<p>Note</p>
<p>Most of these are imported as <a href="git-submodules.html#git-submodules">Git Submodules</a> when you <a href="building-the-code.html#building-the-code">build ArduPilot</a>.</p>
<h1 id="二：ArduPilot-Libraries"><a href="#二：ArduPilot-Libraries" class="headerlink" title="二：ArduPilot Libraries"></a>二：ArduPilot Libraries</h1><p>The <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries" target="_blank" rel="noopener">libraries</a> are shared with Copter, Plane and Rover. Below is a high level list of libraries and their function.</p>
<p><strong>Core libraries:</strong></p>
<ul>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_AHRS" target="_blank" rel="noopener">AP_AHRS</a> - attitude estimation using DCM or EKF</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Common" target="_blank" rel="noopener">AP_Common</a> - core includes required by all sketches and libraries</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Math" target="_blank" rel="noopener">AP_Math</a> - various math functions especially useful for vector manipulation</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AC_PID" target="_blank" rel="noopener">AC_PID</a> - PID(Proportional-Integral-Derivative) controller library</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_InertialNav" target="_blank" rel="noopener">AP_InertialNav</a> - inertial navigation library for blending accelerometer inputs with gps and baro data</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AC_AttitudeControl" target="_blank" rel="noopener">AC_AttitudeControl</a> - ArduCopter’s control library includes various functions of attitude, position control based on PID control.</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AC_WPNav" target="_blank" rel="noopener">AC_WPNav</a> - waypoint navigation library</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Motors" target="_blank" rel="noopener">AP_Motors</a> - multicopter and traditional helicopter motor mixing</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/RC_Channel" target="_blank" rel="noopener">RC_Channel</a> - a library to more convert pwm input/output from APM_RC into internal units such as angles</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_HAL" target="_blank" rel="noopener">AP_HAL</a>, <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_HAL_ChibiOS" target="_blank" rel="noopener">AP_HAL_ChibiOS</a>, <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_HAL_Linux" target="_blank" rel="noopener">AP_HAL_Linux</a> - libraries to implement the “Hardware abstraction layer” which presents an identical interface to the high level code so that it can more easily be ported to different boards.</li>
</ul>
<p><strong>Sensor libraries:</strong></p>
<ul>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_InertialSensor" target="_blank" rel="noopener">AP_InertialSensor</a> - reads gyro and accelerometer data, perform calibration and provides data in standard units (deg/s, m/s) to main code and other libraries</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_RangeFinder" target="_blank" rel="noopener">AP_RangeFinder</a> - sonar and ir distance sensor interfaced library</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Baro" target="_blank" rel="noopener">AP_Baro</a> - barometer interface library</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_GPS" target="_blank" rel="noopener">AP_GPS</a> - gps interface library</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Compass" target="_blank" rel="noopener">AP_Compass</a> - 3-axis compass interface library</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_OpticalFlow" target="_blank" rel="noopener">AP_OpticalFlow</a> - optical flow sensor interface library</li>
</ul>
<p><strong>Other libraries:</strong></p>
<ul>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Mount" target="_blank" rel="noopener">AP_Mount</a>, <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Camera" target="_blank" rel="noopener">AP_Camera</a>, <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Relay" target="_blank" rel="noopener">AP_Relay</a> - camera mount control library, camera shutter control libraries</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Mission" target="_blank" rel="noopener">AP_Mission</a> - stores/retrieves mission commands from eeprom</li>
<li><a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Buffer" target="_blank" rel="noopener">AP_Buffer</a> - a simple FIFO buffer for use with inertial navigation</li>
</ul>
<h1 id="三：-Library-Example-Sketches"><a href="#三：-Library-Example-Sketches" class="headerlink" title="三： Library Example Sketches"></a>三： Library Example Sketches</h1><p>The first step in exploring the code for yourself is to use the example sketches for the libraries. Following the arduino tradition we have example sketches for most libraries. A ‘sketch’ is just a main program, written as a cpp file.</p>
<p>Knowing the library API and conventions used in ArduPilot is essential to understanding the code. So using the library example sketches is a great way to get started. As a start you should read, build and run the example sketches for the following libraries:</p>
<ul>
<li>libraries/AP_GPS/examples/GPS_AUTO_test</li>
<li>libraries/AP_InertialSensor/examples/INS_generic</li>
<li>libraries/AP_Compass/examples/AP_Compass_test</li>
<li>libraries/AP_Baro/examples/BARO_generic</li>
<li>libraries/AP_AHRS/examples/AHRS_Test</li>
</ul>
<p>For example, the following will build and install the AP_GPS example sketch on a Pixhawk:</p>
<p>cd $ARDUPILOT_HOME # the top-level of an AruPilot repository<br>./waf configure —board=Pixhawk1<br>./waf build —target examples/INS_generic —upload</p>
<p>waf can list the examples it can build:</p>
<p>cd $ARDUPILOT_HOME<br>./waf list | grep ‘examples’</p>
<p>Once you have uploaded the example you can look at the output by attaching to the console. What the console is depends on the type of board. On Pixhawk boards it is the USB connector. So just connect to the USB device with your favourite serial program (the baudrate doesn’t matter).</p>
<p>For example, if you have mavproxy installed, you could do this to connect to a Pixhawk on Linux:</p>
<p>mavproxy.py --setup --master /dev/serial/by-id/usb-3D_Robotics_PX4_FMU_v2.x_0-if00</p>
<p>Using the –setup option puts mavproxy into raw serial mode, instead of processed MAVLink mode. That is what you need for the example sketches.</p>
<h2 id="Running-Examples-in-SITL"><a href="#Running-Examples-in-SITL" class="headerlink" title="Running Examples in SITL"></a>Running Examples in SITL</h2><p>Certain sketches can also be run in SITL. For example to run the protocol decoder sketch:</p>
<p>cd $ARDUPILOT_HOME # the top-level of an AruPilot repository<br>./waf configure —board sitl<br>./waf build —target examples/RCProtocolDecoder</p>
<p>To start the sketch, run it directly:</p>
<p>./build/sitl/examples/RCProtocolDecoder -M quad -C</p>
<h2 id="Understanding-the-example-sketch-code"><a href="#Understanding-the-example-sketch-code" class="headerlink" title="Understanding the example sketch code"></a>Understanding the example sketch code</h2><p>When you are reading the example sketch code (such as the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_GPS/examples/GPS_AUTO_test/GPS_AUTO_test.cpp" target="_blank" rel="noopener">GPS_AUTO_test</a> code) you will notice a few things that may seem strange at first:</p>
<ul>
<li>it declares a ‘hal’ variable as a reference</li>
<li>the code is quite rough and not well commented</li>
<li>the setup() and loop() functions</li>
</ul>
<h3 id="The-hal-reference"><a href="#The-hal-reference" class="headerlink" title="The hal reference"></a>The hal reference</h3><p>Every file that uses features of the AP_HAL needs to declare a hal reference. That gives access to a AP_HAL::HAL object, which provides access to all hardware specific functions, including things like printing messages to the console, sleeping and talking to I2C and SPI buses.</p>
<p>The actual hal variable is buried inside the board specific AP_HAL_XXX libraries. The reference in each file just provides a convenient way to get at the hal.</p>
<p>The most commonly used hal functions are:</p>
<ul>
<li>hal.console-&gt;printf() to print strings</li>
<li>AP_HAL::millis() and AP_HAL::micros() to get the time since boot</li>
<li>hal.scheduler-&gt;delay() and hal.scheduler-&gt;delay_microseconds() to sleep for a short time</li>
<li>hal.gpio-&gt;pinMode(), hal.gpio-&gt;read() and hal.gpio-&gt;write() for accessing GPIO pins</li>
<li>I2C access via hal.i2c</li>
<li>SPI access via hal.spi</li>
</ul>
<p>Go and have a look in the libraries/AP_HAL directory now for the full list of functions available on the HAL.</p>
<h3 id="The-setup-and-loop-functions"><a href="#The-setup-and-loop-functions" class="headerlink" title="The setup() and loop() functions"></a>The setup() and loop() functions</h3><p>You will notice that every sketch has a setup() function and loop() function. The setup() function is called when the board boots. The actual call comes from within the HAL for each board, so the main() function is buried inside the HAL, which then calls setup() after board specific startup is complete.</p>
<p>The setup() function is only called once, and typically initialises the libraries, and maybe prints a “hello” banner to show it is starting.</p>
<p>After setup() is finished the loop() function is continuously called (by the main code in the AP_HAL). The main work of the sketch is typically in the loop() function.</p>
<p>Note that this setup()/loop() arrangement is only the tip of the iceberg for more complex boards. It may make it seem that ArduPilot is single threaded, but in fact there is a lot more going on underneath, and on boards that have threading (such as Pixhawk and Linux based boards) there will in fact be lots of realtime threads started. See the section on understanding ArduPilot threading below.</p>
<h3 id="The-AP-HAL-MAIN-macro"><a href="#The-AP-HAL-MAIN-macro" class="headerlink" title="The AP_HAL_MAIN() macro"></a>The AP_HAL_MAIN() macro</h3><p>You will notice a extra line like this at the bottom of every sketch:</p>
<p>AP_HAL_MAIN();</p>
<p>That is a HAL macro that produces the necessary code to declare a C++ main function, along with any board level initialization code for the HAL. You rarely have to worry about how it works, but if you are curious you can look for the #define in the AP_HAL_XXX directories in each HAL. It is usually in AP_HAL_XXX_Main.h.</p>
<h3 id="Rough-Example-code"><a href="#Rough-Example-code" class="headerlink" title="Rough Example code"></a>Rough Example code</h3><p>You will notice that the example sketches are quite rough, and badly commented. This is your opportunity to make a contribution to the code! As you read through the example sketches and explore how they work add some comments to the code to explain the APIs and then <a href="submitting-patches-back-to-master.html#submitting-patches-back-to-master">submit a pull request</a> so others can benefit from your study.</p>
<h1 id="四：-Sensor-Drivers"><a href="#四：-Sensor-Drivers" class="headerlink" title="四： Sensor Drivers"></a>四： Sensor Drivers</h1><p>ArduPilot supports a wide variety of sensors from many different manufacturers. One clear example of this can be seen in the <a href="https://ardupilot.org/copter/docs/common-rangefinder-landingpage.html#common-rangefinder-landingpage" target="_blank" rel="noopener" title="(in Copter)">list of range finders</a> (aka sonars, lidars). This page attempts to explain how sensor drivers are written and integrated into the vehicle code.</p>
<h2 id="Supported-Protocols"><a href="#Supported-Protocols" class="headerlink" title="Supported Protocols"></a>Supported Protocols</h2><p><a href="https://en.wikipedia.org/wiki/I%C2%B2C" target="_blank" rel="noopener">I2C</a>, <a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus" target="_blank" rel="noopener">SPI</a>, <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver/transmitter" target="_blank" rel="noopener">UART (aka Serial)</a> and <a href="https://en.wikipedia.org/wiki/CAN_bus" target="_blank" rel="noopener">CANBUS</a> (in particular UAVCAN) protocols are supported. If you plan to write a new driver, you will likely need to refer to the sensor’s datasheet in order to determine which protocol it uses.</p>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><ul>
<li>one master, many slaves possible</li>
<li>a relatively simple protocol which is good for communicating over short-distances (i.e. less than 1m).</li>
<li>bus runs at 100kHz or 400kHz but the data rate is relatively low compared to other protocols.</li>
<li>only 4 pins are required (VCC, GND, SDA, SCL)</li>
</ul>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver-i2c1.png" alt=""><br><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver-i2c2.png" alt=""> </p>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><ul>
<li>one master, one slave</li>
<li>20Mhz+ speed meaning it is very fast especially compared to I2C</li>
<li>only works over short distances (10cm)</li>
<li>requires at least 5 pins (VCC, GND, SCLK, Master-Out-Slave-In, Master-In-Slave-Out) + 1 slave select pin per slave</li>
</ul>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver-spi1.png" alt=""><br><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver-spi2.png" alt=""></p>
<h3 id="Serial-UART"><a href="#Serial-UART" class="headerlink" title="Serial / UART"></a>Serial / UART</h3><ul>
<li>one master, one slave</li>
<li>character based protocol good for communicating over longer distances compared to I2C and SPI (i.e. 1m)</li>
<li>relatively fast at 57Kbps ~ 1.5Mbps</li>
<li>at least 4 pins required (VCC, GND, TX, RX), plus 2 optional pins (Clear-To-Send, Clear-To-Receive)</li>
</ul>
<h3 id="CAN-bus-with-UAVCAN"><a href="#CAN-bus-with-UAVCAN" class="headerlink" title="CAN bus with UAVCAN"></a>CAN bus with UAVCAN</h3><ul>
<li>multimaster bus, any node can initiate transmittion of data when they need to</li>
<li>packet based protocol for very long distances</li>
<li>high speed, typically 1 Mb (however only 50% of the bus bitrate can really be used without major collisions)</li>
<li>at least 3 pins required (GND, CAN HI, CAN LO). Optionally VCC can be used to power nodes</li>
<li>point-to-point topology. Star or stubs topolgy is not advised</li>
<li>termination is required at each end of the bus</li>
</ul>
<p><img src="https://ardupilot.org/dev/_images/code-overview-can-bus.png" alt=""></p>
<h2 id="FrontEnd-BackEnd-Split"><a href="#FrontEnd-BackEnd-Split" class="headerlink" title="FrontEnd / BackEnd Split"></a>FrontEnd / BackEnd Split</h2><p>An important concept within the sensor driver architecture is the front-end / back-end split.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-drivers-febesplit.png" alt=""></p>
<p>The vehicle code only ever calls into the Library’s (aka sensor driver’s) front-end.</p>
<p>On start-up the front-end creates one or more back-ends based either on automatic detection of the sensor (i.e. probing for a response on a known I2C address) or by using the user defined _TYPE params (i.e. RNGFND_TYPE, RNGFND_TYPE2). The front-end maintains pointers to each back-end which are normally held within an array named _drivers[].</p>
<p>User settable parameters are always held within the front-end.</p>
<h2 id="How-and-When-the-driver-code-is-run"><a href="#How-and-When-the-driver-code-is-run" class="headerlink" title="How and When the driver code is run"></a>How and When the driver code is run</h2><p><img src="https://ardupilot.org/dev/_images/copter-code-overview-architecture2.png" alt=""></p>
<p>The image above shows a zoomed in view of the ardupilot architecture. The top-left blue box illustrates how the sensor driver’s back-ends are run in a background thread. Raw data from the sensors is collected, converted into standard units and then held within buffers within the driver.</p>
<p>The vehicle code’s main thread runs regularly (i.e. 400hz for copter) and accesses the latest data available through methods in the driver’s front-end. For example in order to calculate the latest attitude estimate, the AHRS/EKF would pull the latest accelerometer, gyro and compass information from the sensor drivers’ front-ends.</p>
<p>The image is a slight generalization, for drivers using I2C or SPI, they must run in the background thread so that the highrate communication with the sensor does not affect the main loop’s performance but for driver’s using a serial (aka UART) interface, it is safe to run in the main thread because the underlying serial driver itself collects data in the background and includes a buffer.</p>
<h2 id="Vehicle-Code-and-Front-End-Example"><a href="#Vehicle-Code-and-Front-End-Example" class="headerlink" title="Vehicle Code and Front-End Example"></a>Vehicle Code and Front-End Example</h2><p>The example below shows how the Copter vehicle code pulls data from range finder (aka sonar, lidar) drivers. The Copter code’s <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L107" target="_blank" rel="noopener">scheduler</a> calls the vehicle’s read_rangefinder() method at 20Hz. Below is a picture of this method, the latest version can be seen in the <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/sensors.cpp" target="_blank" rel="noopener">sensors.cpp</a> file. The rangefinder.update() method is a call into the driver’s front-end.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver1.png" alt=""></p>
<p>Below is the range finder driver’s front-end <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_RangeFinder/AP_RangeFinder.cpp#L289" target="_blank" rel="noopener">update method</a>. This gives the driver a chance to do any general processing it might want to within the main thread. Each back-end’s update method is called in turn.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver2.png" alt=""></p>
<h2 id="UART-Serial-Back-End-Example"><a href="#UART-Serial-Back-End-Example" class="headerlink" title="UART/Serial Back-End Example"></a>UART/Serial Back-End Example</h2><p>Next is the update method of the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_RangeFinder/AP_RangeFinder_LightWareSerial.cpp" target="_blank" rel="noopener">LightWare back-end</a> using the serial protocol. As described on the <a href="https://ardupilot.org/copter/docs/common-lightware-sf10-lidar.html#serial-connection" target="_blank" rel="noopener">user wiki</a> the serial range finder can be connected to any of the flight controller’s serial ports but the user must specify which serial port, and what baud rate is used by setting the SERIALX_BAUD and SERIALX_PROTOCOL parameters.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver-uart1.png" alt=""></p>
<p>Within the serial driver’s <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_RangeFinder/AP_RangeFinder_Backend_Serial.cpp" target="_blank" rel="noopener">backend code</a>, it first finds which UART the user would like to use via the serial_manager class which looks for the parameters settings described above.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver8.png" alt=""></p>
<p>Each time the driver’s back-end update() method is called it calls the get_reading method which checks if new characters have arrived from the sensor and then decodes them.</p>
<p>As mentioned above, because the serial protocol implements it’s own buffering, the processing of any data (see get_reading method) from the sensor is run here in the main thread. I.e. there is no “register_periodic_callback” like you will see in I2C and SPI drivers.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver3.png" alt=""><br><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver4.png" alt=""></p>
<h2 id="I2C-Back-End-Example"><a href="#I2C-Back-End-Example" class="headerlink" title="I2C Back-End Example"></a>I2C Back-End Example</h2><p>This example shows the back-end for the Lightware I2C driver. In this case, the front-end gets the I2C bus and passes it to the back-end during initialisation.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver4.png" alt=""></p>
<p>The back-end’s init method then registers it’s “timer” method to be called at 20hz. Within the timer method (not shown) the get_reading() method is called which reads bytes from the sensor and converts the distance to centimeters.</p>
<h2 id="SPI-Back-End-Example"><a href="#SPI-Back-End-Example" class="headerlink" title="SPI Back-End Example"></a>SPI Back-End Example</h2><p>This example shows the back-end for the MPU9250 IMU which includes a gyro, accelerometer and compass. The front-end gets the SPI bus and passes it to the back-end during initialisation.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver6.png" alt=""></p>
<p>the start() method is called during initialisation and configures the sensor. It uses semaphores to ensure no interference with other SPI devices on the same bus.</p>
<p>The _read_sample method is registered so that it is called at 1000hz. Note there is no need to take/give semaphores within the _read_sample method because that is done as part of the periodic callback code.</p>
<p>the _block_read method shows how data can be read from the sensor’s registers.</p>
<p><img src="https://ardupilot.org/dev/_images/code-overview-sensor-driver7.png" alt=""></p>
<h2 id="Additional-Advice"><a href="#Additional-Advice" class="headerlink" title="Additional Advice"></a>Additional Advice</h2><p>When writing a sensor driver, never include any wait or sleep code because this will either delay the main thread or the background thread associated with the bus being used.</p>
<p>If a new library is written, it must be added to the wscript file in the vehicle directory (i.e. /ardupilot/ArduCopter/wscript) in order for it to be linked into the final binary</p>
<h1 id="五：Threading"><a href="#五：Threading" class="headerlink" title="五：Threading"></a>五：Threading</h1><h2 id="Understanding-ArduPilot-threading"><a href="#Understanding-ArduPilot-threading" class="headerlink" title="Understanding ArduPilot threading"></a>Understanding ArduPilot threading</h2><p>Once you have learned the basic of the ArduPilot libraries it is time for you to understand how ArduPilot deals with threading. The setup()/loop() structure that was inherited from arduino may make it seem that ArduPilot is a single threaded system, but in fact it isn’t.</p>
<p>The threading approach in ArduPilot depends on the board it is built for. Some boards (such as the APM1 and APM2) don’t support threads, so make do with a simple timer and callbacks. Some boards (PX4 and Linux) support a rich Posix threading model with realtime priorities, and these are used extensively by ArduPilot.</p>
<p>There are a number of key concepts related to threading that you need to understand in ArduPilot:</p>
<ul>
<li>The timer callbacks</li>
<li>HAL specific threads</li>
<li>driver specific threads</li>
<li>ardupilot drivers versus platform drivers</li>
<li>platform specific threads and tasks</li>
<li>the AP_Scheduler system</li>
<li>semaphores</li>
<li>lockless data structures</li>
</ul>
<h3 id="The-timer-callbacks"><a href="#The-timer-callbacks" class="headerlink" title="The timer callbacks"></a>The timer callbacks</h3><p>Every platform provides a 1kHz timer in the AP_HAL. Any code in ArduPilot can register a timer function which is then called at 1kHz. All registered timer functions are called sequentially. This very primitive mechanism is used as it is extremely portable, and yet very useful. You register a timer callback by calling the hal.scheduler-&gt;register_timer_process() like this:</p>
<p>hal.scheduler-&gt;register_timer_process(AP_HAL_MEMBERPROC(&amp;AP_Baro_MS5611::_update));</p>
<p>that particular example is from the MS5611 barometer driver. The AP_HAL_MEMBERPROC() macro provides a way to encapsulate a C++ member function as a callback argument (bundling up the object context with the function pointer).</p>
<p>When a piece of code wants something to happen at less than 1kHz then it should maintain it’s own “last_called” variable and return immediately if not enough time has passed. You can use the hal.scheduler-&gt;millis() and hal.scheduler-&gt;micros() functions to get the time since boot in milliseconds and microseconds to support this.</p>
<p>You should now go and modify an existing example sketch (or create a new one) and add a timer callback. Make the timer increment a counter then print the value of the counter every second in the loop() function. Modify your function so that it increments the counter every 25 milliseconds.</p>
<h3 id="HAL-specific-threads"><a href="#HAL-specific-threads" class="headerlink" title="HAL specific threads"></a>HAL specific threads</h3><p>On platforms that support real threads the AP_HAL for that platform will create a number of threads to support basic operations. For example, on Pixhawk the following HAL specific threads are created:</p>
<ul>
<li>The UART thread, for reading and writing UARTs (and USB)</li>
<li>The timer thread, which supports the 1kHz timer functionality described above</li>
<li>The IO thread, which supports writing to the microSD card, EEPROM and FRAM</li>
</ul>
<p>Have a look in Scheduler.cpp inside each AP_HAL implementation to see what threads are created and what the realtime priority of each thread is.</p>
<p>If you have a Pixhawk then you should also now setup a debug console cable and attach to the nsh console (the serial5 port). Connect at 57600. When you have connected, try the “ps” command ad you will get something like this:</p>
<p>PID PRI SCHD TYPE NP STATE NAME </p>
<p> 0 0 FIFO TASK READY Idle Task() </p>
<p> 1 192 FIFO KTHREAD WAITSIG hpwork()</p>
<p> 2 50 FIFO KTHREAD WAITSIG lpwork()</p>
<p> 3 100 FIFO TASK RUNNING init()</p>
<p> 37 180 FIFO TASK WAITSEM AHRS_Test()</p>
<p> 38 181 FIFO PTHREAD WAITSEM <pthread\>(20005400)</p>
<p> 39 60 FIFO PTHREAD READY <pthread\>(20005400)</p>
<p> 40 59 FIFO PTHREAD WAITSEM <pthread\>(20005400)</p>
<p> 10 240 FIFO TASK WAITSEM px4io()</p>
<p> 13 100 FIFO TASK WAITSEM fmuservo()</p>
<p> 30 240 FIFO TASK WAITSEM uavcan()</p>
<p>In this example you can see the “AHRS_Test” thread, which is running the example sketch from libraries/AP_AHRS/examples/AHRS_Test. You can also see the timer thread (priority 181), the UART thread (priority 60) and the IO thread (priority 59).</p>
<p>Additionally you can see the px4io, fmuservo, uavcan, lpwork, hpwork and idle tasks. More about those later.</p>
<p>Other AP_HAL ports have more or less threads depending on what is needed.</p>
<p>One common use of threads is to provide drivers a way to schedule slow tasks without interrupting the main autopilot flight code. For example, the AP_Terrain library needs to be able to do file IO to the microSD card (to store and retrieve terrain data). The way it does this is it calls the function hal.scheduler-&gt;register_io_process() like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hal.scheduler\-&gt;register\_io\_process(AP\_HAL\_MEMBERPROC(&amp;AP\_Terrain::io\_timer));</span><br></pre></td></tr></table></figure><br>The sets up the AP_Terrain::io_timer function to be called regularly. That is called within the boards IO thread, meaning it is a low realtime priority and is suitable for storage IO tasks. It is important that slow IO tasks like this not be called on the timer thread as they would cause delays in the more important processing of high speed sensor data.</p>
<h3 id="Driver-specific-threads"><a href="#Driver-specific-threads" class="headerlink" title="Driver specific threads"></a>Driver specific threads</h3><p>It is also possible to create driver specific threads, to support asynchronous processing in a manner specific to one driver. Currently you can only create driver specific threads in a manner that is platform dependent, so this is only appropriate if your driver is intended to run only on one type of autopilot board. If you want it to run on multiple AP_HAL targets then you have two choices:</p>
<ul>
<li>you can use the register_io_process() and register_timer_process() scheduler calls to use the existing timer or IO threads</li>
<li>you can add a new HAL interface that provides a generic way to create threads on multiple AP_HAL targets (please contribute patches back)</li>
</ul>
<p>An example of a driver specific thread is the ToneAlarm thread in the Linux port. See AP_HAL_Linux/ToneAlarmDriver.cpp</p>
<h3 id="ArduPilot-drivers-versus-platform-drivers"><a href="#ArduPilot-drivers-versus-platform-drivers" class="headerlink" title="ArduPilot drivers versus platform drivers"></a>ArduPilot drivers versus platform drivers</h3><p>You may notice some driver duplication in ArduPilot. For example, we have a MPU6000 driver in libraries/AP_InertalSensor/AP_InertialSensor_MPU6000.cpp, and another MPU6000 driver in PX4Firmware/src/drivers/mpu6000.</p>
<p>The reason for this duplication is that the PX4 project already provides a set of well tested drivers for hardware that comes with Pixhawk boards, and we enjoy a good collaborative relationship with the PX4 team on developing and enhancing these drivers. So when we build ArduPilot for PX4 we take advantage of the PX4 drivers by writing small “shim” drivers which present the PX4 drivers with the standard ArduPilot library interface. If you look at libraries/AP_InertialSensor/AP_InertialSensor_PX4.cpp you will see a small shim driver that asks the PX4 what IMU drivers are available on this board and automatically makes all of them available as part of the ArduPilot AP_InertialSensor library.</p>
<p>So if we have an MPU6000 on the board we use the AP_InertialSensor_MPU6000.cpp driver on non-Pixhawk/NuttX platforms, and the AP_InertialSensor_PX4.cpp driver on NuttX based platforms.</p>
<p>The same type of split can also happen for other AP_HAL ports. For example, we could use Linux kernel drivers for some sensors on Linux boards. For other sensors we use the generic AP_HAL I2C and SPI interfaces to use the ArduPilot “in-tree” drivers which work across a wide range of boards.</p>
<h3 id="Platform-specific-threads-and-tasks"><a href="#Platform-specific-threads-and-tasks" class="headerlink" title="Platform specific threads and tasks"></a>Platform specific threads and tasks</h3><p>On some platforms there will be a number of base tasks and threads that will be created by the startup process. These are very platform specific so for the sake of this tutorial I will concentrate on the tasks used on PX4 based boards.</p>
<p>In the “ps” output above we saw a number of tasks and threads that were not started by the AP_HAL_PX4 Scheduler code. Specifically they are:</p>
<ul>
<li>idle task - called when there is nothing else to run</li>
<li>init - used to start up the system</li>
<li>px4io - handle the communication with the PX4IO co-processor</li>
<li>hpwork - handle thread based PX4 drivers (mainly I2C drivers)</li>
<li>lpwork - handle thread based low priority work (eg. IO)</li>
<li>fmuservo - handle talking to the auxillary PWM outputs on the FMU</li>
<li>uavcan - handle the uavcan CANBUS protocol</li>
</ul>
<p>The startup of all of these tasks is controled by the PX4 specific <a href="https://github.com/ArduPilot/ardupilot/blob/master/mk/PX4/ROMFS/init.d/rc.APM" target="_blank" rel="noopener">rc.APM script</a>. That script is run when the PX4 boots, and is responsible for detecting what sort of PX4 board we are using then loading the right tasks and drivers for that board. It is a “nsh” script, which is similar to a bourne shell script (though nsh is much more primitive).</p>
<p>As an exercise, try editing the rc.APM script and adding some sleep and echo commands. Then upload a new firmware and connect to the debug console while the board is booting. Your echo commands should show up on the console.</p>
<p>Another very useful way of exploring the startup of the PX4 is to boot without a microSD card in the slot. The <a href="https://github.com/ArduPilot/ardupilot/blob/master/mk/PX4/ROMFS/init.d/rcS" target="_blank" rel="noopener">rcS script</a>, which runs just before rc.APM, detects if a microSD is inserted and gives you a bare nsh console on the USB port if it isn’t. You can then manually run all the steps of rc.APM yourself on the USB console to learn how it works.</p>
<p>Try the following exercise after booting a Pixhawk without a microSD card and connecting to the USB console:</p>
<p>tone_alarm stop</p>
<p>uorb start</p>
<p>mpu6000 start</p>
<p>mpu6000 info</p>
<p>mpu6000 test</p>
<p>mount -t binfs /dev/null /bin</p>
<p>ls /bin</p>
<p>perf</p>
<p>Try playing with the other drivers. Have a look in /bin to see what is available. The source code for most of these commands is in <a href="https://github.com/ArduPilot/PX4Firmware/tree/master/src/drivers" target="_blank" rel="noopener">PX4Firmware/src/drivers</a>. Have a look through the mpu6000 driver to get an idea of what is involved.</p>
<p>Given we are on the topic of threads and tasks, a brief description of threads in the PX4Firmware git tree is worth mentioning. If you look in the mpu6000 driver you will see a line like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hal.scheduler-&gt;register_timer_process(AP_HAL_MEMBERPROC(&amp;AP_Baro_MS5611::_update));</span><br></pre></td></tr></table></figure><br>that is the equivalent of the hal.scheduler-&gt;register_timer_process() function in the AP_HAL, but is PX4 specific and is also much more flexible. It says that it wants the HRT (high resolution timer) subsystem of the PX4 to call the MPU6000::measure_trampoline function every 1000 microseconds.</p>
<p>Using hrt_call_every() is the common method used for regular events in drivers where the operations are very fast, such as SPI device drivers. The operations are typically run with interrupts disabled, and should take only a few tens of microseconds at most.</p>
<p>If you compare this to the hmc5883 driver, you will instead see a line like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hal.scheduler-&gt;register_io_process(AP_HAL_MEMBERPROC(&amp;AP_Terrain::io_timer));</span><br></pre></td></tr></table></figure><br>that uses an alternative mechanism for regular events which is suitable for slower devices, such as I2C devices. What this does is add the cycle_trampoline function to a work queue within the hpwork thread that you saw above. Calls made within HPWORK workers should run with interrupts enabled and may take up to a few hundred microseconds. For tasks which will take longer than that the LPWORK work queue should be used, which runs them in the lower priority lpwork thread.</p>
<h3 id="The-AP-Scheduler-system"><a href="#The-AP-Scheduler-system" class="headerlink" title="The AP_Scheduler system"></a>The AP_Scheduler system</h3><p>The next aspect of ArduPilot threading and tasks to understand is the AP_Scheduler system. The AP_Scheduler library is used to divide up time within the main vehicle thread, while providing some simple mechanisms to control how much time is used for each operation (called a ‘task’ in AP_Scheduler).</p>
<p>The way it works is that the loop() function for each vehicle implementation contains some code that does this:</p>
<ul>
<li>wait for a new IMU sample to arrive</li>
<li>call a set of tasks between each IMU sample</li>
</ul>
<p>It is a table driven scheduler, and each vehicle type has a AP_Scheduler::Task table. To learn how it works have a look at the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Scheduler/examples/Scheduler_test/Scheduler_test.cpp" target="_blank" rel="noopener">AP_Scheduler/examples/Scheduler_test.cpp</a> sketch.</p>
<p>If you look inside that file you will see a small table with a set of 3 scheduling tasks. Associated with each task are two numbers. The table looks like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sstatic const AP_Scheduler::Task scheduler_tasks[] PROGMEM &#x3D; &#123;</span><br><span class="line"> &#123; ins_update, 1, 1000 &#125;,</span><br><span class="line"> &#123; one_hz_print, 50, 1000 &#125;,</span><br><span class="line"> &#123; five_second_call, 250, 1800 &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>The first number after each function name is the call frequency, in units controlled by the ins.init() call. For this example sketch the ins.init() uses RATE_50HZ, so each scheduling step is 20ms. That means the ins_update() call is made every 20ms, the one_hz_print() function is called every 50 times (ie. once a second) and the five_second_call() is called every 250 times (ie. once every 5 seconds).</p>
<p>The third number is the maximum time that the function is expected to take. This is used to avoid making the call unless there is enough time left in this scheduling run to run the function. When scheduler.run() is called it is passed the amount of time (in microseconds) available for running tasks, and if the worst case time for this task would mean it wouldn’t fit before that time runs out then it won’t be called.</p>
<p>Another point to look at closely is the ins.wait_for_sample() call. That is the “metronome” that drives the scheduling in ArduPilot. It blocks execution of the main vehicle thread until a new IMU sample is available. The time between IMU samples is controlled by the arguments to the ins.init() call.</p>
<p>Note that tasks in AP_Scheduler tables must have the following attributes:</p>
<ul>
<li>they should never block (except for the ins.update() call)</li>
<li>they should never call sleep functions when flying (an autopilot, like a real pilot, should never sleep while flying)</li>
<li>they should have predictable worst case timing</li>
</ul>
<p>You should now go and modify the Scheduler_test example and add in your own tasks to run. Try adding tasks that do the following:</p>
<ul>
<li>read the barometer</li>
<li>read the compass</li>
<li>read the GPS</li>
<li>update the AHRS and print the roll/pitch</li>
</ul>
<p>Look at the example sketches for each library that you worked with earlier in this tutorial to understand how to use each sensor library.</p>
<h3 id="Semaphores"><a href="#Semaphores" class="headerlink" title="Semaphores"></a>Semaphores</h3><p>When you have multiple threads (or timer callbacks) you need to ensure that data structures shared by the two logical threads of execution are updated in a way that prevents corruption. There are 3 principle ways of doing this in ArduPilot - semaphores, lockless data structures and the PX4 ORB.</p>
<p>AP_HAL Semaphores are just wrappers around whatever semaphore system is available on the specific platform, and provide a simple mechanism for mutual exclusion. For example, I2C drivers can ask for the I2C bus semaphore to ensure that only one I2C device is used at a time.</p>
<p>Go and have a look at the hmc5843 driver in libraries/AP_Compass/AP_Compass_HMC5843.cpp and look for the get_semaphore() call. Look at all the places it is used, and see if you can work out why it is needed.</p>
<h3 id="Lockless-Data-Structures"><a href="#Lockless-Data-Structures" class="headerlink" title="Lockless Data Structures"></a>Lockless Data Structures</h3><p>The ArduPilot code also contains examples of using lockless data structures to avoid the need for a semaphore. This can be a lot more efficient than semaphores.</p>
<p>Two examples of lockless data structures in ArduPilot are:</p>
<ul>
<li>the _shared_data structure in libraries/AP_InertialSensor/AP_InertialSensor_MPU9250.cpp</li>
<li>the ring buffers used in numerous places. A good example is libraries/DataFlash/DataFlash_File.cpp</li>
</ul>
<p>Go and have a look at these two examples, and prove to yourself that they are safe for concurrent access. For DataFlash_File look at the use of the _writebuf_head and _writebuf_tail variables.</p>
<p>It would be nice to create a generic ring buffer class which could be used instead of the separate ringbuffer implementations in several places in ArduPilot. If you want to contribute that then please do a pull request!</p>
<h3 id="The-PX4-ORB"><a href="#The-PX4-ORB" class="headerlink" title="The PX4 ORB"></a>The PX4 ORB</h3><p>Another example of this type of mechanism is the PX4 ORB. The ORB (Object Request Broker) is a way of providing data from one part of the system to another (eg. device driver -&gt; vehicle code) using a publish/subscribe model that is safe in a multi-threaded environment.</p>
<p>The ORB provides a nice mechanism for declaring structures which will be shared in this way (all defined in <a href="https://github.com/ArduPilot/PX4Firmware/tree/master/src/modules/uORB" target="_blank" rel="noopener">PX4Firmware/src/modules/uORB/</a>). Code can then “publish” data to one of these topics, which is picked up by other pieces of code.</p>
<p>An example is the publication of actuator values so the uavcan ESCs can be used on Pixhawk. Have a look at the _publish_actuators() function in AP_HAL_PX4/RCOutput.cpp. You will see that it advertises a “actuator_direct” topic, which contains the speed desired for each ESC. The uavcan code these watches for changes to this topic in <a href="https://github.com/ArduPilot/PX4Firmware/blob/master/src/modules/uavcan/uavcan_main.cpp" target="_blank" rel="noopener">PX4Firmware/src/modules/uavcan/uavcan_main.cpp</a>and outputs the new values to the uavcan ESCs.</p>
<p>Two other common mechanisms for communicating with PX4 drivers are:</p>
<ul>
<li>ioctl calls (see the examples in AP_HAL_PX4/RCOutput.cpp)</li>
<li>/dev/xxx read/write calls (see _timer_tick in AP_HAL_PX4/RCOutput.cpp)</li>
</ul>
<p>Please talk to the ardupilot development team on the <a href="https://gitter.im/ArduPilot/GeneralChat" target="_blank" rel="noopener">ArduPilot Gitter General Chat</a> if you are not sure which mechanism to use for new code.</p>
<h1 id="六：UARTs-and-the-Console"><a href="#六：UARTs-and-the-Console" class="headerlink" title="六：UARTs and the Console"></a>六：UARTs and the Console</h1><p>A lot of components in ArduPilot rely on UARTs. They are used for debug output, telemetry, GPS modules and more. Understanding how to talk to the UARTs via the HAL will help you understand a lot of ArduPilot code.</p>
<h2 id="The-8-UARTs"><a href="#The-8-UARTs" class="headerlink" title="The 8 UARTs"></a>The 8 UARTs</h2><p>The ArduPilot HAL currently defines 8 UARTs. The HAL itself doesn’t define any particular roles for these UARTs, but the other parts of ArduPilot assume they will be assigned particular functions</p>
<ul>
<li>uartA - the console (usually USB, runs MAVLink telemetry)</li>
<li>uartB - the first GPS</li>
<li>uartC - primary telemetry (telem1 on Pixhawk, 2nd radio on APM2)</li>
<li>uartD - secondary telemetry (telem2 on Pixhawk)</li>
<li>uartE - 2nd GPS</li>
<li>uartF - User Configurable</li>
<li>uartG - User Configurable</li>
<li>uartH - User Configurable</li>
</ul>
<p>If you are writing your own sketch using the ArduPilot HAL then you can use these UARTs for any purpose you like, but if possible you should try to use the above assignments as it will allow you to fit in more easily to existing code.</p>
<p>You can change the role of UART by changing its SERIALn_PROTOCOL param. Possible parameter values are -1:None, 1:MAVLink1, 2:MAVLink2, 3:Frsky D, 4:Frsky SPort, 5:GPS, 7:Alexmos Gimbal Serial, 8:SToRM32 Gimbal Serial, 9:Rangefinder, 10:FrSky SPort Passthrough (OpenTX), 11:Lidar360, 13:Beacon, 14:Volz servo out, 15:SBus servo out, 16:ESC Telemetry, 17:Devo Telemetry, 18:OpticalFlow, 19:RobotisServo, 20:NMEA Output, 21:WindVane, 22:SLCAN Search code for 1_PROTOCOL to get updated list of uart roles.</p>
<p>Go and have a look at the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_HAL/examples/UART_test/UART_test.cpp" target="_blank" rel="noopener">libraries/AP_HAL/examples/UART_test</a> example sketch. It prints a hello message to the 1st 5 UARTs. Try it on your board and see if you can get all the outputs displaying using a USB serial adapter. Try changing the baudrate in the sketch.</p>
<h3 id="Debug-console"><a href="#Debug-console" class="headerlink" title="Debug console"></a>Debug console</h3><p>Historically, In addition to the basic 5 UARTs there was an additional debug console available on some platforms. Recently debug console is directed to USB. On SITL debug is directed to terminal running SITL, while USB is directed to port 5760 by default.</p>
<p>If you have a board that does have HAL_OS_POSIX_IO set (check that in <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_HAL/AP_HAL_Boards.h" target="_blank" rel="noopener">AP_HAL/AP_HAL_Boards.h</a>) then try adding some ::printf() and other stdio functions to the UART_test sketch.</p>
<p>If ::printf doesn’t work for you, it may be that your particular file ( eg a library ) does not have “#include <stdio.h>” at the top of it, just add it. :-)</p>
<p>You can also use hal.console-&gt;printf() to specify USB port.</p>
<h2 id="UART-Functions"><a href="#UART-Functions" class="headerlink" title="UART Functions"></a>UART Functions</h2><p>Every UART has a number of basic IO functions available. The key functions are:</p>
<ul>
<li>printf - formatted print</li>
<li>printf_P - formatted print with progmem string (saves memory on AVR boards)</li>
<li>println - print and line feed</li>
<li>write - write a bunch of bytes</li>
<li>read - read some bytes</li>
<li>available - check if any bytes are waiting</li>
<li>txspace - check how much outgoing buffer space is available</li>
<li>get_flow_control - check if the UART has flow control capabilities</li>
</ul>
<p>Go and have a look at the declarations of each of these in AP_HAL and try them in UART_test.</p>
<h1 id="七：RC-Input-and-Output"><a href="#七：RC-Input-and-Output" class="headerlink" title="七：RC Input and Output"></a>七：RC Input and Output</h1><p>RC input is a key part of any autopilot, giving the pilot control of the airframe, allowing them to change modes and also giving them control of auxiliary equipment such as camera mounts.</p>
<p>ArduPilot supports several different types of RC Input depending on the board type:</p>
<ul>
<li>PPMSum - on PX4, Pixhawk, Linux and APM2</li>
<li>SBUS - on PX4, Pixhawk and Linux</li>
<li>Spektrum/DSM - on PX4, Pixhawk and Linux</li>
<li>PWM - on APM1 and APM2</li>
<li>RC Override (MAVLink) - all boards</li>
</ul>
<p>The number of channels available depends on the hardware of the particular board. Note that SBUS and Spektrum/DSM are serial protocols. SBUS is a 100kbaud inverted UART protocol and Spektrum/DSM is a 115200 baud UART protocol. Some boards implement these using hardware UARTs (such as on PX4) and some implement them as bit-banged software UARTs (on Linux).</p>
<p>RC Output is how ArduPilot controls servos and motors. The number of available output channels depends on the type of board, and can even depend on the vehicle type and configuration parameters. RC Output defaults to 50Hz PWM values, but can be configured for a wide range of update rates. For example, the Copter code sets up its motor outputs to drive the ESCs at a much higher rate - typically over 400Hz.</p>
<h2 id="AP-HAL-RCInput-object"><a href="#AP-HAL-RCInput-object" class="headerlink" title="AP_HAL RCInput object"></a>AP_HAL RCInput object</h2><p>The first object to understand is the AP_HAL RCInput object which is available as hal.rcin. That provides low level access to the channel values currently being received on the board. The returned values are PWM values in microseconds.</p>
<p>Go and have a look at the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_HAL/examples/RCInput/RCInput.cpp" target="_blank" rel="noopener">libraries/AP_HAL/examples/RCInput/RCInput.cpp</a> sketch and try it on your board. Try moving the sticks on your transmitter and check that the values change correctly in the output.</p>
<h2 id="AP-HAL-RCOutput-object"><a href="#AP-HAL-RCOutput-object" class="headerlink" title="AP_HAL RCOutput object"></a>AP_HAL RCOutput object</h2><p>The AP_HAL RCOutput object (available as hal.rcout) gives low level control of all output channels. How this is implemented is very board specific, and may involve programming of on-chip timers, or an I2C peripheral, or output via a co-processor (such as the PX4IO microcontroller).</p>
<p>Go and have a look at the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_HAL/examples/RCOutput/RCOutput.cpp" target="_blank" rel="noopener">libraries/AP_HAL/examples/RCOutput/RCOutput.cpp</a> example sketch. You’ll see that it just sets up all the channels to wave the servos from minimum to maximum over a few second period. Hook up some servos to your board and then test to make sure it works for you.</p>
<h2 id="The-RC-Channel-object"><a href="#The-RC-Channel-object" class="headerlink" title="The RC_Channel object"></a>The RC_Channel object</h2><p>The hal.rcin and hal.rcout objects discussed above are low level functions. The usual way of handling RC input and output in ArduPilot is via a higher level object called RC_Channel. That object has user configurable parameters for the min/max/trim of each channel, as well as support for auxillary channel function, scaling of inputs and outputs and many other features.</p>
<p>Go and have a look at <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/RC_Channel/examples/RC_Channel/RC_Channel.cpp" target="_blank" rel="noopener">libraries/RC_Channel/examples/RC_Channel/RC_Channel.cpp</a>. That example shows how to setup RC channels, read input and copy input to output values. Run that on your board and check that transmitter input is passed through to a servo. Try changing it to reverse a channel, and change the min/max/trim on a channel. Have a look through RC_Channel.h to see what API functions are available.</p>
<h3 id="The-strange-input-output-setup-in-RC-Channel"><a href="#The-strange-input-output-setup-in-RC-Channel" class="headerlink" title="The strange input/output setup in RC_Channel"></a>The strange input/output setup in RC_Channel</h3><p>If you look at RC_Channel carefully you’ll notice something strange. A lot of variables apply to both the input side and the output side. For example, the rc1-&gt;radio_trim applies to channel 1 as an input (specifying the trim point for calculation a input proportion), plus as an output, specifying the midpoint of a servo attached to that channel.</p>
<p>This ties input channels numbers to output channel numbers, when really they are separate concepts. You may want to use channel 1 input as “roll input”, but use channel 1 output for steering a nose wheel on an aircraft. With RC_Channel you can’t really do that, or at least if you do it you will end up with some very odd code. This is an artifact of how RC_Channel was originally developed, where pass-thru from input channels to output channels on a fixed wing aircraft in manual mode was normal. Someday we may change it to break apart the two concepts in a more logical fashion, but for now just be aware that it is strange, so when you see odd bits of code working around this you’ll know why.</p>
<h2 id="The-RC-Channel-aux-object"><a href="#The-RC-Channel-aux-object" class="headerlink" title="The RC_Channel_aux object"></a>The RC_Channel_aux object</h2><p>Along with RC_Channel there is another important class in libraries/RC_Channel. It is the RC_Channel_aux class, which is a subclass of RC_Channel.</p>
<p>An RC_Channel_aux object is a type of RC_Channel but with additional properties that allow its purpose to be specified by a user. Say for example a user wants channel 6 to be a roll stabilization for a camera mount. They would set a parameter RC6_FUNCTION to be 21, which means “rudder”. Then another library could say:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RC_Channel_aux::set_servo_out(RC_Channel_aux::k_rudder, 4500);</span><br></pre></td></tr></table></figure><br>and any channel which has its FUNCTION set to 21 will move to full deflection (as k_rudder is setup scaled as an angle in centi-degrees with 4500 being the maximum). Note that this is a one to many arrangement. The user can setup multiple channels to have FUNCTION 21 if they want to, and all of those channels will move, each using their own min/max/trim values.</p>
<h1 id="八：Storage-and-EEPROM-management"><a href="#八：Storage-and-EEPROM-management" class="headerlink" title="八：Storage and EEPROM management"></a>八：Storage and EEPROM management</h1><p>Every board that ArduPilot supports has some form of persistent storage available. This is used to hold user parameters, waypoints, rally points, terrain data and many other useful things. To provide access to this storage ArduPilot has 4 basic mechanisms:</p>
<ul>
<li>the AP_HAL::Storage object, accessed as hal.storage</li>
<li>the StorageManager library to give a higher level abstraction layer on hal.storage</li>
<li>DataFlash for storing to an on-board logging area</li>
<li>Posix IO functions to traditional filesystems (for example VFAT on a microSD card), on boards that support it</li>
</ul>
<p>The other libraries and functions that need persistent storage are built on these basic systems. For example, the AP_Param library (which handles user settable parameters) is built on top of StorageManager, which in turn is built on top of AP_HAL::Storage. The AP_Terrain library (which handles terrain data) is built on top of Posix IO functions for holding the terrain database.</p>
<h2 id="The-AP-HAL-Storage-library"><a href="#The-AP-HAL-Storage-library" class="headerlink" title="The AP_HAL::Storage library"></a>The AP_HAL::Storage library</h2><p>The AP_HAL::Storage object is available on all platforms. The minimum size of storage available via this interface on boards that ArduPilot supports is 4096 bytes. Some boards provide more space - for example the PX4v1 has 8k of EEPROM and the Pixhawk has 16k of FRAM. All of that is hidden behind the AP_HAL::Storage API.</p>
<p>The hal.storage API is extremely simple. It has just 3 functions</p>
<ul>
<li>init() to start up the storage subsystem</li>
<li>read_block() to read a block of bytes</li>
<li>write_block() to write a block of bytes</li>
</ul>
<p>The reason for this very simple API is that developers are encouraged to use the StorageManager API instead of hal.storage. You should only be delving into hal.storage when doing bringup of a new board, or when debugging.</p>
<p>The size of storage available is set inside <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_HAL/AP_HAL_Boards.h" target="_blank" rel="noopener">AP_HAL/AP_HAL_Boards.h</a> in the macro HAL_STORAGE_SIZE. This means we don’t yet support dynamically determining the size of storage available for this interface. If you want dynamically sized storage you need to use Posix IO for now.</p>
<p>We don’t have an example sketch for the AP_HAL::Storage API, so this is your chance to write one. If you have gotten this far into the ArduPilot tutorial you should have seen enough example sketches to know how to write one from scratch. So write a libraries/AP_HAL/examples/Storage example that calculates an 8 bit XOR of the full contents of the hal.storage data, and prints it to the console. Then <a href="submitting-patches-back-to-master.html#submitting-patches-back-to-master">submit the example as a patch</a> to the ArduPilot github, being careful to follow the patch submission guidelines.</p>
<p>I will be quite interested to see how long after I add this exercise to the tutorial before we get a submission ….</p>
<h2 id="The-StorageManager-library"><a href="#The-StorageManager-library" class="headerlink" title="The StorageManager library"></a>The StorageManager library</h2><p>The simple hal.storage API makes it nice and easy to port ArduPilot to a new board, but isn’t convenient for actually using the available storage. For that we have StorageManager. The StorageManager library provides an API which abstracts the storage into pseudo-contiguous blocks of data that have an assigned purpose. So we chop up the available storage into areas that provide:</p>
<ul>
<li>parameters</li>
<li>fence points</li>
<li>waypoints</li>
<li>rally points</li>
<li>signing key</li>
<li>RC bind info</li>
</ul>
<p>Go and have a read of <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/StorageManager/StorageManager.cpp" target="_blank" rel="noopener">libraries/StorageManager/StorageManager.cpp</a>. In particular look at the tables at the top. Notice how multiple areas of each type are defined for systems with have larger amounts of storage. This ability to combine multiple non-contiguous areas of storage into a single logical storage area was the main motivation for adding StorageManager. It allowed us to grow from using 4k of storage on all boards to using the full storage available on each board without asking users to reload all their parameters or reload their waypoints.</p>
<p>This theme of trying to avoid making users reconfigure their autopilot boards is a common one in ArduPilot. We like it when users can update to the latest firmware and everything they previously setup still works, while gaining new features. Sometimes that means we have to do a bit more work as developers to make that possible - such as happened with StorageManager.</p>
<p>The StorageManager API also provides convenient functions for reading and writing variables like integers. This is the API that libraries like AP_Mission use to save and restore waypoints.</p>
<p>Now go and have a look at <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/StorageManager/examples/StorageTest/StorageTest.cpp" target="_blank" rel="noopener">libraries/StorageManager/examples/StorageTest.cpp</a>. This is a stress test for the StoageManager layer, and as a result is also a stress test for the AP_HAL::Storage object. It does random IO at random offsets of random lengths. That means it does IOs that cross boundaries where a single parameter value may be non-contiguous in FRAM or EEPROM. This test sketch was designed to stress test the StorageManager API, but it is also terribly useful when porting ArduPilot to a new board, as it stresses the EEPROM access functions very nicely.</p>
<p>Go and try StorageTest on your board, but be warned that it is a destructive test. It won’t destroy your board, but it will wipe all your parameters and waypoints. So backup your configuration if you are testing on the board in your favourite aircraft.</p>
<p>As an exercise, add some profiling to StorageTest so it prints the total IO rate in kbytes/sec along with the IO rate for reads and writes. Do you notice something about the difference between the read and write rates? Do you notice anything about the speed of writing values which are already set at that address in storage? See if you can find the code in StorageManager that explains your observations. Then <a href="submitting-patches-back-to-master.html#submitting-patches-back-to-master">submit a patch</a> adding the profiling output to the ArduPilot github.</p>
<p>Next go and search through the ArduPilot libraries to fine all the places that use the StorageManager. What you are looking for is StorageAccess handles, like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StorageAccess AP_Param::_storage(StorageManager::StorageParam);</span><br></pre></td></tr></table></figure><br>that declares a variable called AP_Param::_storage which provides access to the StorageParam area of the storage on this board. What libraries use StorageAccess?</p>
<h2 id="The-DataFlash-library"><a href="#The-DataFlash-library" class="headerlink" title="The DataFlash library"></a>The DataFlash library</h2><p>Another type of storage that autopilots need is for on-board logs. For ArduPilot that is provided by the DataFlash library. It is quite an odd library in many ways. For a start the name is weird and comes from the fact that it was originally designed around the DataFlash chip for the APM1. It was a hardware device driver library which morphed over time into a general logging system. Internally the structure of the library shows this history in several ways (and not good ways!).</p>
<p>These days the DataFlash API is designed around a logging infrastructure model. It allows you to define self-describing data structures for individual log messages - such as a “GPS” message to log data from a GPS sensor. It handles logging that data to persistent storage in an efficient manner and also provides APIs for other libraries to use to get the data back out when the user wants to download their log files after a flight.</p>
<p>If you have seen the ‘*.bin’ files that ArduPilot uses these days when you download a log then you have seen the format that ArduPilot uses to store log messages. It is “self describing”, meaning that the ground station can work out the format of the messages in the log file without having to have some common scheme. At the front of each log file is a set of FMT messages which have a well known format and which describe the format of the messages that follow.</p>
<p>Go and have a look at <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/DataFlash/examples/DataFlash_test/DataFlash_test.cpp" target="_blank" rel="noopener">libraries/DataFlash/examples/DataFlash_test/DataFlash_test.cpp</a>. You’ll see a little table at the top that defines the log messages we will be writing, in this case a ‘TEST’ message which contains 4 unsigned 16 bit integers and two signed 32 bit integers (that is what “HHHHii” means). It also gives names for those 6 variables (cunningly labelled V1 to V4 and L1 and L2).</p>
<p>In the loop() function you will see a rather strange call like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataFlash.get_log_boundaries(log_num, start, end);</span><br></pre></td></tr></table></figure><br>This is the public API for the way that the DataFlash library hides how the board actually stores log files. On a system that has Posix IO (such as Pixhawk or Linux) log files are stored as separate files in a “LOGS” directory on the microSD card. These files can be directly copied by a user by pulling out the microSD card and putting it into their PC.</p>
<p>On a board like the APM2 things aren’t quite that simple. The APM2 has 4 megabytes of storage on a DataFlash chip, accessible across an SPI interface. The interface itself is page oriented, so you need to fill one 512 byte (or possibly 528 byte!) page, then tell the chip to copy that page to persistent storage while you fill the next page. Doing random IO on this DataFlash is not good - it is designed for use by code that needs to write continuously, which is what happens when logging. The 4 megabyte size is really not very large compared to the amount of data an autopilot likes to log, so we need to handle wrapping when it fills up as well.</p>
<p>All of that complexity is hidden behind an API that presents the concept of a “log number”, which is just a bunch of bytes that were written in one flight of the autopilot. The DataFlash implementation on APM1 and APM2 uses little marker bytes at the front of each page to say which log number is being written. These log numbers correspond to the log numbers that are downloaded when the user asks to retrieve their logs.</p>
<h2 id="Posix-IO"><a href="#Posix-IO" class="headerlink" title="Posix IO"></a>Posix IO</h2><p>Some of the autopilot boards that ArduPilot supports are based on an operating system that has a Posix-like API. For example the Linux ports have a very good Posix subsystems, and the NuttX operating system used for PX4 (such as on Pixhawk) have a pretty reasonable Posix layer. You can take advantage of this in libraries for ArduPilot as long as you don’t rely on it for anything that has to work on all boards.</p>
<p>A good example of this is the AP_Terrain library, which holds terrain data. Terrain data is much too large to fit in EEPROM, and it is random access, so it isn’t suitable for DataFlash. It is also not essential for the basic functionality of an autopilot, so it is a great candidate for implementing using Posix IO.</p>
<p>The way we use Posix IO is that you first check if the board has Posix IO support by checking the HAVE_OS_POSIX_IO macro from <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_HAL/AP_HAL_Boards.h" target="_blank" rel="noopener">AP_HAL_Boards.h</a>. Then to know where on the filesystem you should store the data you add a data specific macro in AP_HAL_Boards.h which gives the directory path where that sort of data should be placed. For example, the macro HAL_BOARD_TERRAIN_DIRECTORY is used to define the directory where terrain data should go.</p>
<p>Once you have those two things you should just use normal Posix IO functions (ie. open, close, read, write etc), although there are some caveats:</p>
<ul>
<li>you must only call IO functions from either the IO timer or from your own low priority thread.</li>
<li>Never call any IO functions from APIs directly accessible in your library. Not even a simple one like stat().</li>
<li>try to be friendly to slow storage cards, do IO in reasonably sized chunks, and avoid seeks where possible</li>
</ul>
<p>These rules really matter. A simple IO on a microSD card on Pixhawk could take up to a second. That is enough time for your precious quadcopter to be flying upside down and heading for its final meeting with the ground. The average time for an IO on a Pixhawk microSD card is quite low (a few milliseconds), but just occasionally you will get a slow one when the microSD card decides it need to spend some quality time re-reading the SD card specification and calculating Pi. Don’t be tempted to sneak a little operation in just because it seems fast most of the time.</p>
<p>The one exception to this is initialization functions that you know for certain can only be called when the vehicle is starting up or is disarmed. A bit of delay at that time is fine.</p>
<p>Now go and have a read of <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Terrain/TerrainIO.cpp" target="_blank" rel="noopener">libraries/AP_Terrain/TerrainIO.cpp</a> and look at how it uses Posix IO. Notice the little state machine it uses to handle all the IO, which is all called from the <code>AP_Terrain::io_timer</code> function. See if you can spot any bugs, and report them if you can!</p>
<h1 id="九：Code-Overview-Copter"><a href="#九：Code-Overview-Copter" class="headerlink" title="九：Code Overview (Copter)"></a>九：Code Overview (Copter)</h1><p>The <a href="https://github.com/ArduPilot/ardupilot" target="_blank" rel="noopener">code</a> is made up of <a href="https://github.com/ArduPilot/ardupilot/tree/master/ArduCopter" target="_blank" rel="noopener">the main Copter code</a> which resides in it’s own directory, and <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries" target="_blank" rel="noopener">the libraries</a> which are shared with Plane and Rover.</p>
<p>Below is a highlevel view of the ardupilot architecture.</p>
<p><img src="https://ardupilot.org/dev/_images/ArduPilot_HighLevelArchecture.png" alt=""></p>
<p>Below is a more zoomed in view (as compared to the above diagram) of the architecture.</p>
<p><img src="https://ardupilot.org/dev/_images/copter-architecture.png" alt=""></p>
<p>The image below shows the architecture of <strong>manual modes</strong> (i.e. Stabilize, Acro, Drift)</p>
<p><img src="https://ardupilot.org/dev/_images/AC_CodeOverview_ManualFlightMode.png" alt=""></p>
<p>The image below shows the architecture of <strong>autonomous modes</strong> (i.e. RTL, Guided, Auto)</p>
<p><img src="https://ardupilot.org/dev/_images/AC_CodeOverview_ManualFlightMode.png" alt=""></p>
<h1 id="十：Copter-Attitude-Control"><a href="#十：Copter-Attitude-Control" class="headerlink" title="十：Copter Attitude Control"></a>十：Copter Attitude Control</h1><p>Below is a high level diagram showing how the attitude control is done for each axis. The control is done using a P controller to convert the angle error (the difference between the target angle and actual angle) into a desired rotation rate followed by a PID controller to convert the rotate rate error into a high level motor command. The “square root controller” portion of the diagram shows the curved used with the angle control’s P controller.</p>
<p><img src="https://ardupilot.org/dev/_images/Copter_CodeOverview_AttitudeControlPID.png" alt=""><br><img src="https://ardupilot.org/dev/_images/Copter_CodeOverview_AttitudeControlPID.png" alt=""></p>
<p>The diagram below shows the code path followed from pilot input down to pwm output.<br><img src="https://ardupilot.org/dev/_images/AC_CodeOverview_ManualFlightMode.png" alt=""><br>On every update (i.e. 400hz on Pixhawk, 100hz on APM2.x) the following happens:</p>
<ul>
<li>the top level flight-mode.cpp’s “update_flight_mode()” function is called. This function checks the vehicle’s flight mode (ie. “control_mode” variable) and then calls the appropriate <flight mode>_run() function (i.e. <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/control_stabilize.cpp#L20" target="_blank" rel="noopener">stabilize_run</a> for stabilize mode, <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/control_rtl.cpp#L23" target="_blank" rel="noopener">rtl_run</a> for RTL mode, etc). The <flight mode>_run() function can be found in the appropriately named control_<flight mode>.cpp file (i.e. <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/control_stabilize.cpp" target="_blank" rel="noopener">control_stabilize.cpp</a>, <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/control_rtl.cpp" target="_blank" rel="noopener">control_rtl.cpp</a>, etc).</li>
<li>the <flight mode>_run function is responsible for converting the user’s input (found in g.rc_1.control_in, g.rc_2.control_in, etc) into a lean angle, rotation rate, climb rate, etc that is appropriate for this flight mode. For example <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/control_althold.cpp#L22" target="_blank" rel="noopener">AltHold</a> converts the user’s roll and pitch input into lean angles (in degrees), the yaw input is converted into a rotation rate (in degrees per second) and the throttle input is converted to a climb rate (in cm/s).</li>
<li>the last thing the <flight mode>_run function must do is pass these desired angles, rates etc into Attitude Control and/or Position Control libraries (these are both held in the <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AC_AttitudeControl" target="_blank" rel="noopener">AC_AttitudeControl</a> folder).</li>
<li>The <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_AttitudeControl.h" target="_blank" rel="noopener">AC_AttitudeControl</a> library provides 5 possible ways to control the attitude of the vehicle, the most common 3 are described below.<ul>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_AttitudeControl.h#L98" target="_blank" rel="noopener">angle_ef_roll_pitch_rate_ef_yaw()</a> : this accepts an “earth frame” angle for roll and pitch, and an “earth frame” rate for yaw. For example providing this function roll = -1000, pitch = -1500, yaw = 500 means lean the vehicle left to 10degrees, pitch forward to 15degrees and rotate right at 5deg/second.</li>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_AttitudeControl.h#L102" target="_blank" rel="noopener">angle_ef_roll_pitch_yaw()</a> : this accepts “earth frame” angles for roll, pitch and yaw. similar to above except providing yaw of 500 means rotate the vehicle to 5 degrees east of north.</li>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_AttitudeControl.h#L108" target="_blank" rel="noopener">rate_bf_roll_pitch_yaw()</a> : this accepts a “body frame” rate (in degrees/sec) for roll pitch and yaw. For example providing this function roll = -1000, pitch = -1500, yaw = 500 would lead to the vehicle rolling left at 10deg/sec, pitching forward at 15deg/sec and rotating about the vehicle’s z axis at 5 deg/sec.</li>
</ul>
</li>
</ul>
<p>After any calls to these functions are made the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_AttitudeControl.h#L114" target="_blank" rel="noopener">AC_AttitudeControl::rate_controller_run()</a> is called. This converts the output from the methods listed above into roll, pitch and yaw inputs which are sent to the <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Motors" target="_blank" rel="noopener">AP_Motors</a> library via it’s <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_Motors_Class.h#L99" target="_blank" rel="noopener">set_roll, set_pitch, set_yaw and set_throttle</a> methods.</p>
<ul>
<li>The <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_PosControl.h" target="_blank" rel="noopener">AC_PosControl</a> library allows 3D position control of the vehicle. Normally only the simpler Z-axis (i.e. altitude control) methods are used because more complicated 3D position flight modes (i.e. <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/control_loiter.cpp#L30" target="_blank" rel="noopener">Loiter</a>) make use of the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_WPNav/AC_WPNav.h" target="_blank" rel="noopener">AC_WPNav</a> library. In any case, some commonly used methods of this library include:<ul>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_PosControl.h#L109" target="_blank" rel="noopener">set_alt_target_from_climb_rate()</a> : this accepts a climb rate in cm/s and updates an absolute altitude target</li>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_PosControl.h#L171" target="_blank" rel="noopener">set_pos_target()</a> : this accepts a 3D position vector which is an offset from home in cm</li>
</ul>
</li>
</ul>
<p>If any methods in AC_PosControl are called then the flight mode code must also call the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_PosControl.h#L134" target="_blank" rel="noopener">AC_PosControl::update_z_controller()</a> method. This will run the z-axis position control PID loops and send low-level throttle level to the <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Motors" target="_blank" rel="noopener">AP_Motors</a> library. If any xy-axis methods are called then <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_PosControl.h#L202" target="_blank" rel="noopener">AC_PosControl::update_xy_controller()</a> must be called.</p>
<ul>
<li>The AP_Motors library holds the “motor mixing” code. This code is responsible for converting the roll, pitch, yaw and throttle values received from the AC_AttitudeControl and AC_PosControl libraries into absolute motor outputs (i.e. PWM values). So the higher level libs would make use of these functions:<ul>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_Motors_Class.h#L99" target="_blank" rel="noopener">set_roll(), set_pitch(), set_yaw()</a> : accepts roll, pitch and yaw values in the range of -4500 ~ 4500. These are not desired angles or even rates but rather just a value. For example set_roll(-4500) would mean roll left as fast as possible.</li>
<li>set_throttle() : accepts an absolute throttle value in the range of 0 ~ 1000. 0 = motors off, 1000 = full throttle.</li>
</ul>
</li>
<li>There are different classes for each frame type (quad, Y6, traditional helicopter) but in each there is an “<a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_MotorsMatrix.cpp#L123" target="_blank" rel="noopener">output_armed</a>” function which is responsible for implementing the conversion of these roll, pitch, yaw and throttle values into pwm outputs. This conversion often includes implementing a “stability patch” which handles prioritising one axis of control over another when the input requests are outside the physical limits of the frame (i.e. max throttle and max roll is not possible with a quad because some motors must be less than others to cause a roll). At the bottom of the “output_armed” function there is a call to the hal.rcout-&gt;write() which passes the desired pwm values to the AP_HAL layer.</li>
<li>The <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_HAL" target="_blank" rel="noopener">AP_HAL</a> libraries (hardware abstraction layer) provides a consistent interface for all boards. In particular the hal.rc_out_write() function will cause the specified PWM received from the AP_Motors class to appear on the appropriate pwm pin out for the board.</li>
</ul>
<h2 id="Leonard-Hall-Developer-Un-Conference-2018"><a href="#Leonard-Hall-Developer-Un-Conference-2018" class="headerlink" title="Leonard Hall, Developer Un-Conference 2018"></a>Leonard Hall, Developer Un-Conference 2018</h2><h1 id="十一：：Adding-a-New-Parameter-to-Copter"><a href="#十一：：Adding-a-New-Parameter-to-Copter" class="headerlink" title="十一：：Adding a New Parameter to Copter"></a>十一：：Adding a New Parameter to Copter</h1><p>Parameters can either be part of the main code or part of a library.</p>
<h2 id="Adding-a-parameter-to-the-main-code"><a href="#Adding-a-parameter-to-the-main-code" class="headerlink" title="Adding a parameter to the main code"></a>Adding a parameter to the main code</h2><p><strong>Step #1:</strong> Find a spare slot in the Parameters class’s enum in <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.h" target="_blank" rel="noopener">Parameters.h</a> and add your new parameter as shown below in red. Some things to be careful of:</p>
<ul>
<li>Try to add the parameter close to parameters that share a similar function or worst case add to the end of the “Misc” section.</li>
<li>Ensure that the section you are adding it to is not full. You can check if the section is full by counting the number of parameters in the section and ensuring that the last element is less than the next sections first element. I.e. the Misc section’s first parameter is #20. my_new_parameter is #36. If the next section began at #36 we would not be able to add the new parameter here.</li>
<li>Do not add a parameter in the middle of a group thus causing the slots for existing parameters to change</li>
<li>Do not use slots with “deprecated” or “remove” comments beside them because some users may still have the defaults for these old parameters in their eeprom so your new parameter’s default value could be set strangely.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    <span class="comment">// Misc</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    k_param_log_bitmask = <span class="number">20</span>,</span><br><span class="line">    k_param_log_last_filenumber,            <span class="comment">// *** Deprecated - remove</span></span><br><span class="line">                                            <span class="comment">// with next eeprom number</span></span><br><span class="line">                                            <span class="comment">// change</span></span><br><span class="line">    k_param_toy_yaw_rate,                           <span class="comment">// THOR The memory</span></span><br><span class="line">                                                    <span class="comment">// location for the</span></span><br><span class="line">                                                    <span class="comment">// Yaw Rate 1 = fast,</span></span><br><span class="line">                                                    <span class="comment">// 2 = med, 3 = slow</span></span><br><span class="line"></span><br><span class="line">    k_param_crosstrack_min_distance,    <span class="comment">// deprecated - remove with next eeprom number change</span></span><br><span class="line">    k_param_rssi_pin,</span><br><span class="line">    k_param_throttle_accel_enabled,     <span class="comment">// deprecated - remove</span></span><br><span class="line">    k_param_wp_yaw_behavior,</span><br><span class="line">    k_param_acro_trainer,</span><br><span class="line">    k_param_pilot_velocity_z_max,</span><br><span class="line">    k_param_circle_rate,</span><br><span class="line">    k_param_sonar_gain,</span><br><span class="line">    k_param_ch8_option,</span><br><span class="line">    k_param_arming_check_enabled,</span><br><span class="line">    k_param_sprayer,</span><br><span class="line">    k_param_angle_max,</span><br><span class="line">    k_param_gps_hdop_good,          <span class="comment">// 35</span></span><br><span class="line">    k_param_my_new_parameter,       <span class="comment">// 36</span></span><br></pre></td></tr></table></figure>
<strong>Step #2:</strong> Declare the variable within the Parameters class somewhere below the enum. Possible types include AP_Int8, AP_Int16, AP_Float, AP_Int32 and AP_Vector3 (Note: unsigned integers are not currently supported). The name of the variable should be the same as the new enum but with the “k_param_” prefix removed.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">       <span class="comment">// 254,255: reserved</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">AP_Int16        format_version;</span><br><span class="line">AP_Int8         software_type;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Telemetry control</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">AP_Int16        sysid_this_mav;</span><br><span class="line">AP_Int16        sysid_my_gcs;</span><br><span class="line">AP_Int8         serial3_baud;</span><br><span class="line">AP_Int8         telem_delay;</span><br><span class="line"></span><br><span class="line">AP_Int16        rtl_altitude;</span><br><span class="line">AP_Int8         sonar_enabled;</span><br><span class="line">AP_Int8         sonar_type;       <span class="comment">// 0 = XL, 1 = LV,</span></span><br><span class="line">                                  <span class="comment">// 2 = XLL (XL with 10m range)</span></span><br><span class="line">                                  <span class="comment">// 3 = HRLV</span></span><br><span class="line">AP_Float        sonar_gain;</span><br><span class="line">AP_Int8         battery_monitoring;         <span class="comment">// 0=disabled, 3=voltage only,</span></span><br><span class="line">                                            <span class="comment">// 4=voltage and current</span></span><br><span class="line">AP_Float        volt_div_ratio;</span><br><span class="line">AP_Float        curr_amp_per_volt;</span><br><span class="line">AP_Int16        pack_capacity;              <span class="comment">// Battery pack capacity less reserve</span></span><br><span class="line">AP_Int8         failsafe_battery_enabled;   <span class="comment">// battery failsafe enabled</span></span><br><span class="line">AP_Int8         failsafe_gps_enabled;       <span class="comment">// gps failsafe enabled</span></span><br><span class="line">AP_Int8         failsafe_gcs;               <span class="comment">// ground station failsafe behavior</span></span><br><span class="line">AP_Int16        gps_hdop_good;              <span class="comment">// GPS Hdop value below which represent a good position</span></span><br><span class="line">AP_Int16        my_new_parameter;                  <span class="comment">// my new parameter's description goes here</span></span><br></pre></td></tr></table></figure>
<strong>Step #3:</strong> Add the variable declaration to the var_info table in <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp" target="_blank" rel="noopener">Parameters.cpp</a><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Param: MY_NEW_PARAMETER</span></span><br><span class="line"><span class="comment">// @DisplayName: My New Parameter</span></span><br><span class="line"><span class="comment">// @Description: A description of my new parameter goes here</span></span><br><span class="line"><span class="comment">// @Range: -32768 32767</span></span><br><span class="line"><span class="comment">// @User: Advanced</span></span><br><span class="line">GSCALAR(my_new_parameter, <span class="string">"MY_NEW_PARAMETER"</span>, MY_NEW_PARAMETER_DEFAULT),</span><br></pre></td></tr></table></figure>
The @Param ~ @User comments are used by the ground station (i.e. Mission Planner) to display advice to the user and limit the values that the user may set the parameter to.</li>
</ul>
<p>The parameter name (i.e. “MY_NEW_PARAMETER”) is limited to 16 characters.</p>
<p><strong>Step #4:</strong> Add the parameters default to <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/config.h" target="_blank" rel="noopener">config.h</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MY_NEW_PARAMETER_DEFAULT</span></span><br><span class="line"> <span class="meta"># <span class="meta-keyword">define</span> MY_NEW_PARAMETER_DEFAULT      100     <span class="comment">// default value for my new parameter</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><br>You’re done! The new parameter can be access from the main code (not the libraries) as g.my_new_parameter.</p>
<h2 id="Adding-a-parameter-to-a-library"><a href="#Adding-a-parameter-to-a-library" class="headerlink" title="Adding a parameter to a library"></a>Adding a parameter to a library</h2><p>Parameters can also be added to libraries by following these steps which use the <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Compass" target="_blank" rel="noopener">AP_Compass</a> library as an example.</p>
<p><strong>Step #1:</strong> Add the new class variable to the top level .h file (i.e. <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Compass/AP_Compass.h" target="_blank" rel="noopener">Compass.h</a>). Possible types include AP_Int8, AP_Int16, AP_Float, AP_Int32 and AP_Vector3f. Also add the default value you’d like for the parameter (we will use this in step #2)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int16_t</span> product_id;                         <span class="comment">/// product id</span></span><br><span class="line">    <span class="keyword">int16_t</span> mag_x;                      <span class="comment">///&lt; magnetic field strength along the X axis</span></span><br><span class="line">    <span class="keyword">int16_t</span> mag_y;                      <span class="comment">///&lt; magnetic field strength along the Y axis</span></span><br><span class="line">    <span class="keyword">int16_t</span> mag_z;                      <span class="comment">///&lt; magnetic field strength along the Z axis</span></span><br><span class="line">    <span class="keyword">uint32_t</span> last_update;               <span class="comment">///&lt; micros() time of last update</span></span><br><span class="line">    <span class="keyword">bool</span> healthy;                               <span class="comment">///&lt; true if last read OK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Constructor</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    Compass();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    AP_Int8 _orientation;</span><br><span class="line">    AP_Vector3f _offset;</span><br><span class="line">    AP_Float _declination;</span><br><span class="line">    AP_Int8 _use_for_yaw;                       <span class="comment">///&lt;enable use for yaw calculation</span></span><br><span class="line">    AP_Int8 _auto_declination;                  <span class="comment">///&lt;enable automatic declination code</span></span><br><span class="line">    AP_Int16 _my_new_lib_parameter;              <span class="comment">/// description of my new parameter</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br><strong>Step #2:</strong>Add the variable to the var_info table in the .cpp file (i.e. <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Compass/AP_Compass.cpp" target="_blank" rel="noopener">Compass.cpp</a>) including @Param ~ @Increment comments to allow the GCS to display the description to the user and to control the min and max values set from the ground station. When adding the new parameter be careful that:</p>
<blockquote>
<ul>
<li>The slot (i.e. “9” below) is one higher than the previous variable.</li>
<li>the parameter’s name (i.e. MY_NEW_P) length is less than 16 including the object’s prefix that will be added. I.e. the compass object’s prefix is “COMPASS_”.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AP_Param::GroupInfo Compass::var_info[] = &#123;</span><br><span class="line">    <span class="comment">// index 0 was used for the old orientation matrix</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Param: OFS_X</span></span><br><span class="line">    <span class="comment">// @DisplayName: Compass offsets on the X axis</span></span><br><span class="line">    <span class="comment">// @Description: Offset to be added to the compass x-axis values to compensate for metal in the frame</span></span><br><span class="line">    <span class="comment">// @Range: -400 400</span></span><br><span class="line">    <span class="comment">// @Increment: 1</span></span><br><span class="line"></span><br><span class="line">&lt;snip&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Param: ORIENT</span></span><br><span class="line">    <span class="comment">// @DisplayName: Compass orientation</span></span><br><span class="line">    <span class="comment">// @Description: The orientation of the compass relative to the autopilot board.</span></span><br><span class="line">    <span class="comment">// @Values: 0:None,1:Yaw45,2:Yaw90,3:Yaw135,4:Yaw180,5:Yaw225,6:Yaw270,7:Yaw315,8:Roll180</span></span><br><span class="line">    AP_GROUPINFO(<span class="string">"ORIENT"</span>, <span class="number">8</span>, Compass, _orientation, ROTATION_NONE),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Param: MY_NEW_P</span></span><br><span class="line">    <span class="comment">// @DisplayName: My New Library Parameter</span></span><br><span class="line">    <span class="comment">// @Description: The new library parameter description goes here</span></span><br><span class="line">    <span class="comment">// @Range: -32768 32767</span></span><br><span class="line">    <span class="comment">// @User: Advanced</span></span><br><span class="line">    AP_GROUPINFO(<span class="string">"MY_NEW_P"</span>, <span class="number">9</span>, Compass, _my_new_lib_parameter, MY_NEW_PARAM_DEFAULT),</span><br><span class="line"></span><br><span class="line">    AP_GROUPEND</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
The parameter can be accessed from within the library as _my_new_lib_parameter. Note that we made the parameter “protected” so it cannot be access from outside the class. If we’d made it public then it would have been accessible to the main code as well as “compass._my_new_lib_parameter”.</li>
</ul>
</blockquote>
<p><strong>Step #3:</strong> Add a declaration for var_info to the public section of the .h file of new library class in addition to the definition in the .cpp file:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">AP_Param</span>:</span>:GroupInfo var_info[];</span><br></pre></td></tr></table></figure><br><strong>Step #4:</strong> If the class is a completely new addition to the code (as opposed to an existing class like AP_Compass), it should be added to the main vehicle’s var_info table in the <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp" target="_blank" rel="noopener">Parameters.cpp</a> file (it’s order in the var_info table is not important). Below in red where the Compass class appears.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AP_Param::Info var_info[] = &#123;</span><br><span class="line">    <span class="comment">// @Param: FORMAT_VERSION</span></span><br><span class="line">    <span class="comment">// @DisplayName: Eeprom format version number</span></span><br><span class="line">    <span class="comment">// @Description: This value is incremented when changes are made to the eeprom format</span></span><br><span class="line">    <span class="comment">// @User: Advanced</span></span><br><span class="line">    GSCALAR(format_version, <span class="string">"FORMAT_VERSION"</span>,   <span class="number">0</span>),</span><br><span class="line">&lt;snip&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Group: COMPASS_</span></span><br><span class="line">    <span class="comment">// @Path: ../libraries/AP_Compass/Compass.cpp</span></span><br><span class="line">    GOBJECT(compass,        <span class="string">"COMPASS_"</span>, Compass),</span><br><span class="line"></span><br><span class="line">&lt;snip&gt;</span><br><span class="line">    <span class="comment">// @Group: INS_</span></span><br><span class="line">    <span class="comment">// @Path: ../libraries/AP_InertialSensor/AP_InertialSensor.cpp</span></span><br><span class="line">    GOBJECT(ins,            <span class="string">"INS_"</span>, AP_InertialSensor),</span><br><span class="line"></span><br><span class="line">    AP_VAREND</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br><strong>Step #5:</strong> If the class is a completely new addition to the code, also add k_param_my_new_lib to the enum in <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.h" target="_blank" rel="noopener">Parameters.h</a>, where my_new_lib is the first argument to the GOBJECT declaration in <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp" target="_blank" rel="noopener">Parameters.cpp</a>. Read the comments above the enum to understand where to place the new value, as order is important here.</p>
<h2 id="Changing-the-type-of-a-parameter"><a href="#Changing-the-type-of-a-parameter" class="headerlink" title="Changing the type of a parameter"></a>Changing the type of a parameter</h2><p>From time to time parameters need to be altered or renamed. ArduPilot has capabilities that allow this to be managed from release to release so that upgrades always preserve user configured parameters. Parameters are keyed off slots in the eeprom, so if the occupied slot does not change then the parameter does not change - regardless of its name. If however the type needs to change then the parameter needs to be moved to a new slot and the existing slot be reserved to prevent unexpected configuration. In order for the configuration to be preserved it needs to be copied and converted from the old slot to the new slot.</p>
<p><strong>Step #1:</strong> Change the index of the existing parameter to an unused index and add a comment to the effect that the old slot is reserved.</p>
<p><strong>Step #2:</strong> In order to figure out the keys for conversion:</p>
<blockquote>
<ul>
<li>Set the AP_PARAM_KEY_DUMP definition to “1” [here in AP_Param.h](<a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Param/AP_Param.h#L36" target="_blank" rel="noopener">https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Param/AP_Param.h#L36</a>)</li>
<li>Change the delay here from 1ms to 2ms [here in AP_Param::show_all](<a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Param/AP_Param.cpp#L2414" target="_blank" rel="noopener">https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Param/AP_Param.cpp#L2414</a>)</li>
<li>Remove the #if / #endif from [here in Copter’s system.cpp](<a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/system.cpp#L262" target="_blank" rel="noopener">https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/system.cpp#L262</a>)</li>
<li>Start the old code in SITL and all the parameter names and their magic numbers will be displayed</li>
<li>Copy-paste from Copter’s Parameters.cpp file’s [existing parameter conversion tables like the ones done for the attitude controller’s filters](<a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp#L1219" target="_blank" rel="noopener">https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp#L1219</a>).</li>
</ul>
</blockquote>
<h1 id="十二：Adding-a-New-Flight-Mode-to-Copter"><a href="#十二：Adding-a-New-Flight-Mode-to-Copter" class="headerlink" title="十二：Adding a New Flight Mode to Copter"></a>十二：Adding a New Flight Mode to Copter</h1><p>This section covers the basics of how to create a new high level flight mode (i.e. equivalent of Stabilize, Loiter, etc) in Copter-3.6 (and higher).</p>
<p>As a reference the diagram below provides a high level view of Copter’s architecture.</p>
<p><img src="https://ardupilot.org/dev/_images/copter-architecture.png" alt=""></p>
<ol>
<li>Pick a name for the new mode and add it to the bottom of the control_mode_t enum in <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/modes.h#L14" target="_blank" rel="noopener">modes.h</a> just like “NEW_MODE” has been added below.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">Number</span> &#123;</span></span><br><span class="line">    STABILIZE =     <span class="number">0</span>,  <span class="comment">// manual airframe angle with manual throttle</span></span><br><span class="line">    ACRO =          <span class="number">1</span>,  <span class="comment">// manual body-frame angular rate with manual throttle</span></span><br><span class="line">    ALT_HOLD =      <span class="number">2</span>,  <span class="comment">// manual airframe angle with automatic throttle</span></span><br><span class="line">    AUTO =          <span class="number">3</span>,  <span class="comment">// fully automatic waypoint control using mission commands</span></span><br><span class="line">    GUIDED =        <span class="number">4</span>,  <span class="comment">// fully automatic fly to coordinate or fly at velocity/direction using GCS immediate commands</span></span><br><span class="line">    LOITER =        <span class="number">5</span>,  <span class="comment">// automatic horizontal acceleration with automatic throttle</span></span><br><span class="line">    RTL =           <span class="number">6</span>,  <span class="comment">// automatic return to launching point</span></span><br><span class="line">    CIRCLE =        <span class="number">7</span>,  <span class="comment">// automatic circular flight with automatic throttle</span></span><br><span class="line">    LAND =          <span class="number">9</span>,  <span class="comment">// automatic landing with horizontal position control</span></span><br><span class="line">    DRIFT =        <span class="number">11</span>,  <span class="comment">// semi-automous position, yaw and throttle control</span></span><br><span class="line">    SPORT =        <span class="number">13</span>,  <span class="comment">// manual earth-frame angular rate control with manual throttle</span></span><br><span class="line">    FLIP =         <span class="number">14</span>,  <span class="comment">// automatically flip the vehicle on the roll axis</span></span><br><span class="line">    AUTOTUNE =     <span class="number">15</span>,  <span class="comment">// automatically tune the vehicle's roll and pitch gains</span></span><br><span class="line">    POSHOLD =      <span class="number">16</span>,  <span class="comment">// automatic position hold with manual override, with automatic throttle</span></span><br><span class="line">    BRAKE =        <span class="number">17</span>,  <span class="comment">// full-brake using inertial/GPS system, no pilot input</span></span><br><span class="line">    THROW =        <span class="number">18</span>,  <span class="comment">// throw to launch mode using inertial/GPS system, no pilot input</span></span><br><span class="line">    AVOID_ADSB =   <span class="number">19</span>,  <span class="comment">// automatic avoidance of obstacles in the macro scale - e.g. full-sized aircraft</span></span><br><span class="line">    GUIDED_NOGPS = <span class="number">20</span>,  <span class="comment">// guided mode but only accepts attitude and altitude</span></span><br><span class="line">    SMART_RTL =    <span class="number">21</span>,  <span class="comment">// SMART_RTL returns to home by retracing its steps</span></span><br><span class="line">    FLOWHOLD  =    <span class="number">22</span>,  <span class="comment">// FLOWHOLD holds position with optical flow without rangefinder</span></span><br><span class="line">    FOLLOW    =    <span class="number">23</span>,  <span class="comment">// follow attempts to follow another vehicle or ground station</span></span><br><span class="line">    ZIGZAG    =    <span class="number">24</span>,  <span class="comment">// ZIGZAG mode is able to fly in a zigzag manner with predefined point A and point B</span></span><br><span class="line">    NEW_MODE =     <span class="number">25</span>,  <span class="comment">// your new flight mode</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>Define a new class for the mode in <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode.h" target="_blank" rel="noopener">mode.h</a>. It is probably easiest to copy a similar existing mode’s class definition and just change the class name (i.e. copy and rename “class ModeStabilize” to “class ModeNewMode”). The new class should inherit from the Mode class and implement <code>run()</code>, <code>name()</code> and <code>name4()</code> and optionally <code>init()</code>.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">       <span class="comment">// inherit constructor</span></span><br><span class="line">   <span class="keyword">using</span> Mode::Mode;</span><br><span class="line">   <span class="function"><span class="keyword">bool</span> <span class="title">init</span><span class="params">(<span class="keyword">bool</span> ignore_checks)</span> <span class="keyword">override</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">   <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">name</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="string">"NEWMODE"</span>; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">name4</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="string">"NEWM"</span>; &#125;</span><br><span class="line">```    </span><br><span class="line">    The `name()` <span class="keyword">and</span> `name4()` methods are <span class="keyword">for</span> logging <span class="keyword">and</span> <span class="built_in">display</span> purposes. `init()` will be called when the vehicle first switches into <span class="keyword">this</span> <span class="keyword">new</span> mode so it should implement any required initialisation. `<span class="built_in">run</span>()` will be called at <span class="number">400</span>hz <span class="keyword">and</span> should implement any pilot input decoding <span class="keyword">and</span> then <span class="built_in">set</span> <span class="built_in">position</span> <span class="keyword">and</span> attitude targets (see below).</span><br><span class="line">    </span><br><span class="line">    There are also some simple methods returning <span class="literal">true</span>/<span class="literal">false</span> that you may want to <span class="keyword">override</span> that control features such as whether the vehicle can be armed in the <span class="keyword">new</span> mode:</span><br><span class="line">```c    </span><br><span class="line">    <span class="keyword">bool</span> requires_GPS() <span class="keyword">const</span> <span class="keyword">override</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">has_manual_throttle</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">allows_arming</span><span class="params">(<span class="keyword">bool</span> from_gcs)</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_autopilot</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">```   </span><br><span class="line"><span class="number">3.</span>  Create a <span class="keyword">new</span> mode\_&lt;<span class="keyword">new</span> flight mode&gt;.cpp file based on a similar mode such as [mode\_stabilize.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode_stabilize.cpp) or [mode\_loiter.cpp](https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode_loiter.cpp). This new file should probably implement the `init()` method which will be called when the vehicle first enters the mode. This function should return true if it is OK for the vehicle to enter the mode, false if it cannot. Below is an excerpt from [mode\_rtl.cpp](https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode_rtl.cpp)’s init method that shows how the vehicle cannot enter RTL mode unless the home position has been set.</span></span><br><span class="line"> ```c</span><br><span class="line">   <span class="comment">// rtl_init - initialise rtl controller</span></span><br><span class="line"><span class="keyword">bool</span> ModeRTL::init(<span class="keyword">bool</span> ignore_checks)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ignore_checks) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AP::ahrs().home_is_set()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// initialise waypoint and spline controller</span></span><br><span class="line">    wp_nav-&gt;wp_and_spline_init();</span><br><span class="line">    _state = RTL_Starting;</span><br><span class="line">    _state_complete = <span class="literal">true</span>; <span class="comment">// see run() method below</span></span><br><span class="line">    terrain_following_allowed = !copter.failsafe.terrain;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Below is an excerpt from <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode_stabilize.cpp" target="_blank" rel="noopener">mode_stabilize.cpp</a>’s update method (called 400 times per second) that decodes the user’s input, then sends new targets to the attitude controller.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ModeStabilize::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// convert pilot input to lean angles</span></span><br><span class="line">    <span class="keyword">float</span> target_roll, target_pitch;</span><br><span class="line">    get_pilot_desired_lean_angles(target_roll, target_pitch, copter.aparm.angle_max, copter.aparm.angle_max);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get pilot's desired yaw rate</span></span><br><span class="line">    <span class="keyword">float</span> target_yaw_rate = get_pilot_desired_yaw_rate(channel_yaw-&gt;get_control_in());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// code that sets motor spool state omitted</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// call attitude controller</span></span><br><span class="line">    attitude_control-&gt;input_euler_angle_roll_pitch_euler_rate_yaw(target_roll, target_pitch, target_yaw_rate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// output pilot's throttle</span></span><br><span class="line">    attitude_control-&gt;set_throttle_out(get_pilot_desired_throttle(), <span class="literal">true</span>, g.throttle_filt);</span><br><span class="line">```    </span><br><span class="line"><span class="number">4.</span>  Instantiate the <span class="keyword">new</span> mode class in [Copter.h](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.h#L852) by searching for “ModeAcro” and then adding the new mode somewhere below.</span></span><br><span class="line">```c    </span><br><span class="line">        Mode *flightmode;</span><br><span class="line">#<span class="keyword">if</span> MODE_ACRO_ENABLED == ENABLED</span><br><span class="line">#<span class="keyword">if</span> FRAME_CONFIG == HELI_FRAME</span><br><span class="line">    ModeAcro_Heli mode_acro;</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    ModeAcro mode_acro;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line">    ModeAltHold mode_althold;</span><br><span class="line">#<span class="keyword">if</span> MODE_AUTO_ENABLED == ENABLED</span><br><span class="line">    ModeAuto mode_auto;</span><br><span class="line">#endif</span><br><span class="line">#<span class="keyword">if</span> AUTOTUNE_ENABLED == ENABLED</span><br><span class="line">    AutoTune autotune;</span><br><span class="line">    ModeAutoTune mode_autotune;</span><br><span class="line">#endif</span><br><span class="line">```    </span><br><span class="line"><span class="number">5.</span>  In [mode.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode.cpp) add the new mode to the `mode_from_mode_num()` function to create the mapping between the mode’s number and the instance of the class.</span></span><br><span class="line">```c    </span><br><span class="line">    <span class="comment">// return the static controller object corresponding to supplied mode</span></span><br><span class="line">Mode *Copter::mode_from_mode_num(<span class="keyword">const</span> <span class="keyword">uint8_t</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">    Mode *ret = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> ACRO:</span><br><span class="line">            ret = &amp;mode_acro;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> STABILIZE:</span><br><span class="line">            ret = &amp;mode_stabilize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">```    </span><br><span class="line"><span class="number">6.</span>  Add the <span class="keyword">new</span> flight mode to the <span class="built_in">list</span> of valid `@Values` <span class="keyword">for</span> the `FLTMODE1 ~ FLTMODE6` parameters in [Parameters.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp#L255) (Search for “FLTMODE1”). Once committed to master, this will cause the new mode to appear in the ground stations list of valid modes. Note that even before being committed to master, a user can setup the new flight mode to be activated from the transmitter’s flight mode switch by directly setting the FLTMODE1 (or FLTMODE2, etc) parameters to the number of the new mode.</span></span><br><span class="line">```c    </span><br><span class="line">    <span class="comment">// @Param: FLTMODE1</span></span><br><span class="line"><span class="comment">// @DisplayName: Flight Mode 1</span></span><br><span class="line"><span class="comment">// @Description: Flight mode when Channel 5 pwm is &lt;= 1230</span></span><br><span class="line"><span class="comment">// @Values: 0:Stabilize,1:Acro,2:AltHold,3:Auto,4:Guided,5:Loiter,6:RTL,7:Circle,9:Land,11:Drift,13:Sport,14:Flip,15:AutoTune,16:PosHold,17:Brake,18:Throw,19:Avoid_ADSB,20:Guided_NoGPS,21:Smart_RTL,22:FlowHold,23:Follow,24:ZigZag</span></span><br><span class="line"><span class="comment">// @User: Standard</span></span><br><span class="line">GSCALAR(flight_mode1, <span class="string">"FLTMODE1"</span>,               FLIGHT_MODE_1),</span><br><span class="line"></span><br><span class="line"><span class="comment">// @Param: FLTMODE2</span></span><br><span class="line"><span class="comment">// @DisplayName: Flight Mode 2</span></span><br><span class="line"><span class="comment">// @Description: Flight mode when Channel 5 pwm is &gt;1230, &lt;= 1360</span></span><br><span class="line"><span class="comment">// @Values: 0:Stabilize,1:Acro,2:AltHold,3:Auto,4:Guided,5:Loiter,6:RTL,7:Circle,9:Land,11:Drift,13:Sport,14:Flip,15:AutoTune,16:PosHold,17:Brake,18:Throw,19:Avoid_ADSB,20:Guided_NoGPS,21:Smart_RTL,22:FlowHold,23:Follow,24:ZigZag</span></span><br><span class="line"><span class="comment">// @User: Standard</span></span><br><span class="line">GSCALAR(flight_mode2, <span class="string">"FLTMODE2"</span>,               FLIGHT_MODE_2),</span><br><span class="line">```    </span><br><span class="line"><span class="number">7.</span>  Optionally you may wish to add the flight mode to the `COPTER_MODE` <span class="keyword">enum</span> within the [mavlink/ardupilotmega.xml](https:<span class="comment">//github.com/ArduPilot/mavlink/blob/master/message_definitions/v1.0/ardupilotmega.xml#L957) because some ground stations may use this to automatically populate the list of available flight modes.</span></span><br><span class="line"></span><br><span class="line">十三：Scheduling Code to Run Intermittently</span><br><span class="line">=============================================================================================================</span><br><span class="line"></span><br><span class="line">This page describes how you can schedule some <span class="keyword">new</span> piece of code you have written to <span class="built_in">run</span> intermittently.</span><br><span class="line"></span><br><span class="line">Running your code with the scheduler</span><br><span class="line">-----------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">The most flexible way to <span class="built_in">run</span> your code at a given interval is to use the scheduler. This can be done by adding your <span class="keyword">new</span> function to the [scheduler\_tasks](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L91) array in [Copter.cpp](https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp). Note that there are actually two task lists, [the upper list](https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L788) is for high speed CPUs (i.e. Pixhawk) and the [lower list](https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L856) is for slow CPUs (i.e. APM2).</span></span><br><span class="line"></span><br><span class="line">Adding a task is fairly simple, just create a <span class="keyword">new</span> row in the <span class="built_in">list</span> (higher in the <span class="built_in">list</span> means high priority). The first column holds the function name, the <span class="number">2</span>nd is a number of <span class="number">2.5</span>ms units (<span class="keyword">or</span> <span class="number">10</span>ms units in <span class="keyword">case</span> of APM2). So <span class="keyword">if</span> you wanted the function executed at <span class="number">400</span>Hz <span class="keyword">this</span> column would contain “<span class="number">1</span>”, <span class="keyword">if</span> you wanted <span class="number">50</span>Hz it would contain “<span class="number">8</span>”. The <span class="keyword">final</span> column holds the number of microseconds (i.e. millions of a second) the function is expected to take. This helps the scheduler guess whether <span class="keyword">or</span> <span class="keyword">not</span> there is enough time to <span class="built_in">run</span> your function before the main loop starts the next iteration.</span><br><span class="line">```c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  scheduler table - all regular tasks apart from the fast_loop()</span></span><br><span class="line"><span class="comment">  should be listed here, along with how often they should be called</span></span><br><span class="line"><span class="comment">  (in 10ms units) and the maximum time they are expected to take (in</span></span><br><span class="line"><span class="comment">  microseconds)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> AP_Scheduler::<span class="built_in">Task</span> scheduler_tasks[] PROGMEM = &#123;</span><br><span class="line">    &#123; update_GPS,            <span class="number">2</span>,     <span class="number">900</span> &#125;,</span><br><span class="line">    &#123; update_nav_mode,       <span class="number">1</span>,     <span class="number">400</span> &#125;,</span><br><span class="line">    &#123; medium_loop,           <span class="number">2</span>,     <span class="number">700</span> &#125;,</span><br><span class="line">    &#123; update_altitude,      <span class="number">10</span>,    <span class="number">1000</span> &#125;,</span><br><span class="line">    &#123; fifty_hz_loop,         <span class="number">2</span>,     <span class="number">950</span> &#125;,</span><br><span class="line">    &#123; run_nav_updates,      <span class="number">10</span>,     <span class="number">800</span> &#125;,</span><br><span class="line">    &#123; slow_loop,            <span class="number">10</span>,     <span class="number">500</span> &#125;,</span><br><span class="line">    &#123; gcs_check_input,       <span class="number">2</span>,     <span class="number">700</span> &#125;,</span><br><span class="line">    &#123; gcs_send_heartbeat,  <span class="number">100</span>,     <span class="number">700</span> &#125;,</span><br><span class="line">    &#123; gcs_data_stream_send,  <span class="number">2</span>,    <span class="number">1500</span> &#125;,</span><br><span class="line">    &#123; gcs_send_deferred,     <span class="number">2</span>,    <span class="number">1200</span> &#125;,</span><br><span class="line">    &#123; compass_accumulate,    <span class="number">2</span>,     <span class="number">700</span> &#125;,</span><br><span class="line">    &#123; barometer_accumulate,  <span class="number">2</span>,     <span class="number">900</span> &#125;,</span><br><span class="line">    &#123; super_slow_loop,     <span class="number">100</span>,    <span class="number">1100</span> &#125;,</span><br><span class="line">      &#123; my_new_function,      <span class="number">10</span>,     <span class="number">200</span> &#125;,</span><br><span class="line">    &#123; perf_update,        <span class="number">1000</span>,     <span class="number">500</span> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
Running your code as part of one of the loops</li>
</ol>
<hr>
<p>Instead of creating a new entry in the scheduler task list, you can add your function to one of the existing timed loops. There is no real advantage to this approach over the above approach except in the case of the fast-loop. Adding your function to the fast-loop will mean that it runs at the highest possible priority (i.e. it is nearly 100% guaranteed to run at 400Hz).</p>
<ul>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L229" target="_blank" rel="noopener">fast_loop</a> : runs at 100Hz on APM2, 400Hz on Pixhawk</li>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L370" target="_blank" rel="noopener">fifty_hz_loop</a> : runs at 50Hz</li>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L333" target="_blank" rel="noopener">ten_hz_logging_loop</a>: runs at 10Hz</li>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L398" target="_blank" rel="noopener">three_hz_loop</a>: runs at 3.3Hz</li>
<li><a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L417" target="_blank" rel="noopener">one_hz_loop</a> : runs at 1Hz</li>
</ul>
<p>So for example if you want your new code to run at 10Hz you could add it to one of the case statements in the <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp#L333" target="_blank" rel="noopener">ten_hz_logging_loop()</a> function found in <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Copter.cpp" target="_blank" rel="noopener">Copter.cpp</a>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ten_hz_logging_loop</span></span><br><span class="line"><span class="comment">// should be run at 10hz</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ten_hz_logging_loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g.log_bitmask &amp; MASK_LOG_ATTITUDE_MED) &#123;</span><br><span class="line">        Log_Write_Attitude();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (g.log_bitmask &amp; MASK_LOG_RCIN) &#123;</span><br><span class="line">        DataFlash.Log_Write_RCIN();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (g.log_bitmask &amp; MASK_LOG_RCOUT) &#123;</span><br><span class="line">        DataFlash.Log_Write_RCOUT();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((g.log_bitmask &amp; MASK_LOG_NTUN) &amp;&amp; mode_requires_GPS(control_mode)) &#123;</span><br><span class="line">        Log_Write_Nav_Tuning();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// your new function call here</span></span><br><span class="line">        my_new_function();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="十四：Copter-Motors-Library"><a href="#十四：Copter-Motors-Library" class="headerlink" title="十四：Copter Motors Library"></a>十四：Copter Motors Library</h1><p>This page covers the basics of the <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Motors" target="_blank" rel="noopener">Copter motors library</a></p>
<p>As a reference the diagram below provides a high level view of Copter’s architecture. The motors library can be seen near the bottom right just above the “Hardware Abstraction Layer”</p>
<p><img src="https://ardupilot.org/dev/_images/copter-architecture.png" alt=""></p>
<p>ArduPilot supports over 22 different multicopter frames. The Motors library is designed to consolidate the majority of the differences in these frame types from the higher level code including the attitude controllers and vehicle specific code. In other words the library provides a common interface so that all vehicles can be controlled in the same way without special handling being required in higher level code.</p>
<p>The image below shows a categorisation of these frames which is consistent with the class structure</p>
<p><img src="https://ardupilot.org/dev/_images/copter-motor-class-frames.png" alt=""></p>
<ul>
<li>Multicopter Matrix : vehicles with mostly downward facing propellers and no servos. These are the most commonly used frames and the code can be found in the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_MotorsMatrix.h" target="_blank" rel="noopener">AP_MotorsMatrix</a> class</li>
<li>Multicopter Tri and Single: vehicles with a combination of motors and servos. These are peers of each other and Multicopter Matrix and can be found in the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_MotorsTri.h" target="_blank" rel="noopener">AP_MotorsTri</a> and <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_MotorsSingle.h" target="_blank" rel="noopener">AP_MotorsSingle</a> classes</li>
<li>Helicopter Single, Quad: vehicles with swashplates that can provide reverse thrust. These are peers of each other and children of the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_MotorsHeli.h" target="_blank" rel="noopener">AP_MotorsHeli</a> class.</li>
</ul>
<p>Below is a diagram of the Motors library’s class hierarchy</p>
<p><img src="https://ardupilot.org/dev/_images/copter-motor-class-structure.png" alt=""></p>
<h2 id="Inputs-to-the-Motors-Library"><a href="#Inputs-to-the-Motors-Library" class="headerlink" title="Inputs to the Motors Library"></a>Inputs to the Motors Library</h2><p>The Attitude Controller provides high level roll, pitch, yaw and throttle commands to the Motors library in the range of -1 to +1 (for roll, pitch and yaw) or 0 to +1 (for throttle). The exact point where the attitude controller issues these commands can be found in AC_AttitudeControl_Multi’s <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_AttitudeControl/AC_AttitudeControl_Multi.cpp#L253" target="_blank" rel="noopener">rate_controller_run()</a> method<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AC_AttitudeControl_Multi::rate_controller_run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Vector3f gyro_latest = _ahrs.get_gyro_latest();</span><br><span class="line">    _motors.set_roll(rate_target_to_motor_roll(gyro_latest.x, _rate_target_ang_vel.x));</span><br><span class="line">    _motors.set_pitch(rate_target_to_motor_pitch(gyro_latest.y, _rate_target_ang_vel.y));</span><br><span class="line">    _motors.set_yaw(rate_target_to_motor_yaw(gyro_latest.z, _rate_target_ang_vel.z));</span><br></pre></td></tr></table></figure><br>and the definitions of the methods used can be seen in <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_Motors_Class.h#L78" target="_blank" rel="noopener">AP_Motors_Class.h</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set_roll, set_pitch, set_yaw, set_throttle</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_roll</span><span class="params">(<span class="keyword">float</span> roll_in)</span> </span>&#123; _roll_in = roll_in; &#125;;        <span class="comment">// range -1 ~ +1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_pitch</span><span class="params">(<span class="keyword">float</span> pitch_in)</span> </span>&#123; _pitch_in = pitch_in; &#125;;    <span class="comment">// range -1 ~ +1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_yaw</span><span class="params">(<span class="keyword">float</span> yaw_in)</span> </span>&#123; _yaw_in = yaw_in; &#125;;            <span class="comment">// range -1 ~ +1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_throttle</span><span class="params">(<span class="keyword">float</span> throttle_in)</span> </span>&#123; _throttle_in = throttle_in; &#125;; <span class="comment">// range 0 ~ 1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Outputs-and-Responsibilities"><a href="#Outputs-and-Responsibilities" class="headerlink" title="Outputs and Responsibilities"></a>Outputs and Responsibilities</h2><p>All motors libraries must do two things:</p>
<ol>
<li>Convert the high level inputs from the attitude controller to individual motor and servo outputs</li>
</ol>
<blockquote>
<ul>
<li>Roll input of +1.0 should cause motor and servo outputs that provide maximum roll rotation to the right</li>
<li>Pitch input of +1.0 should result in maximum pitch back</li>
<li>Yaw input of +1.0 should result in maximu yaw in the clockwise direction</li>
<li>Throttle input of +1.0 should result in maximum acceleration upwards (in the vehicle’s body frame). Throttle of zero should result in minimum acceleration upwards (or maximum acceleration downwards in the case of helicopters)</li>
</ul>
</blockquote>
<ol>
<li>Set the limit flags to avoid “I-term build-up” in the attitude and throttle controllers. Although a vehicle will be flyable without setting these flags, they are important for protecting against overshoot in lean angle control and also for automatic landing detection. The limits are held in the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_Motors_Class.h#L118" target="_blank" rel="noopener">AP_Motors_Class::limit</a> variable.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// structure for holding motor limit flags</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AP_Motors_limit</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> roll_pitch      : <span class="number">1</span>; <span class="comment">// we have reached roll or pitch limit</span></span><br><span class="line">    <span class="keyword">uint8_t</span> yaw             : <span class="number">1</span>; <span class="comment">// we have reached yaw limit</span></span><br><span class="line">    <span class="keyword">uint8_t</span> throttle_lower  : <span class="number">1</span>; <span class="comment">// we have reached throttle's lower limit</span></span><br><span class="line">    <span class="keyword">uint8_t</span> throttle_upper  : <span class="number">1</span>; <span class="comment">// we have reached throttle's upper limit</span></span><br><span class="line">&#125; limit;</span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">Adding support <span class="keyword">for</span> a <span class="keyword">new</span> “Multicopter Matrix” frame</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">To add support <span class="keyword">for</span> a <span class="keyword">new</span> Multicopter Matrix frame type (i.e. a frame with downward facing propellers <span class="keyword">and</span> no servos):</span><br><span class="line"></span><br><span class="line">*   Decide on a name <span class="keyword">for</span> the frame <span class="keyword">and</span> add a <span class="keyword">new</span> entry into either the motor\_frame\_class <span class="keyword">and</span>/<span class="keyword">or</span> motor\_frame\_type enums found in [AP\_Motors/AP\_Motors\_Class.h](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_Motors_Class.h#L32)</span></span><br><span class="line">*   Add the same number(s) from the above <span class="built_in">step</span> to the [FRAME\_CLASS](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp#L848) and/or [FRAME\_TYPE](https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Parameters.cpp#L361) parameters descriptions</span></span><br><span class="line">*   Add a <span class="keyword">new</span> <span class="keyword">case</span> to the [AP\_MotorsMatrix::<span class="built_in">setup</span>\_motors()](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_MotorsMatrix.cpp#L466) for the new frame class and/or frame type</span></span><br><span class="line">    *   Use AP\_MotorsMatrix::add\_motor() <span class="keyword">or</span> [AP\_MotorsMatrix::add\_motor\_raw()](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Motors/AP_MotorsMatrix.h#L62) functions to set the roll, pitch and yaw factors for each motor on the vehicle. These factors are multiplied by the high level roll, pitch and yaw input from the attitude controllers and the result is then output to the motors.</span></span><br><span class="line">    *   The above add\_motor function’s testing\_order argument specifies the order in which the motors should spin when the user initiates a motor test. Normally each motor’s testing order should be relative to its <span class="built_in">position</span> on the frame in a clockwise direction.</span><br><span class="line">    *   <span class="built_in">set</span> success = <span class="literal">true</span> at the bottom of the <span class="keyword">case</span> to alert the AP\_Motors initialisation code that the frame has been <span class="built_in">setup</span></span><br><span class="line"></span><br><span class="line">Detailed instructions are <span class="keyword">not</span> yet <span class="built_in">available</span> <span class="keyword">for</span> adding more <span class="built_in">complex</span> frame types (sorry!)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">十五：Copter Position Control <span class="keyword">and</span> Navigation</span><br><span class="line">===============================================================================================================</span><br><span class="line"></span><br><span class="line">This page covers the basics of Copter’s [Position Control](https:<span class="comment">//github.com/ArduPilot/ardupilot/tree/master/libraries/AC_AttitudeControl/AC_PosControl.h) and [Waypoint Navigation](https://github.com/ArduPilot/ardupilot/tree/master/libraries/AC_WPNav) libraries</span></span><br><span class="line"></span><br><span class="line">As a reference the diagram below provides a high level code flow view of Copter’s RTL mode</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/AC_CodeOverview_AutoFlightModes.png)</span></span><br><span class="line"></span><br><span class="line">Class Hierarchy <span class="keyword">and</span> Description[¶](#class-hierarchy-<span class="keyword">and</span>-description <span class="string">"Permalink to this headline"</span>)</span><br><span class="line">-------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/copter-navigation-class-hierarchy.png)</span></span><br><span class="line"></span><br><span class="line">At the highest level, AC\_WPNav, AC\_Circle <span class="keyword">and</span> AC\_Loiter libraries are peers <span class="keyword">and</span> all make use of the AC\_PosControl library</span><br><span class="line"></span><br><span class="line">*   AC\_WPNav is made up of three independent controllers (these may be separated into individual libraries in the <span class="built_in">future</span>):</span><br><span class="line">    </span><br><span class="line">    *   Waypoint attempts to fly the vehicle in a straight <span class="built_in">line</span> to a target waypoints. This interface accepts a <span class="number">3</span>D target destination specified as a latitude, longitude <span class="keyword">and</span> altitude <span class="keyword">or</span> as an offset from the EKF origin</span><br><span class="line">    *   Spline flies the vehile in a smooth curved path to a <span class="number">3</span>D target waypoint with a <span class="keyword">final</span> velocity that will allow it to <span class="keyword">continue</span> smoothly towards a subsequent waypoint. Its interface is very similar to the Waypoint controller above</span><br><span class="line">    *   Brake tries to slow the vehicle to a <span class="built_in">stop</span> as quickly as possible</span><br><span class="line">    *   Waypoint, Spline <span class="keyword">and</span> Brake controllers <span class="keyword">do</span> <span class="keyword">not</span> use PIDs directly. Instead they update target positions <span class="keyword">or</span> velocities which are then passed to the Position Controller</span><br><span class="line">    </span><br><span class="line">    ![](https:<span class="comment">//ardupilot.org/dev/_images/copter-navigation-wpnav-path.png)</span></span><br><span class="line">*   AC\_PosControl:</span><br><span class="line">    </span><br><span class="line">    *   Separate interfaces <span class="keyword">for</span> horizontal (X <span class="keyword">and</span> Y axis) control <span class="keyword">and</span> vertical (Z-axis) control. These interfaces are separated because some flight modes (like AltHold mode) only require the Z-axis controller</span><br><span class="line">        </span><br><span class="line">    *   Layered PID controllers are used</span><br><span class="line">        </span><br><span class="line">        *   XY axis uses a Position P to convert <span class="built_in">position</span> error to a target velocity. A velocity PID converts velocity error into a desired acceleration which is then converted to a desired lean angle which is then sent into the attitude control library.</span><br><span class="line">        </span><br><span class="line">        ![](https:<span class="comment">//ardupilot.org/dev/_images/copter-poscontrol-pid.png)</span></span><br><span class="line">        *   The Z axis uses a Position P controller to convert <span class="built_in">position</span> error to a target vertical velocity (aka climb rate). A Velocity P controller converts velocity error to a desired acceleration. An Acceleration PID converts acceleration error into a desired throttle which is then sent into the attitude control library (which mostly just passes it through to the low level motors library)</span><br><span class="line">    *   AC\_PosControl also includes a <span class="number">3</span>D velocity controller <span class="keyword">and</span> a <span class="number">3</span>D Position+Velocity controller</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">Should I use PosControl <span class="keyword">or</span> WPNav?</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Because both AC\_PosControl <span class="keyword">and</span> AC\_WPNav allow the caller to <span class="built_in">move</span> a vehicle to a <span class="number">3</span>D target <span class="built_in">point</span> it may <span class="keyword">not</span> be <span class="built_in">clear</span> which should be used.</span><br><span class="line"></span><br><span class="line">In general the vehicle code (i.e. flight mode code) should use the AC\_WPNav library because it will ensure the vehicle flies a straight path to the target. AC\_PosControl should normally only be used by other higher level navigation libraries. The exception to <span class="keyword">this</span> rule is simpler flight modes that simply want Z-axis control - these make direct use of AC\_PosControl.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">十六：Copter Object Avoidance</span><br><span class="line">=================================================================================</span><br><span class="line"></span><br><span class="line">ArduCopter, from <span class="built_in">release</span> <span class="number">3.5</span>, supports object avoidance <span class="keyword">using</span> a [Lightware SF40C](https:<span class="comment">//ardupilot.org/copter/docs/common-lightware-sf40c-objectavoidance.html#common-lightware-sf40c-objectavoidance "(in Copter)"), [TeraRanger Tower](https://ardupilot.org/copter/docs/common-teraranger-tower-objectavoidance.html#common-teraranger-tower-objectavoidance "(in Copter)") or with any sensor capable of providing distances using the MAVLink [DISTANCE\_SENSOR](https://mavlink.io/en/messages/common.html#DISTANCE_SENSOR) message. This page describes how the object avoidance feature works and how “proximity sensors” should provide data into ArduPilot.</span></span><br><span class="line"></span><br><span class="line">Avoidance in Loiter</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">The video above shows a test of an EnRoute EX700 copter fitted with a [Lightware SF40C <span class="number">360</span>degree lidar](https:<span class="comment">//ardupilot.org/rover/docs/common-lightware-sf40c-objectavoidance.html#common-lightware-sf40c-objectavoidance "(in Rover)"). The vehicle stops 2m from the fence regardless of the speed of the vehicle towards the fence. This is possible because ArduPilot knows the speed of the vehicle (using the GPS and accelerometers), the distance to the barrier and the maximum acceleration/deceleration of the vehicle.</span></span><br><span class="line"></span><br><span class="line">The [AP\_Proximity library](https:<span class="comment">//github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Proximity) collects the raw distance measurements from the sensor. These raw distance measurements are consolidated so that only the closest distance and angle within 8 sectors is stored and used.</span></span><br><span class="line"></span><br><span class="line">Each sector is <span class="number">45</span> degrees wide with sector <span class="number">0</span> pointing forward of the vehicle, sector <span class="number">1</span> is forward-right, etc. From these distances <span class="keyword">and</span> angles a fence (an <span class="built_in">array</span> of <span class="number">2</span>D Vectors) is built up around the vehicle. The fence points fall on the lines between sectors at a conservative distance.</span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"></span><br><span class="line">The <span class="keyword">default</span> is to divide the area around the vehicle into <span class="number">8</span> sectors but each proximity sensor driver can <span class="keyword">override</span> <span class="keyword">this</span> <span class="keyword">and</span> use a different number of sectors.</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/code-overview-object-avoidance1.png)</span></span><br><span class="line"></span><br><span class="line">The [AC\_Avoidance library](https:<span class="comment">//github.com/ArduPilot/ardupilot/tree/master/libraries/AC_Avoidance) consumes the above fence and uses it to adjust (mostly shortens) desired velocity vectors sent to it by the [Loiter controller](https://github.com/ArduPilot/ardupilot/blob/master/libraries/AC_WPNav/AC_Loiter.cpp#L310) (search for “avoid-&gt;adjust\_velocity”). Loiter’s desired velocity vectors come from the pilot’s inputs.</span></span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"></span><br><span class="line">Object avoidance also works <span class="keyword">for</span> Guided mode’s velocity controller</span><br><span class="line"></span><br><span class="line">Avoidance in AltHold</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">The [AP\_Proximity](https:<span class="comment">//github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Proximity) and [AC\_Avoidance libraries](https://github.com/ArduPilot/ardupilot/tree/master/libraries/AC_Avoidance) are also used for object avoidance in AltHold. Because AltHold does not rely upon the GPS, the vehicle’s velocity towards the barriers is not known and a much simpler version of object avoidance is used in which the distance to the barrier is converted into a lean angle.</span></span><br><span class="line"></span><br><span class="line">The <span class="built_in">image</span> below shows the method by which the distances to various objects are combined together to result in a <span class="keyword">final</span> roll/pitch lean angle. Each sensed object’s distance <span class="keyword">and</span> angle from the vehicle is turned into a roll/pitch angle. The largest positive <span class="keyword">and</span> negative roll <span class="keyword">and</span> pitch angles are found <span class="keyword">and</span> combined together resulting in a <span class="keyword">final</span> roll/pitch angle.</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/code-overview-object-avoidance2.png)</span></span><br><span class="line"></span><br><span class="line">This <span class="keyword">final</span> roll/pitch angle is combined with the pilot’s input meaning the vehicle tends to fly away from objects but the pilot always maintains the ability to <span class="keyword">override</span> the object avoidance. This is quite different from Loiter mode in which the pilot cannot force the vehicle to fly into an object.</span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"></span><br><span class="line">The vehicle will also <span class="built_in">stop</span> before hitting barriers above it there is an upward facing range finder. Currently <span class="keyword">this</span> range finder’s distance must be sent to ardupilot <span class="keyword">using</span> the [DISTANCE\_SENSOR](https:<span class="comment">//mavlink.io/en/messages/common.html#DISTANCE_SENSOR) message with the orientation field set to 24 (upwards).</span></span><br><span class="line"></span><br><span class="line">Reporting to the Ground Station</span><br><span class="line">-------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">MissionPlanner, from v1<span class="number">.3</span><span class="number">.48</span> onwards (<span class="keyword">and</span> hopefully other ground stations in the <span class="built_in">future</span>), shows the distance to nearby objects in a RADAR type window.</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/code-overview-object-avoidance4.png)</span></span><br><span class="line"></span><br><span class="line">This window can be opened by going to the Flight Data screen, <span class="built_in">press</span> Ctrl-F <span class="keyword">and</span> push the Proximity button. Values will will appear <span class="keyword">if</span> the [PRX\_TYPE](https:<span class="comment">//ardupilot.org/copter/docs/parameters.html#prx-type) parameter is set to enable a sensor, and messages are being received.</span></span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/code-overview-object-avoidance-show-radar-view.png)</span></span><br><span class="line"></span><br><span class="line">This is accomplished by the vehicle sending DISTANCE\_SENSOR messages to the ground station at regular intervals. The method that does <span class="keyword">this</span> can be seen in the [GCS\_Common.cpp file](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/libraries/GCS_MAVLink/GCS_Common.cpp#L408) (search for “send\_proximity”). Note that this means that it is possible that DISTANCE\_SENSOR messages can be used both to send distances into the vehicle code, and then similar DISTANCE\_SENSOR messages might be sent out from the vehicle to the ground station. These are separate messages though and are likely transferred at a different rate.</span></span><br><span class="line"></span><br><span class="line">Providing Distance Sensor messages to ArduPilot</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">For developers of <span class="keyword">new</span> “proximity” sensors (i.e. sensors that can somehow provide the distance to nearby objects) the easiest method to <span class="built_in">get</span> your distance measurements into ardupilot is to send [DISTANCE\_SENSOR](https:<span class="comment">//mavlink.io/en/messages/common.html#DISTANCE_SENSOR) message for each direction the sensor is capable of. The system id of the message should match the system id of the vehicle (default is “1” but can be changed using the SYSID\_THISMAV parameter). The component id can be anything but MAV\_COMP\_ID\_PATHPLANNER (195) or MAV\_COMP\_ID\_PERIPHERAL (158) are probably good choices.</span></span><br><span class="line"></span><br><span class="line">These messages should be sent at between <span class="number">10</span>hz <span class="keyword">and</span> <span class="number">50</span>hz (the faster the better). The fields should be filled in as shown below:</span><br><span class="line"></span><br><span class="line">*   time\_boost\_ms : <span class="number">0</span> (ignored)</span><br><span class="line">*   <span class="built_in">min</span>\_distance : the minimum distance that the sensor can measure in centimeters (i.e. <span class="number">100</span> = <span class="number">1</span>m). This number should generally <span class="keyword">not</span> change <span class="keyword">and</span> should be the same regardless of the orientation field.</span><br><span class="line">*   <span class="built_in">max</span>\_distance : the maximum distance that the sensor can measure in centimeters (i.e. <span class="number">1500</span> = <span class="number">15</span>m). This number should generally <span class="keyword">not</span> change <span class="keyword">and</span> should be the same regardless of the orientation field.</span><br><span class="line">*   current\_distance : the shortest distance in cm to the object</span><br><span class="line">*   type : <span class="number">0</span> (ignored)</span><br><span class="line">*   id : <span class="number">0</span> (ignored)</span><br><span class="line">*   orientation : <span class="number">0</span> to <span class="number">7</span> (<span class="number">0</span>=forward, each increment is <span class="number">45</span>degrees more in clockwise direction), <span class="number">24</span> (upwards) <span class="keyword">or</span> <span class="number">25</span> (downwards). search <span class="keyword">for</span> MAV\_SENSOR\_ORIENTATION on the [mavlink/common page](https:<span class="comment">//mavlink.io/en/messages/common.html).</span></span><br><span class="line">*   covariance : <span class="number">0</span> (ignored)</span><br><span class="line"></span><br><span class="line">When DISTANCE\_SENSOR messages are <span class="keyword">not</span> received <span class="keyword">for</span> all <span class="number">8</span> sectors, empty sectors are filled in with the distance from an adjacent sector (<span class="keyword">if</span> <span class="built_in">available</span>). This conveniently leads to a “cup” shaped fence which is more likely to protect the vehicle from hitting the object. It is likely <span class="keyword">this</span> will be changed in <span class="built_in">future</span> releases especially <span class="keyword">if</span> the “<span class="built_in">stop</span>” behaviour (instead of “slide” behaviour) is configured.</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/code-overview-object-avoidance3.png)</span></span><br><span class="line"></span><br><span class="line">These two videos shows a [ZED <span class="number">3</span>D camera](https:<span class="comment">//www.stereolabs.com/) connected to an [NVidia TX1](companion-computer-nvidia-tx1.html#companion-computer-nvidia-tx1) running [OpenKai](https://github.com/yankailab/OpenKAI) and providing forward facing distance measurements to ArduPilot using the method described above.</span></span><br><span class="line"></span><br><span class="line">Future Steps</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">*   add avoidance to other modes including RTL, AUTO ([issue here](https:<span class="comment">//github.com/ArduPilot/ardupilot/issues/5607))</span></span><br><span class="line">*   improve integration with ROS ([issue here](https:<span class="comment">//github.com/ArduPilot/ardupilot/issues/5608))</span></span><br><span class="line">*   implement a simple occupancy grid <span class="keyword">for</span> cases where we cannot (<span class="keyword">or</span> <span class="keyword">do</span> <span class="keyword">not</span> want to) implement ROS on the vehicle ([issue here](https:<span class="comment">//github.com/ArduPilot/ardupilot/issues/5609))</span></span><br><span class="line"></span><br><span class="line">If you would like to <span class="built_in">get</span> involved with the development of <span class="keyword">this</span> area, please consider posting in the issues listed above <span class="keyword">or</span> chatting with the developers on [Gitter/ArduPilot](https:<span class="comment">//gitter.im/ArduPilot/ardupilot).</span></span><br><span class="line"></span><br><span class="line">十七：Rover: Adding a New Drive Mode</span><br><span class="line">==============================================================================================</span><br><span class="line"></span><br><span class="line">This page covers the basics of how to create a <span class="keyword">new</span> driving (i.e. the equivalent of Manual, Steering, etc). A real example of adding a <span class="keyword">new</span> flight mode can be found in [<span class="keyword">this</span> commit](https:<span class="comment">//github.com/ArduPilot/ardupilot/commit/04e9228fa073c10ebe6f6f1f83f9d3c29a974315) that first added the ACRO mode.</span></span><br><span class="line"></span><br><span class="line">As a reference the diagram below provides a high level view of Rover’s architecture.</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/rover_architecture.png)</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>  Pick a name <span class="keyword">for</span> the <span class="keyword">new</span> mode (i.e. “NEW\_MODE”) <span class="keyword">and</span> add it to the mode <span class="keyword">enum</span> in [mode.h](https:<span class="comment">//github.com/ardupilot/ardupilot/blob/master/Rover/mode.h#L21) as “NEW\_MODE” has been added below.</span></span><br><span class="line">```c    </span><br><span class="line"><span class="comment">// Auto Pilot modes</span></span><br><span class="line"><span class="comment">// ----------------</span></span><br><span class="line"><span class="keyword">enum</span> mode &#123;</span><br><span class="line">    MANUAL       = <span class="number">0</span>,</span><br><span class="line">    ACRO         = <span class="number">1</span>,</span><br><span class="line">    STEERING     = <span class="number">3</span>,</span><br><span class="line">    HOLD         = <span class="number">4</span>,</span><br><span class="line">    NEW_MODE     = <span class="number">5</span>,</span><br><span class="line">    AUTO         = <span class="number">10</span>,</span><br><span class="line">    RTL          = <span class="number">11</span>,</span><br><span class="line">    GUIDED       = <span class="number">15</span>,</span><br><span class="line">    INITIALISING = <span class="number">16</span></span><br><span class="line">&#125;;</span><br><span class="line">```    </span><br><span class="line"><span class="number">2.</span>  Define a <span class="keyword">new</span> class <span class="keyword">for</span> the mode in [mode.h](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode.h). It is probably easiest to copy a similar existing mode’s class definition and just change the class name (i.e. copy and rename “class ModeAcro” to “class ModeNewMode”). The new class must implement the `mode_number()`, `name4()` and `update()` methods.</span></span><br><span class="line">```c    </span><br><span class="line"><span class="keyword">uint32_t</span> mode_number() <span class="keyword">const</span> <span class="keyword">override</span> &#123; <span class="keyword">return</span> NEW_MODE; &#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name4() <span class="keyword">const</span> <span class="keyword">override</span> &#123; <span class="keyword">return</span> <span class="string">"NEWM"</span>; &#125;</span><br><span class="line"><span class="keyword">void</span> update() <span class="keyword">override</span>;</span><br><span class="line">```    </span><br><span class="line">You may also want to implement the <span class="keyword">protected</span> `_enter()` method to perform any initialisation required as the vehicle enters the mode (i.e. init <span class="built_in">position</span> controllers as the user commands the vehicle to <span class="keyword">switch</span> into the <span class="keyword">new</span> mode) <span class="keyword">or</span> `_exit()` to perform any cleanup as the vehicle leaves the mode:</span><br><span class="line">```c    </span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> _enter() <span class="keyword">override</span>;</span><br><span class="line"><span class="keyword">void</span> _exit() <span class="keyword">override</span>;</span><br><span class="line">```    </span><br><span class="line">Finally there are some simple methods returning <span class="literal">true</span>/<span class="literal">false</span> that you may want to <span class="keyword">override</span> that control features such as whether the vehicle can be armed in the <span class="keyword">new</span> mode:</span><br><span class="line">```c    </span><br><span class="line"><span class="comment">/// return if in non-manual mode : AUTO, GUIDED, RTL</span></span><br><span class="line"><span class="keyword">virtual</span> <span class="keyword">bool</span> is_autopilot_mode() <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns true if steering is directly controlled by RC</span></span><br><span class="line"><span class="keyword">virtual</span> <span class="keyword">bool</span> manual_steering() <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns true if the throttle is controlled automatically</span></span><br><span class="line"><span class="keyword">virtual</span> <span class="keyword">bool</span> auto_throttle() &#123; <span class="keyword">return</span> is_autopilot_mode(); &#125;</span><br><span class="line"></span><br><span class="line">```    </span><br><span class="line"><span class="number">3.</span>  Create a <span class="keyword">new</span> mode\_&lt;<span class="keyword">new</span> flight mode&gt;.cpp file based on a similar mode such as [mode\_acro.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode_acro.cpp) or [mode\_steering.cpp](https://github.com/ArduPilot/ardupilot/blob/master/Rover/mode_steering.cpp). This new file should implement the `update()` method which will be called 50 times per second. This function’s main responsibility is to decode the user’s input, create new heading and steering targets and then call the steering and throttle controllers.</span></span><br><span class="line">  </span><br><span class="line">Below is an excerpt from [mode\_acro.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode_acro.cpp) that demonstrates how the pilot’s input is converted into target speed (in meters/second) and a target turn rate.</span></span><br><span class="line">```c   </span><br><span class="line"><span class="comment">// convert pilot stick input into desired steering and throttle</span></span><br><span class="line"><span class="keyword">float</span> desired_steering, desired_throttle;</span><br><span class="line">get_pilot_desired_steering_and_throttle(desired_steering, desired_throttle);</span><br><span class="line"></span><br><span class="line"><span class="comment">// convert pilot throttle input to desired speed (up to twice the cruise speed)</span></span><br><span class="line"><span class="keyword">float</span> target_speed = desired_throttle * <span class="number">0.01f</span> * calc_speed_max(g.speed_cruise, g.throttle_cruise * <span class="number">0.01f</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// convert pilot steering input to desired turn rate in radians/sec</span></span><br><span class="line"><span class="keyword">float</span> target_turn_rate = (desired_steering / <span class="number">4500.0f</span>) * radians(g2.acro_turn_rate);</span><br><span class="line">```    </span><br><span class="line">Near the bottom of [mode\_acro.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode_acro.cpp) you will see how these targets are sent to the steering and throttle controllers. The steering and throttle controller interfaces can be found in the [APM\_Control/AR\_AttitudeControl library](https://github.com/ArduPilot/ardupilot/blob/master/libraries/APM_Control/AR_AttitudeControl.h). The parent Mode class also provides some navigation methods that are defined in [mode.h](https://github.com/ArduPilot/ardupilot/blob/master/Rover/mode.h#L69) (search for “navigation methods”).</span></span><br><span class="line">```c    </span><br><span class="line"><span class="comment">// run steering turn rate controller and throttle controller</span></span><br><span class="line"><span class="keyword">float</span> steering_out = attitude_control.get_steering_out_rate(target_turn_rate, g2.motors.have_skid_steering(), g2.motors.limit.steer_left, g2.motors.limit.steer_right, reversed);</span><br><span class="line">g2.motors.set_steering(steering_out * <span class="number">4500.0f</span>);</span><br><span class="line">calc_throttle(target_speed, <span class="literal">false</span>);</span><br><span class="line">```    </span><br><span class="line"><span class="number">1.</span>  Instantiate the <span class="keyword">new</span> mode class in [Rover.h](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/Rover.h#L382) by searching for “ModeAcro” and then adding the new mode somewhere below.</span></span><br><span class="line">```c    </span><br><span class="line">ModeInitializing mode_initializing;</span><br><span class="line">ModeHold mode_hold;</span><br><span class="line">ModeManual mode_manual;</span><br><span class="line">ModeAcro mode_acro;</span><br><span class="line">ModeGuided mode_guided;</span><br><span class="line">ModeAuto mode_auto;</span><br><span class="line">ModeSteering mode_steering;</span><br><span class="line">ModeRTL mode_rtl;</span><br><span class="line">```    </span><br><span class="line">Also at the top of Rover.h add the <span class="keyword">new</span> mode as a “<span class="keyword">friend</span>” which allows the mode to access the Rover class’s internal variables <span class="keyword">and</span> functions.</span><br><span class="line">```c    </span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    &lt;some lines omitted&gt;</span><br><span class="line">    <span class="keyword">friend</span> class Mode;</span><br><span class="line">    <span class="keyword">friend</span> class ModeAcro;</span><br><span class="line">    <span class="keyword">friend</span> class ModeAuto;</span><br><span class="line">    <span class="keyword">friend</span> class ModeGuided;</span><br><span class="line">    <span class="keyword">friend</span> class ModeHold;</span><br><span class="line">    <span class="keyword">friend</span> class ModeSteering;</span><br><span class="line">    <span class="keyword">friend</span> class ModeManual;</span><br><span class="line">    <span class="keyword">friend</span> class ModeRTL;</span><br><span class="line">```    </span><br><span class="line"><span class="number">5.</span>  In [mode.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode.cpp) add the new mode to the `mode_from_mode_num()` function to create the mapping between the mode’s number and the instance of the class.</span></span><br><span class="line">```c    </span><br><span class="line">Mode *Rover::control_mode_from_num(<span class="keyword">const</span> <span class="keyword">enum</span> mode num)</span><br><span class="line">&#123;</span><br><span class="line">    Mode *ret = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">switch</span> (num) &#123;</span><br><span class="line">    <span class="keyword">case</span> MANUAL:</span><br><span class="line">        ret = &amp;mode_manual;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ACRO:</span><br><span class="line">        ret = &amp;mode_acro;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> STEERING:</span><br><span class="line">        ret = &amp;mode_steering;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">```    </span><br><span class="line"><span class="number">6.</span>  Add the <span class="keyword">new</span> flight mode to the <span class="built_in">list</span> of valid `@Values` <span class="keyword">for</span> the `MODE1 ~ MODE6` parameters in [Parameters.cpp](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/Parameters.cpp#L242) (Search for “MODE1”). Once committed to master, this will cause the new mode to appear in the ground stations list of valid modes. Note that even before being committed to master, a user can setup the new flight mode to be activated from the transmitter’s flight mode switch by directly setting the MODE1 (or MODE2, etc) parameters to the number of the new mode.</span></span><br><span class="line">```c    </span><br><span class="line">    <span class="comment">// @Param: MODE1</span></span><br><span class="line">    <span class="comment">// @DisplayName: Mode1</span></span><br><span class="line">    <span class="comment">// @Values: 0:Manual,1:Acro,3:Steering,4:Hold,10:Auto,11:RTL,15:Guided</span></span><br><span class="line">    <span class="comment">// @User: Standard</span></span><br><span class="line">    <span class="comment">// @Description: Driving mode for switch position 1 (910 to 1230 and above 2049)</span></span><br><span class="line">    GSCALAR(mode1,           <span class="string">"MODE1"</span>,         MANUAL),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// @Param: MODE2</span></span><br><span class="line">    <span class="comment">// @DisplayName: Mode2</span></span><br><span class="line">    <span class="comment">// @Description: Driving mode for switch position 2 (1231 to 1360)</span></span><br><span class="line">    <span class="comment">// @Values: 0:Manual,1:Acro,3:Steering,4:Hold,10:Auto,11:RTL,15:Guided</span></span><br><span class="line">    <span class="comment">// @User: Standard</span></span><br><span class="line">    GSCALAR(mode2, <span class="string">"MODE2"</span>, MANUAL),</span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">**As a side note, Rover has <span class="number">3</span> high level controllers:**</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/rover_controllers.png)</span></span><br><span class="line"></span><br><span class="line">*   the L1 controller converts an origin <span class="keyword">and</span> destination (each expressed as a latitude, longitude) into a lateral acceleration to make the vehicle travel along the path from the origin to the destination. This lateral acceleration is then passed into the steering controller.</span><br><span class="line">*   the steering controller can convert a desired lateral acceleration, a angle error <span class="keyword">or</span> a desired <span class="built_in">turn</span> rate into a steering output command (expressed as a number in the range <span class="number">-4500</span> to +<span class="number">4500</span>) that should be fed into the motor library (see [AR\_MotorsUGV.h](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/AP_MotorsUGV.h))</span></span><br><span class="line">*   the throttle controller can convert a desired speed into a throttle command (expressed as a number from <span class="number">-100</span> to +<span class="number">100</span>) that should be fed into the motor library (see [AR\_MotorsUGV.h](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/AP_MotorsUGV.h))</span></span><br><span class="line"></span><br><span class="line">十八：Rover: L1 navigation overview</span><br><span class="line">============================================================================================</span><br><span class="line"></span><br><span class="line">This page provides an overview of Rover’s navigation feature including the [L1 controller](https:<span class="comment">//github.com/ArduPilot/ardupilot/tree/master/libraries/AP_L1_Control) which is also used in Plane. The L1 controller is based on [this paper by Sanghyuk Park, John Deyst and Jonathan P How of MIT](http://mercury.kau.ac.kr/park/Archive/PCUAV/gnc_park_deyst_how.pdf).</span></span><br><span class="line"></span><br><span class="line">Overview</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/rover-navigation-overview.png)</span></span><br><span class="line"></span><br><span class="line">*   on every iteration of the main loop (<span class="number">50</span>hz) a call is made to the active mode’s update method ([here is RTL’s update function](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode_rtl.cpp#L37)). While in Auto, Guide, RTL and SmartRTL mode, the update calls into the Mode class’s [calc\_steering\_to\_waypoint](https://github.com/ArduPilot/ardupilot/blob/master/Rover/mode.cpp#L303) method.</span></span><br><span class="line">*   Mode’s [calc\_steering\_to\_waypoint](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode.cpp#L303) then call’s the AP\_L1\_controller library’s [update\_waypoint method](https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_L1_Control/AP_L1_Control.cpp#L198) providing it the location that the rover should drive towards.</span></span><br><span class="line">*   The AP\_L1\_controller’s [update\_waypoint method](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/libraries/AP_L1_Control/AP_L1_Control.cpp#L198) returns a desired lateral acceleration which is passed into Mode’s [calc\_steering\_from\_lateral\_acceleration](https://github.com/ArduPilot/ardupilot/blob/master/Rover/mode.cpp#L331)</span></span><br><span class="line">*   Mode’s [calc\_steering\_from\_lateral\_acceleration](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/mode.cpp#L331) sends the desired acceleration to [APM\_Control/AR\_AttitudeControl’s get\_steering\_out\_lat\_accel](https://github.com/ArduPilot/ardupilot/blob/master/libraries/APM_Control/AR_AttitudeControl.cpp#L158) which uses a PID controller to calculate a steering output</span></span><br><span class="line">*   The steering output is sent into the AP\_MotorsUGV library <span class="keyword">using</span> the [<span class="built_in">set</span>\_steering](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/Rover/AP_MotorsUGV.cpp#L146) method</span></span><br><span class="line"></span><br><span class="line">L1 Controller</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">The <span class="keyword">final</span> output of the L1 controller’s [update\_waypoint method](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/libraries/AP_L1_Control/AP_L1_Control.cpp#L198) is a desired lateral acceleration (shown as “latAccDem” in red below) which should bring the vehicle back to the line between the origin and destination.</span></span><br><span class="line"></span><br><span class="line">The formulas used are also shown below. _damping_ is from the [NAVL1\_DAMPING](https:<span class="comment">//ardupilot.org/rover/docs/parameters.html#navl1-damping "(in Rover)") parameter. _period_ is from the [NAVL1\_PERIOD](https://ardupilot.org/rover/docs/parameters.html#navl1-period "(in Rover)") parameter.</span></span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/rover-L1.png)</span></span><br><span class="line"></span><br><span class="line">十九：Plane Architecture Overview</span><br><span class="line">=========================================================================================</span><br><span class="line"></span><br><span class="line">This page attempts to roughly show the ArduPlane architecture. Please note it was <span class="keyword">not</span> written by Plane experts so there may be some inaccuraies.</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/plane_architecture.png)</span></span><br><span class="line"></span><br><span class="line">Above is a high level diagram of ArduPlane’s architecture. One large difference between Plane vs Copter <span class="keyword">and</span> Rover is flight modes are <span class="keyword">not</span> organised into a single file ([like they are in Copter](apmcopter-adding-a-<span class="keyword">new</span>-flight-mode.html#apmcopter-adding-a-<span class="keyword">new</span>-flight-mode)) <span class="keyword">or</span> class ([like they are in Rover](rover-adding-a-<span class="keyword">new</span>-drive-mode.html#rover-adding-a-<span class="keyword">new</span>-drive-mode)). Instead the code path goes through stages. Each stage then decides what it should <span class="keyword">do</span> based on the flight mode.</span><br><span class="line"></span><br><span class="line">These stages can be seen in the diagram above <span class="keyword">and</span> include:</span><br><span class="line"></span><br><span class="line">*   `ahrs_update` calls the EKF to consume the latest sensor data <span class="keyword">and</span> produce a attitude <span class="keyword">and</span> <span class="built_in">position</span> estimate.</span><br><span class="line">*   `read_radio` reads in the pilot’s input <span class="keyword">and</span> calculates the appropriate attitude <span class="keyword">or</span> <span class="built_in">position</span> targets</span><br><span class="line">*   `navigate` calls the L1 <span class="keyword">and</span> TECS controllers (see below) to convert <span class="built_in">position</span> targets <span class="keyword">for</span> the roll, pitch <span class="keyword">and</span> throttle controllers</span><br><span class="line">*   `update_flight_mode` copies the L1 controller’s roll <span class="keyword">and</span> pitch targets to nav\_roll\_cd <span class="keyword">and</span> nav\_pitch\_cd global variables</span><br><span class="line">*   `stabilize` executes the lower level roll, pitch <span class="keyword">and</span> throttle controllers</span><br><span class="line">*   `set_servos` sends the output from the roll, pitch <span class="keyword">and</span> throttle controllers to the appropriate servo outputs</span><br><span class="line"></span><br><span class="line">Plane Controllers</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Plane has <span class="number">2</span> high level controllers <span class="keyword">and</span> at least <span class="number">3</span> lower level controllers shown below.</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//ardupilot.org/dev/_images/plane_controllers.png)</span></span><br><span class="line"></span><br><span class="line">*   the L1 controller converts a origin <span class="keyword">and</span> destination (each expressed as a latitude, longitude) into a lateral acceleration to make the vehicle travel horizontally along the path from the origin to the destination.</span><br><span class="line">*   the TECS (Total Energy Conservation System) controls the exchange between the vehicle’s kinetic energy (i.e. speed) <span class="keyword">and</span> its potential energy (i.e. altitude). Its inputs are a target speed <span class="keyword">and</span> <span class="built_in">height</span> <span class="keyword">and</span> it attempts to reach these targets by calculating target throttle <span class="keyword">and</span> pitch values which are then passed to the lower level pitch <span class="keyword">and</span> throttle controllers.</span><br><span class="line"></span><br><span class="line">二十：Adding a <span class="keyword">new</span> Log Message</span><br><span class="line">===================================================================================</span><br><span class="line"></span><br><span class="line">[DataFlash Logs](common-logs.html#common-logs) are stored on the flight controller’s onboard dataflash memory <span class="keyword">and</span> can be downloaded after a flight. The logs provide detailed information about each flight which can be important especially when trying to [diagnose why something went wrong](common-diagnosing-problems-<span class="keyword">using</span>-logs.html#common-diagnosing-problems-<span class="keyword">using</span>-logs).</span><br><span class="line"></span><br><span class="line">This page explains how to <span class="built_in">write</span> a <span class="keyword">new</span> dataflash <span class="built_in">log</span> message.</span><br><span class="line"></span><br><span class="line">The Easy Way</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Use [AP::logger().Write(…)](https:<span class="comment">//github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/AP_Logger.h#L278):</span></span><br><span class="line">```c</span><br><span class="line"><span class="keyword">void</span> Write(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *labels, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...);</span><br><span class="line"><span class="keyword">void</span> Write(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *labels, <span class="keyword">const</span> <span class="keyword">char</span> *units, <span class="keyword">const</span> <span class="keyword">char</span> *mults, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...);</span><br></pre></td></tr></table></figure>
An example of the top function being used can be found in <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Compass/Compass_learn.cpp#L99" target="_blank" rel="noopener">Compass_learn.cpp</a>:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AP::logger().Write(<span class="string">"COFS"</span>, <span class="string">"TimeUS,OfsX,OfsY,OfsZ,Var,Yaw,WVar,N"</span>, <span class="string">"QffffffI"</span>,</span><br><span class="line">                                        AP_HAL::micros64(),</span><br><span class="line">                                        (<span class="keyword">double</span>)best_offsets.x,</span><br><span class="line">                                        (<span class="keyword">double</span>)best_offsets.y,</span><br><span class="line">                                        (<span class="keyword">double</span>)best_offsets.z,</span><br><span class="line">                                        (<span class="keyword">double</span>)best_error,</span><br><span class="line">                                        (<span class="keyword">double</span>)best_yaw_deg,</span><br><span class="line">                                        (<span class="keyword">double</span>)worst_error,</span><br><span class="line">                                        num_samples);</span><br></pre></td></tr></table></figure>
<ul>
<li>the 1st argument is the message name. This should be 4 characters or less and be unique</li>
<li>the 2nd argument is a comma separated list of up to 16 field names; with a limit of 64 characters in total</li>
<li>the 3rd argument is a format string (maximum of 16 characters) with each letter holding the format for the corresponding field. The meaning of each letter can be found <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L6" target="_blank" rel="noopener">here in AP_Logger/LogStructure.h</a></li>
<li>the remaining arguments are the actual values that will be logged. You may notice in the example above, some fields have a format of float (“f”) but are cast to <code>(double)</code> this is correct and necessary to avoid a compiler warning.</li>
</ul>
<p>The 2nd Log_Write function is the same as the first except that it accepts two additional string arguments, <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L42" target="_blank" rel="noopener">“units”</a> and <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L86" target="_blank" rel="noopener">“mults”</a>. Similar to the “format” argument, each character in these arguments specifies the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L42" target="_blank" rel="noopener">units</a> (i.e. “d” for degrees) or <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L86" target="_blank" rel="noopener">multiplier</a> (i.e. “2” for *100, “B” for *0.01) for the following fields. These help the graphing tools scale the output correctly when displaying to the user.</p>
<p>For example, below is a “TEST” log message which outputs the current system time and altitude.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AP::logger().Write(<span class="string">"TEST"</span>, <span class="string">"TimeUS,Alt"</span>,</span><br><span class="line">                   <span class="string">"sm"</span>, <span class="comment">// units: seconds, meters</span></span><br><span class="line">                   <span class="string">"FB"</span>, <span class="comment">// mult: 1e-6, 1e-2</span></span><br><span class="line">                   <span class="string">"Qf"</span>, <span class="comment">// format: uint64_t, float</span></span><br><span class="line">                   AP_HAL::micros64(),</span><br><span class="line">                   (<span class="keyword">double</span>)alt_in_cm);</span><br></pre></td></tr></table></figure>
<ul>
<li>the time has units of seconds (“s”), multiplier of “F” to indicate the value should be divided by 1 million and format of “Q” to indicate it is output as a 64 bit unsigned integer.</li>
<li>the altitude has units of meters (“m”), multiplier of “B” to indicate the value should be divided by 100 (to convert from centimeters to meters) and format of “f” because the value is a float.</li>
</ul>
<h2 id="The-Harder-Way"><a href="#The-Harder-Way" class="headerlink" title="The Harder Way"></a>The Harder Way</h2><p>For commonly used messages, especially those which are output at a relatively high rate (50hz or more) a slightly more efficient logging method can be used.</p>
<ul>
<li><p>decide if the logging will come from a library (i.e. the call to Log_Write will from somewhere within the <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries" target="_blank" rel="noopener">libraries directory</a>) or the vehicle code (i.e. from within <a href="https://github.com/ArduPilot/ardupilot/tree/master/ArduCopter" target="_blank" rel="noopener">ArduCopter</a>, <a href="https://github.com/ArduPilot/ardupilot/tree/master/ArduPlane" target="_blank" rel="noopener">ArduPlane</a>, etc)</p>
</li>
<li><p>add a new entry to the <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/defines.h#L222" target="_blank" rel="noopener">vehicle’s #define list or enum in defines.h</a> or <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L1566" target="_blank" rel="noopener">AP_Logger/LogStructure.h’s LogMessages enum</a>.</p>
</li>
<li><p>define a structure to hold the values to be logged in either the vehicle’s <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Log.cpp" target="_blank" rel="noopener">Log.cpp</a> file or in <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h" target="_blank" rel="noopener">AP_Logger/LogStructure.h</a>. All log file messages should have time_us as their first field.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">PACKED</span> <span class="title">log_Test</span> &#123;</span></span><br><span class="line">    LOG_PACKET_HEADER;</span><br><span class="line">    <span class="keyword">uint64_t</span> time_us;</span><br><span class="line">    <span class="keyword">float</span> a_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>add the log message’s name, <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L42" target="_blank" rel="noopener">units</a>, <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L86" target="_blank" rel="noopener">multiplier</a> and <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L6" target="_blank" rel="noopener">format</a> strings into the <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/Log.cpp#L454" target="_blank" rel="noopener">vehicle’s LogStructure array</a> or <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/LogStructure.h#L1360" target="_blank" rel="noopener">AP_Logger/LogStructure.h’s LOG_EXTRA_STRUCTURES array</a></p>
</li>
<li><p>add a new method to the vehicle code or AP_Logger library called Write_<something-or-other> which fills in the structure and then calls <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/AP_Logger/AP_Logger.h#L197" target="_blank" rel="noopener">AP_Logger/WriteBlock()</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Copter::Log_Write_Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">log_Test</span> <span class="title">pkt</span> = &#123;</span></span><br><span class="line">        LOG_PACKET_HEADER_INIT(LOG_TEST_MSG),</span><br><span class="line">        time_us  : AP_HAL::micros64(),</span><br><span class="line">        a_value  : <span class="number">1234</span></span><br><span class="line">    &#125;;</span><br><span class="line">    logger.WriteBlock(&amp;pkt, <span class="keyword">sizeof</span>(pkt));</span><br><span class="line">&#125;</span><br><span class="line">```    </span><br><span class="line">*   call <span class="keyword">this</span> <span class="keyword">new</span> function from the [scheduler](code-overview-scheduling-your-<span class="keyword">new</span>-code-to-<span class="built_in">run</span>-intermittently.html#code-overview-scheduling-your-<span class="keyword">new</span>-code-to-<span class="built_in">run</span>-intermittently) <span class="keyword">or</span> from some other place in the code at the moment you wish to <span class="built_in">log</span> the values</span><br><span class="line"></span><br><span class="line">二十一：Adding a <span class="keyword">new</span> MAVLink Message</span><br><span class="line">===========================================================================================</span><br><span class="line"></span><br><span class="line">Data <span class="keyword">and</span> commands are passed between the ground station (i.e. Mission Planner, QGroundControl, MAVProxy, etc.) <span class="keyword">using</span> the [MAVLink protocol](https:<span class="comment">//mavlink.io/en/) over a serial interface. This page provides some high-level advice for adding a new MAVLink message.</span></span><br><span class="line"></span><br><span class="line">These instructions have only been tested on Linux (to be precise a VM <span class="built_in">running</span> Ubuntu on a Windows machine). Instructions <span class="keyword">for</span> setting up a VM are on the [SITL page](setting-up-sitl-on-windows.html#setting-up-sitl-on-windows). If you can <span class="built_in">run</span> SITL, you should be able to follow the advice here. These instructions will <span class="keyword">not</span> <span class="built_in">run</span> natively on Windows <span class="keyword">or</span> a Mac.</span><br><span class="line"></span><br><span class="line">**Step #<span class="number">1</span>:** Ensure you have the latest ArduPilot code installed. Also, check mavproxy. Mavproxy can be updated by <span class="built_in">running</span> <span class="keyword">this</span> command in a Terminal window:</span><br><span class="line">```c</span><br><span class="line">sudo pip install --upgrade mavproxy</span><br></pre></td></tr></table></figure>
<p><strong>Step #2:</strong> Decide what type of message you want to add and how it will fit in with the existing <a href="https://mavlink.io/en/" target="_blank" rel="noopener">MAVLink messages</a>.</p>
</li>
</ul>
<p>For example, you might want to send a new navigation command to the vehicle so that it can perform a trick (like a flip) in the middle of a mission (i.e. in AUTO mode). In this case, you would need a new MAV_CMD_NAV_TRICK similar to the MAV_CMD_NAV_WAYPOINT definition (search for “MAV_CMD_NAV_WAYPOINT” in the <a href="https://mavlink.io/en/messages/common.html" target="_blank" rel="noopener">MAVLink messages</a> page).</p>
<p>Alternatively, you may want to send down a new type of sensor data from the vehicle to the ground station. Perhaps similar to the <a href="https://mavlink.io/en/messages/common.html#SCALED_PRESSURE" target="_blank" rel="noopener">SCALED_PRESSURE</a> message.</p>
<p><strong>Step #3:</strong> Add the new message definition to the <a href="https://github.com/ArduPilot/mavlink/blob/master/message_definitions/v1.0/common.xml" target="_blank" rel="noopener">common.xml</a> or <a href="https://github.com/ArduPilot/mavlink/blob/master/message_definitions/v1.0/ardupilotmega.xml" target="_blank" rel="noopener">ardupilotmega.xml</a> file in the MAVLink submodule.</p>
<p>If this command is generally useful, and will hopefully be added to the MAVLink protocol, then it should be added to the ../modules/mavlink/message_definitions/v1.0/common.xml file. If it is only for your personal use or only applicable to ArduPilot, then it should be added to the ardupilotmega.xml file.</p>
<p><strong>Step #4:</strong> Add functions to the main vehicle code to handle sending or receiving the command to/from the ground station. A compile will be needed (ie. ./waf copter) to generate the MAVLink packet code so make sure to do that after editing the XML file. The MAVLink generation happens first, so it doesn’t matter if the project compilation is successful or not due to other source code changes.</p>
<p>The top-level of this code will most likely be in the vehicle’s <a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/GCS_Mavlink.cpp" target="_blank" rel="noopener">GCS_MAVLink.cpp</a> file or in the <a href="https://github.com/ArduPilot/ardupilot/blob/master/libraries/GCS_MAVLink/GCS.h" target="_blank" rel="noopener">../libraries/GCS_MAVLink/GCS</a> class.</p>
<p>In the first example where we want to add support for a new navigation command (i.e., a trick) the following would be required:</p>
<ul>
<li>Extend the <a href="https://github.com/ArduPilot/ardupilot/tree/master/libraries/AP_Mission" target="_blank" rel="noopener">AP_Mission</a> library’s <code>mission_cmd_to_mavlink()</code> and <code>mavlink_to_mission_cmd()</code> functions to convert the MAVProxy command into an AP_Mission::Mission_Command structure.</li>
<li>Add a new case to the vehicle’s commands_logic.cpp ‘s (<a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode_auto.cpp" target="_blank" rel="noopener">mode_auto.cpp</a> for ArduCopter) <code>start_command()</code> and <code>verify_command()</code> functions to check for the arrival of the new <code>MAV_CMD_NAV_TRICK</code>. These should call two new functions that you create called <code>do_trick()</code> and <code>verify_trick()</code> (see below).</li>
<li>Create these two new functions, do_trick() and verify_trick(), that somehow command the vehicle <em>to perform the trick</em> (perhaps by calling another function in control_auto.cpp (<a href="https://github.com/ArduPilot/ardupilot/blob/master/ArduCopter/mode_auto.cpp" target="_blank" rel="noopener">mode_auto.cpp</a> for ArduCopter) that sets the auto_mode variable and then calls a new <code>auto_trick_start()</code> function). The <code>do_trick()</code> function will be called when the command is first invoked. The <code>verify_trick()</code> will be called at 10hz (or higher) repeatedly until the trick is complete. The <code>verify_trick()</code> function should return true when the trick has been completed.</li>
</ul>
<p><strong>Step #5:</strong> Decide how you are going to handle the message at the GCS. One of the simplest ways is to use Mavproxy. MavProxy uses pymavlink to define the MAVLink messages, so you will need to rebuild pymavlink to include your custom message.</p>
<blockquote>
<ul>
<li>Remove the currently installed version of pymavlink. <code>pip uninstall pymavlink</code></li>
<li>Install the updated version. CD to <code>ardupilot/modules/mavlink/pymavlink</code> and run <code>python setup.py install --user</code></li>
<li>Mavproxy is now capable of sending or receiving the new message. To ask it to print out or send your message you need to implement a module. Modules are python plugins that allow you to add functionality to Mavproxy. By default on Ubuntu they are located in <code>/usr/local/lib/python2.7/dist-packages/MAVProxy/modules/</code>. Here is an example of a module that prints the contents of a MY_CUSTOM_PACKET message. Look at the other modules for examples on how to trigger sending of messages using the command line interface.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  #!/usr/bin/env python</span><br><span class="line"><span class="string">'''</span>Custom<span class="number">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time, os</span><br><span class="line"></span><br><span class="line">from MAVProxy.modules.lib <span class="keyword">import</span> mp_module</span><br><span class="line">from pymavlink <span class="keyword">import</span> mavutil</span><br><span class="line"><span class="keyword">import</span> sys, traceback</span><br><span class="line"></span><br><span class="line"><span class="function">class <span class="title">CustomModule</span><span class="params">(mp_module.MPModule)</span>:</span></span><br><span class="line"><span class="function">    def __<span class="title">init__</span><span class="params">(self, mpstate)</span>:</span></span><br><span class="line">        super(CustomModule, self).__init__(mpstate, "Custom", "Custom module")</span><br><span class="line">        <span class="string">'''</span>initialisation code<span class="number">'''</span></span><br><span class="line"></span><br><span class="line">    <span class="function">def <span class="title">mavlink_packet</span><span class="params">(self, m)</span>:</span></span><br><span class="line">        'handle a MAVLink packet'''</span><br><span class="line">        if m.get_type() == 'MY_CUSTOM_PACKET':</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"My Int: %(x).2f"</span> % \</span><br><span class="line">                &#123;<span class="string">"x"</span> : m.intField&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="title">init</span><span class="params">(mpstate)</span>:</span></span><br><span class="line">    '''initialise module'''</span><br><span class="line">    <span class="keyword">return</span> CustomModule(mpstate)</span><br></pre></td></tr></table></figure>
Warning</li>
</ul>
</blockquote>
<p>If the message you added has an ID greater that 255 you will need to enable MAVLink 2 support. This can be done by setting the relevant <code>SERIALn_PROTOCOL</code> parameters (e.g. <code>SERIAL1_PROTOCOL</code>) to 2 and starting Mavproxy with the <code>--mav20</code> argument.</p>
<p><strong>Step #6:</strong> Consider contributing your code back to the main code base. Discuss this with other developers on <a href="https://gitter.im/ardupilot/ardupilot" target="_blank" rel="noopener">Gitter</a> and/or <a href="submitting-patches-back-to-master.html#submitting-patches-back-to-master">raise a pull request</a>. If you raise a pull request it is best to separate the change into at least two separate commits. One commit for the changes to the .xml files (i.e Step #3) and another for the changes to the vehicle code.</p>
<h1 id="二十二：Adding-Support-for-a-new-MAVLink-Gimbal"><a href="#二十二：Adding-Support-for-a-new-MAVLink-Gimbal" class="headerlink" title="二十二：Adding Support for a new MAVLink Gimbal"></a>二十二：Adding Support for a new MAVLink Gimbal</h1><p>This page covers how ArduPilot interacts with a MAVLink enabled gimbal. It is meant more as a guide on how gimbal manufacturers can make their gimbals work with ArduPilot with minimum code changes to ArduPilot .</p>
<p>The <a href="https://ardupilot.org/copter/docs/common-storm32-gimbal.html#common-storm32-gimbal" target="_blank" rel="noopener" title="(in Copter)">SToRM32 gimbal</a> is a good reference as it supports MAVLink.</p>
<h2 id="Messages-the-gimbal-should-support"><a href="#Messages-the-gimbal-should-support" class="headerlink" title="Messages the gimbal should support"></a>Messages the gimbal should support</h2><ol>
<li><p>The gimbal should listen on the serial port for a <a href="https://mavlink.io/en/messages/common.html#HEARTBEAT" target="_blank" rel="noopener">HEARTBEAT</a> message from the vehicle. It can generally assume that the first heart beat it receives will be from the vehicle but to be certain you can check the “type” field to be sure it’s something sensible (i.e. MAV_TYPE = 1 for fixed wing, 2 for quadcopters but 6 for GCSs should be ignored).</p>
<p>This heart beat will contain the vehicle’s system-id and component-id. The gimbal should adopt the same system-id but should use a component-id of MAV_COMP_ID_GIMBAL (i.e. 154) for all it’s future messages. In fact, any unique component-id can be used as long as it’s not zero nor the component id of the vehicle or any other device on the vehicle.</p>
</li>
<li><p>The gimbal should send a <a href="https://mavlink.io/en/messages/common.html#HEARTBEAT" target="_blank" rel="noopener">HEARTBEAT</a> message out the serial port at approximately 1hz</p>
<ul>
<li>the system-id and component-id should be as mentioned above.</li>
<li>“type” should be MAV_TYPE_GIMBAL (i.e. 26).</li>
<li>“autopilot” is not used so can be set to anything including MAV_AUTOPILOT_GENERIC (i.e. 0)</li>
<li>“base_mode” and “custom_mode” are not used so can be set to anything (perhaps 0 is best)</li>
<li>“system_status” should be set to “MAV_STATE_ACTIVE” once the gimbal is ready to accept attitude targets</li>
</ul>
</li>
<li><p>To support reading/writing parameter values from the ground station the gimbal should implement these message:</p>
<ul>
<li><a href="https://mavlink.io/en/messages/common.html#PARAM_REQUEST_READ" target="_blank" rel="noopener">PARAM_REQUEST_READ</a> - if the gimbal receives this message and “target_system” and “target_component” values match the gimbal’s system-id and component-id, it should respond with a <a href="https://mavlink.io/en/messages/common.html#PARAM_VALUE" target="_blank" rel="noopener">PARAM_VALUE</a> message which contains the value of the parameter specified by the “param_id” field (simply an enum, the gimbal can assign whatever enum it wishes to each of it’s internal paramters)</li>
<li><a href="https://mavlink.io/en/messages/common.html#PARAM_REQUEST_LIST" target="_blank" rel="noopener">PARAM_REQUEST_LIST</a> - respond to this message by sending a <a href="https://mavlink.io/en/messages/common.html#PARAM_VALUE" target="_blank" rel="noopener">PARAM_VALUE</a> message for every parameter within the gimbal.</li>
<li><a href="https://mavlink.io/en/messages/common.html#PARAM_SET" target="_blank" rel="noopener">PARAM_SET</a> - respond to this by setting the internal variable to the value in the “param_value” field.</li>
</ul>
</li>
<li><p>ArduPilot will send angle requests to the gimbal via MAVLink which will arrive as <a href="https://mavlink.io/en/messages/common.html#COMMAND_LONG" target="_blank" rel="noopener">COMMAND_LONG</a> messages with the “command” field set to MAV_CMD_DO_MOUNT_CONTROL (i.e 205).</p>
<ul>
<li>Param #1 contains desired pitch in degrees</li>
<li>Param #2 contains desired roll in degrees</li>
<li>Param #3 contains desired yaw in degrees but note that the yaw is in relation to the front of the vehicle so “0” is straight ahead, “90” is to the right, “-90” is to the left.</li>
</ul>
</li>
<li><p>If the gimbal needs extra data from the vehicle it can request it using the <a href="https://mavlink.io/en/messages/common.html#REQUEST_DATA_STREAM" target="_blank" rel="noopener">REQUEST_DATA_STREAM</a> message.</p>
<ul>
<li>the target system and component id should be for the vehicle.</li>
<li>“req_stream_id” can be any values in the MAV_DATA_STREAM enum. Some useful values are:<ul>
<li>MAV_DATA_STREAM_POSITION will cause the vehicle to send <a href="https://mavlink.io/en/messages/common.html#GLOBAL_POSITION_INT" target="_blank" rel="noopener">GLOBAL_POSITION_INT</a> messages which includes lat, lon, alt, velocity (3d) and heading)</li>
<li>MAV_DATA_STREAM_EXTRA1 will send the <a href="https://mavlink.io/en/messages/common.html#ATTITUDE" target="_blank" rel="noopener">MSG_ATTITUDE</a> which includes euler angles for roll, pitch, yaw</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>To test the system, you should be able to connect the gimbal to a Pixhawk as if it’s a SToRM32 gimbal. In particular check the <a href="http://copter.ardupilot.com/wiki/common-storm32-gimbal/#set-up_through_the_mission_planner_mavlink_protocol" target="_blank" rel="noopener">“Set-up through the Mission Planner (MALVink protocol)”</a> section.</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/22/APM%E5%BC%80%E5%8F%91%E8%80%85%E6%89%8B%E5%86%8C/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Channel解读" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/22/Channel%E8%A7%A3%E8%AF%BB/">Channel解读</a>
    </h1>
  

        
        <a href="/2020/05/22/Channel%E8%A7%A3%E8%AF%BB/" class="archive-article-date">
  	<time datetime="2020-05-22T02:51:04.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-22</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文转载于<a href="https://blog.csdn.net/alvin_jack/article/details/77043579?utm_source=blogxgwz9" target="_blank" rel="noopener">https://blog.csdn.net/alvin_jack/article/details/77043579?utm_source=blogxgwz9</a><br>
        
          <a class="article-more-a" href="/2020/05/22/Channel%E8%A7%A3%E8%AF%BB/#more">more >></a>
        
      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/22/Channel%E8%A7%A3%E8%AF%BB/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Ardupilot遥控器输入数据分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/13/Ardupilot%E9%81%A5%E6%8E%A7%E5%99%A8%E8%BE%93%E5%85%A5%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">Ardupilot遥控器输入数据分析</a>
    </h1>
  

        
        <a href="/2020/05/13/Ardupilot%E9%81%A5%E6%8E%A7%E5%99%A8%E8%BE%93%E5%85%A5%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" class="archive-article-date">
  	<time datetime="2020-05-13T08:19:53.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-13</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a href="#目录">目录</a></li>
<li><a href="#摘要">摘要</a></li>
<li><a href="#1遥控器输入初始化">1.遥控器输入初始化</a></li>
<li><a href="#2遥控器数据更新">2.遥控器数据更新</a></li>
<li><p><a href="#3遥控器代码调用逻辑">3.遥控器代码调用逻辑</a></p>
<p><strong>转载</strong>：原文链接：<a href="https://blog.csdn.net/lixiaoweimashixiao/article/details/81667594" target="_blank" rel="noopener">https://blog.csdn.net/lixiaoweimashixiao/article/details/81667594</a></p>
</li>
</ul>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><hr>
<p><strong>本节主要记录自己学习arducopter代码中遥控器输入命令处理代码，无人机遥控器的输入决定着无人机怎么飞行，是非常重要的。特别是作为目标输入控制量，理解这个值，对于我们对飞控固件中的控制有很大的帮助。这里选择以futaba为例，来说明，我用的遥控器是14通道的，以美国手为例来说明。</strong><br><img src="https://img-blog.csdn.net/20180824124801661?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p><strong>需要注意的是遥控器的1，2，3，4通道不是控制单个电机，这点一定要分清楚，特别看ardupilot代码中一个伺服输出接口怎么实现很多功能，怎么映射遥控器到伺服输出（遥控器的单个通道怎么控制映射到伺服输出）？</strong><br><strong>ardupilot多旋翼代码的电机输出只有八个通道，最多只能实现8旋翼，还有六个外部通道输出，可以用来植保，等辅助功能键。</strong></p>
<hr>
<hr>
<h1 id="1-遥控器输入初始化"><a href="#1-遥控器输入初始化" class="headerlink" title="1.遥控器输入初始化"></a>1.遥控器输入初始化</h1><hr>
<hr>
<p><strong>（1）void Copter::setup()</strong></p>
<pre><code>void Copter::setup() 
{
    cliSerial = hal.console;

    //加载初始化参数表到 in var_info[]s
    AP_Param::setup_sketch_defaults();

    // 初始化无人机的结构布局
    StorageManager::set_layout_copter();

    //注册传感器
    init_ardupilot();

    // 初始化 main loop 任务
    scheduler.init(&amp;scheduler_tasks[0], ARRAY_SIZE(scheduler_tasks));

    // 初始化 main loop 任务
    perf_info_reset();
    fast_loopTimer = AP_HAL::micros();
}
</code></pre><hr>
<p><strong>（2）init_ardupilot();</strong></p>
<pre><code>void Copter::init_ardupilot()
{
   init_rc_in(); //遥控器初始化
   ......
   reset_control_switch();//遥控器上面的5通道，复位控制通道
   init_aux_switches();   //遥控器上的初始化外部开关，具有一定的功能
}
</code></pre><hr>
<p><strong>1》 init_rc_in();</strong><br>在radio.cpp下</p>
<pre><code>void Copter::init_rc_in()
{
    channel_roll     = RC_Channels::rc_channel(rcmap.roll()-1);     //横滚通道
    channel_pitch    = RC_Channels::rc_channel(rcmap.pitch()-1);    //俯仰通道
    channel_throttle = RC_Channels::rc_channel(rcmap.throttle()-1); //油门通道
    channel_yaw      = RC_Channels::rc_channel(rcmap.yaw()-1);     //偏航通道

    // 设置四个通道的最大范围
    channel_roll-&gt;set_angle(ROLL_PITCH_YAW_INPUT_MAX); //最大4500
    channel_pitch-&gt;set_angle(ROLL_PITCH_YAW_INPUT_MAX);//最大4500
    channel_yaw-&gt;set_angle(ROLL_PITCH_YAW_INPUT_MAX);  //最大4500
    channel_throttle-&gt;set_range(1000);                 //1000

    //设置辅助伺服范围-----------------set auxiliary servo ranges
    RC_Channels::rc_channel(CH_5)-&gt;set_range(1000);
    RC_Channels::rc_channel(CH_6)-&gt;set_range(1000);
    RC_Channels::rc_channel(CH_7)-&gt;set_range(1000);
    RC_Channels::rc_channel(CH_8)-&gt;set_range(1000);

    //设置默认死区-------------------set default dead zones
    default_dead_zones();

    //初始化遥控通道死区范围-----------initialise throttle_zero flag
    ap.throttle_zero = true;
}
</code></pre><p><img src="https://img-blog.csdn.net/20180814160914160?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<hr>
<p><strong>2》reset_control_switch()</strong></p>
<hr>
<pre><code>void Copter::reset_control_switch()
{
    control_switch_state.last_switch_position = control_switch_state.debounced_switch_position = -1;//设置当前模式
    read_control_switch();//读取控制开关
}

   //用于检测飞行模式控制开关的变化的结构体
    struct 
    {
        int8_t debounced_switch_position;   //当前使用的开关位置-----------currently used switch position
        int8_t last_switch_position;        //上一次迭代中的开关位置--------switch position in previous iteration
        uint32_t last_edge_time_ms;         //切换位置上次更改的系统时间----system time that switch position was last changed
    } control_switch_state;

//5通道六段开关
void Copter::read_control_switch()
{
    uint32_t tnow_ms = millis();

    //计算飞行模式开关位置--------------------calculate position of flight mode switch
    int8_t switch_position;                //获取5通道遥控器的位置设定飞行模式
    uint16_t rc5_in = RC_Channels::rc_channel(CH_5)-&gt;get_radio_in();  //获取5通道数据

    if      (rc5_in &lt; 1231) switch_position = 0; //可以设置姿态
    else if (rc5_in &lt; 1361) switch_position = 1;
    else if (rc5_in &lt; 1491) switch_position = 2;
    else if (rc5_in &lt; 1621) switch_position = 3; //可以设置定高
    else if (rc5_in &lt; 1750) switch_position = 4;
    else switch_position = 5; //可以设置定点

    //存储上次切换开关的时间----store time that switch last moved
    if (control_switch_state.last_switch_position != switch_position)
    {
        control_switch_state.last_edge_time_ms = tnow_ms;
    }

    //开关去抖动------debounce switch
    bool control_switch_changed = control_switch_state.debounced_switch_position != switch_position;
    bool sufficient_time_elapsed = tnow_ms - control_switch_state.last_edge_time_ms &gt; CONTROL_SWITCH_DEBOUNCE_TIME_MS;
    bool failsafe_disengaged = !failsafe.radio &amp;&amp; failsafe.radio_counter == 0;
 //三个条件同时满足，才进行，开关确实改变了，切换时间足够长，遥控器有数据，
    if (control_switch_changed &amp;&amp; sufficient_time_elapsed &amp;&amp; failsafe_disengaged)
    {
        //设定飞行模式和简单模式设置-------set flight mode and simple mode setting
        if (set_mode((control_mode_t)flight_modes[switch_position].get(), MODE_REASON_TX_COMMAND))
        {
            // play a tone
            if (control_switch_state.debounced_switch_position != -1)
            {
                // alert user to mode change failure (except if autopilot is just starting up)
                if (ap.initialised) {
                    AP_Notify::events.user_mode_change = 1;
                }
            }

            if (!check_if_auxsw_mode_used(AUXSW_SIMPLE_MODE) &amp;&amp; !check_if_auxsw_mode_used(AUXSW_SUPERSIMPLE_MODE))
            {
                // if none of the Aux Switches are set to Simple or Super Simple Mode then
                // set Simple Mode using stored parameters from EEPROM
                if (BIT_IS_SET(g.super_simple, switch_position))
                {
                    set_simple_mode(2);
                } else
                {
                    set_simple_mode(BIT_IS_SET(g.simple_modes, switch_position));
                }
            }

        } else if (control_switch_state.last_switch_position != -1) {
            // alert user to mode change failure
            AP_Notify::events.user_mode_change_failed = 1;
        }

        // set the debounced switch position
        control_switch_state.debounced_switch_position = switch_position;
    }
  //否则，记录的还是当前模式，也就是没有改变飞行模式。
    control_switch_state.last_switch_position = switch_position;
}

bool Copter::set_mode(control_mode_t mode, mode_reason_t reason)
{
    // boolean to record if flight mode could be set
    bool success = false;
    bool ignore_checks = !motors-&gt;armed();   //如果没有解锁，允许任何模式ignore_checks=1，_flags.armed=0表示没有解锁，_flags.armed=1表示解锁

    // return immediately if we are already in the desired mode
    if (mode == control_mode)
    {
        prev_control_mode = control_mode;
        prev_control_mode_reason = control_mode_reason;

        control_mode_reason = reason;
        return true;
    }


#if FRAME_CONFIG == HELI_FRAME
    // do not allow helis to enter a non-manual throttle mode if the
    // rotor runup is not complete
    if (!ignore_checks &amp;&amp; !mode_has_manual_throttle(mode) &amp;&amp; !motors-&gt;rotor_runup_complete()){
        goto failed;
    }
#endif

    switch (mode)
    {
        case ACRO:
            #if FRAME_CONFIG == HELI_FRAME
                success = heli_acro_init(ignore_checks);
            #else
                success = acro_init(ignore_checks);
            #endif
            break;

        case STABILIZE:
            #if FRAME_CONFIG == HELI_FRAME
                success = heli_stabilize_init(ignore_checks);
            #else
                success = stabilize_init(ignore_checks);  //姿态自我稳定模式
            #endif
            break;

        case ALT_HOLD:
            success = althold_init(ignore_checks);        //高度控制初始化
            break;

        case AUTO:
            success = auto_init(ignore_checks);           //自动模式
            break;

        case CIRCLE:
            success = circle_init(ignore_checks);
            break;

        case LOITER:
            success = loiter_init(ignore_checks);         //定点悬停初始化
            break;

        case GUIDED:
            success = guided_init(ignore_checks);
            break;

        case LAND:
            success = land_init(ignore_checks);
            break;

        case RTL:
            success = rtl_init(ignore_checks);
            break;

        case DRIFT:
            success = drift_init(ignore_checks);
            break;

        case SPORT:
            success = sport_init(ignore_checks);
            break;

        case FLIP:
            success = flip_init(ignore_checks);
            break;

#if AUTOTUNE_ENABLED == ENABLED
        case AUTOTUNE:
            success = autotune_init(ignore_checks);
            break;
#endif

#if POSHOLD_ENABLED == ENABLED
        case POSHOLD:
            success = poshold_init(ignore_checks);     //定点控制
            break;
#endif

        case BRAKE:
            success = brake_init(ignore_checks);       //刹车模式初始化
            break;

        case THROW:
            success = throw_init(ignore_checks);
            break;

        case AVOID_ADSB:
            success = avoid_adsb_init(ignore_checks);  //避障模块
            break;

        case GUIDED_NOGPS:
            success = guided_nogps_init(ignore_checks);
            break;

        // add by weihli
        case ZIGZAG:
            success = zigzag_init(ignore_checks); //植保之字形
            break;

        default:
            success = false;
            break;
    }

#if FRAME_CONFIG == HELI_FRAME
failed:
#endif

    // update flight mode
    if (success) {
        // perform any cleanup required by previous flight mode
        exit_mode(control_mode, mode);

        prev_control_mode = control_mode;
        prev_control_mode_reason = control_mode_reason;

        control_mode = mode;
        control_mode_reason = reason;
        DataFlash.Log_Write_Mode(control_mode, control_mode_reason);

        adsb.set_is_auto_mode((mode == AUTO) || (mode == RTL) || (mode == GUIDED));

#if AC_FENCE == ENABLED
        // pilot requested flight mode change during a fence breach indicates pilot is attempting to manually recover
        // this flight mode change could be automatic (i.e. fence, battery, GPS or GCS failsafe)
        // but it should be harmless to disable the fence temporarily in these situations as well
        fence.manual_recovery_start();
#endif

#if FRSKY_TELEM_ENABLED == ENABLED
        frsky_telemetry.update_control_mode(control_mode);
#endif

    } else {
        // Log error that we failed to enter desired flight mode
        Log_Write_Error(ERROR_SUBSYSTEM_FLIGHT_MODE,mode);
        gcs_send_text(MAV_SEVERITY_WARNING,&quot;Flight mode change failed&quot;);
    }

    // update notify object
    if (success) {
        notify_flight_mode(control_mode);
    }

    // return success or failure
    return success;
}
</code></pre><hr>
<p><strong>3》void Copter::init_aux_switches()</strong></p>
<hr>
<pre><code>void Copter::init_aux_switches()
{
    //设定CH7,CH8,CH10,CH11通道标志-----------------set the CH7 ~ CH12 flags
    aux_con.CH7_flag = read_3pos_switch(CH_7);
    aux_con.CH8_flag = read_3pos_switch(CH_8);
    aux_con.CH10_flag = read_3pos_switch(CH_10);
    aux_con.CH11_flag = read_3pos_switch(CH_11);

    //CH9，CH12仅在某些板上支撑----------------------ch9, ch12 only supported on some boards
    aux_con.CH9_flag = read_3pos_switch(CH_9);
    aux_con.CH12_flag = read_3pos_switch(CH_12);

    //初始化函数给交到开关-------------------------initialise functions assigned to switches
    init_aux_switch_function(g.ch7_option, aux_con.CH7_flag);
    init_aux_switch_function(g.ch8_option, aux_con.CH8_flag);
    init_aux_switch_function(g.ch10_option, aux_con.CH10_flag);
    init_aux_switch_function(g.ch11_option, aux_con.CH11_flag);

    //CH9，CH12仅在某些板上支撑-------------------ch9, ch12 only supported on some boards
    init_aux_switch_function(g.ch9_option, aux_con.CH9_flag);
    init_aux_switch_function(g.ch12_option, aux_con.CH12_flag);
}
</code></pre><p><strong>首先看下init_aux_switch_function（）函数，</strong></p>
<pre><code>void Copter::init_aux_switch_function(int8_t ch_option, uint8_t ch_flag)
{    
    //初始化通道选项-----------init channel options
    switch(ch_option) 
    {
        case AUXSW_SIMPLE_MODE:
        case AUXSW_RANGEFINDER:
        case AUXSW_FENCE:
        case AUXSW_SUPERSIMPLE_MODE:
        case AUXSW_ACRO_TRAINER:
        case AUXSW_GRIPPER:
        case AUXSW_SPRAYER:
        case AUXSW_PARACHUTE_ENABLE:
                                         //我们相信车辆将被解除武装，所以即使开关在释放位置，溜槽不会释放
        case AUXSW_PARACHUTE_3POS:      // we trust the vehicle will be disarmed so even if switch is in release position the chute will not release
        case AUXSW_RETRACT_MOUNT:
        case AUXSW_MISSION_RESET:
        case AUXSW_ATTCON_FEEDFWD:
        case AUXSW_ATTCON_ACCEL_LIM:
        case AUXSW_MOTOR_ESTOP:
        case AUXSW_MOTOR_INTERLOCK:
        case AUXSW_AVOID_ADSB:
        case AUXSW_PRECISION_LOITER:
        case AUXSW_AVOID_PROXIMITY:
            do_aux_switch_function(ch_option, ch_flag);
            break;
    }
}
</code></pre><hr>
<p><strong>其次分析：do_aux_switch_function(ch_option, ch_flag);//这里才是关键</strong></p>
<hr>
<p><strong>（1）分析static RC_Channel *rc_channel(uint8_t chan)</strong></p>
<hr>
<pre><code>  static RC_Channel *rc_channel(uint8_t chan)
{
        return (chan &lt; NUM_RC_CHANNELS)?&amp;channels[chan]:nullptr;
}
//这个函数chan &lt; NUM_RC_CHANNELS恒成立，则得到&amp;channels[chan]，
//由于RC_Channel *RC_Channels::channels;则是RC_Channels类中的RC_Channel的对象成员
</code></pre><hr>
<p><strong>（2）分析rcmap.roll()，rcmap.pitch()，rcmap.throttle()，rcmap.yaw()获取通道号</strong></p>
<hr>
<p><img src="https://img-blog.csdn.net/20180814163441691?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"><br><strong>最后得到：rcmap.roll()-1=0；rcmap.pitch()-1=1；rcmap.throttle()-1=2；rcmap.yaw()-1=3</strong></p>
<pre><code>channel_roll     = RC_Channels::rc_channel(0);     //横滚通道
channel_pitch    = RC_Channels::rc_channel(1);    //俯仰通道
channel_throttle = RC_Channels::rc_channel(2);   //油门通道
channel_yaw      = RC_Channels::rc_channel(3);  //偏航通道
</code></pre><p><strong>这里还是要找到channels[0],channels[1],channels[2],channels[3]</strong></p>
<pre><code>//找到这就找到了初始化的值
 const RC_Channel *channels[] = 
{
        copter.channel_roll, 
        copter.channel_pitch,
        copter.channel_throttle,
        copter.channel_yaw
};
</code></pre><p><img src="https://img-blog.csdn.net/20180814164846746?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p><strong>到这里我们只需要研究</strong></p>
<blockquote>
<p><strong>copter.channel_roll</strong><br><strong>copter.channel_pitch</strong><br><strong>copter.channel_throttle</strong><br><strong>copter.channel_yaw</strong></p>
</blockquote>
<hr>
<p><strong>（3）分析set_angle（）</strong></p>
<hr>
<pre><code>    channel_roll-&gt;set_angle(ROLL_PITCH_YAW_INPUT_MAX); //最大4500
    channel_pitch-&gt;set_angle(ROLL_PITCH_YAW_INPUT_MAX);//最大4500
    channel_yaw-&gt;set_angle(ROLL_PITCH_YAW_INPUT_MAX);  //最大4500
    channel_throttle-&gt;set_range(1000);                 //1000
</code></pre><p>//ROLL_PITCH_YAW_INPUT_MAX=4500</p>
<pre><code>void RC_Channel::set_angle(uint16_t angle) //
{
    type_in = RC_CHANNEL_TYPE_ANGLE;//#define RC_CHANNEL_TYPE_ANGLE  0,这里后面会用到选择范围或者角度
    high_in = angle;
}

    RC_Channels::rc_channel(CH_5)-&gt;set_range(1000); //CH_5=4
    RC_Channels::rc_channel(CH_6)-&gt;set_range(1000);  //CH_6=5
    RC_Channels::rc_channel(CH_7)-&gt;set_range(1000);  //CH_7=6
    RC_Channels::rc_channel(CH_8)-&gt;set_range(1000);  //CH_8=7
</code></pre><p><strong>可以看出：</strong><br>横滚通道:[-4500,4500] ;<br>俯仰通道:[-4500,4500] ;<br>偏航通道:[-4500,4500] ;<br>油门通道:[0,1000] ；<br>其他外部通道值：0-1000</p>
<hr>
<p><strong>（4）分析void Copter::default_dead_zones()</strong></p>
<pre><code>void Copter::default_dead_zones()
{
    channel_roll-&gt;set_default_dead_zone(20); //死区范围+-20
    channel_pitch-&gt;set_default_dead_zone(20);//死区范围+-20
#if FRAME_CONFIG == HELI_FRAME
    channel_throttle-&gt;set_default_dead_zone(10);
    channel_yaw-&gt;set_default_dead_zone(15);
    RC_Channels::rc_channel(CH_6)-&gt;set_default_dead_zone(10);
#else
    channel_throttle-&gt;set_default_dead_zone(30);//死区范围+-30
    channel_yaw-&gt;set_default_dead_zone(20);//死区范围+-20
#endif
    RC_Channels::rc_channel(CH_6)-&gt;set_default_dead_zone(0); //死区范围0
}
</code></pre><p><strong>最后：ap.throttle_zero = true;//设置油门死区范围使能，到这里遥控器初始化基本讲解完成，细节问题，以后继续深挖。特别讲解遥控器底层驱动时，怎么转换到这里。</strong></p>
<hr>
<hr>
<h1 id="2-遥控器数据更新"><a href="#2-遥控器数据更新" class="headerlink" title="2.遥控器数据更新"></a>2.遥控器数据更新</h1><hr>
<hr>
<pre><code>SCHED_TASK(rc_loop, 100,  130), //遥控器数据读取函数，10ms，判断飞行模式是否发生改变
</code></pre><hr>
<p><strong>（1）void Copter::rc_loop()</strong></p>
<hr>
<pre><code>void Copter::rc_loop()
{
    //读取遥控器的通道数据和三段开关的位置信息-------------- Read radio and 3-position switch on radio
    read_radio();
    read_control_switch(); //读取三段开关数据
}
</code></pre><hr>
<p><strong>（2）read_radio();//读取遥控器数据</strong></p>
<hr>
<p><strong>//用来读取各个通道的PWM值，并进行角度或范围的转换。read_control_switch根据上一函数读到的PWM值判断开关的位置， 并作进一步处理。今天主要看read_radio.此函数定义在radio.cpp中//</strong></p>
<hr>
<pre><code>void Copter::read_radio()
{
    uint32_t tnow_ms = millis(); //获取系统时间

    if (hal.rcin-&gt;new_input())//判断有没有遥控器新的输入数据到来，有返回1，执行if没有返回0，执行else
    {
        ap.new_radio_frame = true;
        RC_Channels::set_pwm_all(); //设置所有遥控器输入值

        set_throttle_and_failsafe(channel_throttle-&gt;get_radio_in()); //油门通道检查
        set_throttle_zero_flag(channel_throttle-&gt;get_control_in());  //获取控制通道

        //我们必须安装一个RC接收器标志---------flag we must have an rc receiver attached
        if (!failsafe.rc_override_active)
        {
            ap.rc_receiver_present = true;
        }

        // pass pilot input through to motors (used to allow wiggling servos while disarmed on heli, single, coax copters)
        //将控制着的输入传递到电机（用于允许在HELI、单、同轴直升机上解除武装时的摆动伺服）
        radio_passthrough_to_motors();

        float dt = (tnow_ms - last_radio_update_ms)*1.0e-3f;//获取函数运行时间，用于低通滤波
        rc_throttle_control_in_filter.apply(channel_throttle-&gt;get_control_in(), dt); //对遥控器数据低通滤波处理
        last_radio_update_ms = tnow_ms;//更新下一次使用
    }else//没有新的数据到来，执行故障保护
    {
        uint32_t elapsed = tnow_ms - last_radio_update_ms;
        //打开故障安全处理--如果遥控器在500ms-2000ms没有数据到来----turn on throttle failsafe if no update from the RC Radio for 500ms or 2000ms if we are using RC_OVERRIDE
        if (((!failsafe.rc_override_active &amp;&amp; (elapsed &gt;= FS_RADIO_TIMEOUT_MS)) || (failsafe.rc_override_active &amp;&amp; (elapsed &gt;= FS_RADIO_RC_OVERRIDE_TIMEOUT_MS))) &amp;&amp;
            (g.failsafe_throttle &amp;&amp; (ap.rc_receiver_present||motors-&gt;armed()) &amp;&amp; !failsafe.radio))
        {
            Log_Write_Error(ERROR_SUBSYSTEM_RADIO, ERROR_CODE_RADIO_LATE_FRAME);//错误写入日志，方便查找原因
            set_failsafe_radio(true);//设置故障
        }
    }
}
</code></pre><hr>
<p><strong>1&gt;&gt;bool PX4RCInput::new_input()</strong></p>
<hr>
<pre><code>bool PX4RCInput::new_input()
{
    pthread_mutex_lock(&amp;rcin_mutex); //信号量，加锁，nuttx没研究后期在分析；在编程中，引入了对象互斥锁的概念，来保证共享数据操作的完整性。每个对象都对应于一个可称为&quot; 互斥锁&quot; 的标记，这个标记用来保证在任一时刻，只能有一个线程访问该对象。
    bool valid = _rcin.timestamp_last_signal != _last_read;
    if (_rcin.rc_failsafe)
    {
        // don&#39;t consider input valid if we are in RC failsafe.
        valid = false;
    }
    if (_override_valid)
    {
        // if we have RC overrides active, then always consider it valid
        valid = true;
    }
    _last_read = _rcin.timestamp_last_signal;
    _override_valid = false;
    pthread_mutex_unlock(&amp;rcin_mutex); //信号量不上锁，互斥信号量
    return valid;
}
</code></pre><hr>
<p><strong>2&gt;&gt;void RC_Channels::set_pwm_all(void)</strong></p>
<hr>
<pre><code>void RC_Channels::set_pwm_all(void)
{
    for (uint8_t i=0; i&lt;NUM_RC_CHANNELS; i++) //NUM_RC_CHANNELS=16
    {
        channels[i].set_pwm(channels[i].read()); //关键分析点：channels[i].read()将会传入：Roll,,pitch,throttle,yaw,aux，初始化可以看出
    }
}
///////////////////分析上面代码/////////////////////////////
channels[i].read()//channels[i]这个初始化已经说得很详细了，应该看明白了

uint16_t RC_Channel::read() const
{
    return hal.rcin-&gt;read(ch_in);//这里就是获取遥控器数据的函数，往下先不分析，后期看底层驱动讲解，记住这里就是从底层驱动获取遥控器数据的地方，很重要，
}
///////////////////分析上面代码/////////////////////////////

// type_in = RC_CHANNEL_TYPE_ANGLE;//#define RC_CHANNEL_TYPE_ANGLE  0,这里后面会用到选择范围或者角度
void RC_Channel::set_pwm(int16_t pwm)
{
    radio_in = pwm;

    if (type_in == RC_CHANNEL_TYPE_RANGE)
    {
        control_in = pwm_to_range();//PWM到范围
    } else
    {
        //RC_CHANNEL_TYPE_ANGLE
        control_in = pwm_to_angle(); //pwm到角度,选择使用这一种方式，但是我们还是分析一下if语句
    }
}
</code></pre><hr>
<p><strong>我们重点看下pwm_to_range()和pwm_to_angle()函数</strong></p>
<hr>
<p><strong>《1》pwm_to_range（）</strong></p>
<hr>
<pre><code>//将脉宽调制值转换为配置范围内的值

int16_t RC_Channel::pwm_to_range()//将脉宽调制值转换为配置范围内的值

{
    return pwm_to_range_dz(dead_zone);//分析这个函数
}
//调用pwm_to_range_dz(dead_zone)函数
//将脉宽调制值转换为配置中的值范围，使用指定的死区
int16_t RC_Channel::pwm_to_range_dz(uint16_t _dead_zone)
{
    int16_t r_in = constrain_int16(radio_in, radio_min.get(), radio_max.get());//遥控器数入限制到一定的范围i值内

    if (reversed) //通道值是否翻转
    {
        r_in = radio_max.get() - (r_in - radio_min.get()); //
    }

    int16_t radio_trim_low  = radio_min + _dead_zone; //获取最小值

    if (r_in &gt; radio_trim_low) //判断遥控器值是否大于最小设定值
    {
        return (((int32_t)(high_in) * (int32_t)(r_in - radio_trim_low)) / (int32_t)(radio_max - radio_trim_low));//比如：1000*（x-20）/(1000-20)
    }
    return 0;
}
</code></pre><hr>
<p><strong>《2》pwm_to_angle（）</strong></p>
<p><strong>从当前遥控器输入值返回一个角度：“单位是角度的100倍，也就是cm角度”（通常为-4500到4500）</strong></p>
<pre><code>int16_t RC_Channel::pwm_to_angle()
{
    return pwm_to_angle_dz(dead_zone);
}

//从当前遥控器输入值返回一个角度：“单位是角度的100倍，也就是cm角度”（通常为-4500到4500）,加入了死区限制
int16_t RC_Channel::pwm_to_angle_dz(uint16_t _dead_zone)
{
    return pwm_to_angle_dz_trim(_dead_zone, radio_trim);//这个radio_trim是多少呢，在参数中有说明。也可以看下图。或者地面站数据
}
</code></pre><p><img src="https://img-blog.csdn.net/20180815092103646?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"><br><img src="https://img-blog.csdn.net/20180815092505562?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<pre><code>int16_t RC_Channel::pwm_to_angle_dz_trim(uint16_t _dead_zone, uint16_t _trim)
{
    int16_t radio_trim_high = _trim + _dead_zone; //计算遥控器的最大值radio_trim, 1500
    int16_t radio_trim_low  = _trim - _dead_zone; //计算最小值radio_trim, 1500
    // prevent div by 0
    if ((radio_trim_low - radio_min) == 0 || (radio_max - radio_trim_high) == 0)
        return 0;

    int16_t reverse_mul = (reversed?-1:1);
    if (radio_in &gt; radio_trim_high) 
    {
        return reverse_mul * ((int32_t)high_in * (int32_t)(radio_in - radio_trim_high)) / (int32_t)(radio_max  - radio_trim_high);
    } else if (radio_in &lt; radio_trim_low) 
    {
        return reverse_mul * ((int32_t)high_in * (int32_t)(radio_in - radio_trim_low)) / (int32_t)(radio_trim_low - radio_min);
    } else  
    {
        return 0;
    }
}
</code></pre><p><strong>上面代码什么意思呢？</strong><br><strong>我们细细分析：如下图，以第一通道为例计算：</strong></p>
<p><strong>high_in =4500，这个初始化部分有，可以看这个函数：</strong></p>
<blockquote>
<p>channel_roll-&gt;set_angle(ROLL_PITCH_YAW_INPUT_MAX);<br>计算这个：reverse_mul * ((int32_t)high_in * (int32_t)(radio_in - radio_trim_high)) / (int32_t)(radio_max - radio_trim_high)<br>reverse_mul <em>（(int32_t)4500</em>（int32_t）（x-1506）/((int32_t)(1927-1506))）<br><strong>这样是不是就是【-4500，+4500】,显然是的，横滚俯仰，偏航的都是这个范围，但是油门的不是，可以自己计算下，油门值范围：【0-1000】</strong><br><img src="https://img-blog.csdn.net/20180815093224585?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
</blockquote>
<hr>
<p><strong>到这里RC_Channels::set_pwm_all();这个函数的作用就很清晰了：处理遥控器的输入数据，到规定的控制范围数据内，最多支持16通道数据。</strong></p>
<hr>
<p><strong>3&gt;&gt;set_throttle_and_failsafe(channel_throttle-&gt;get_radio_in())设置故障保护</strong></p>
<hr>
<pre><code>void Copter::set_throttle_and_failsafe(uint16_t throttle_pwm)
{
    //如果故障安全未启用，则通过油门和退出这个函数------ if failsafe not enabled pass through throttle and exit
    if(g.failsafe_throttle == FS_THR_DISABLED) //通过参数设置
    {
        channel_throttle-&gt;set_pwm(throttle_pwm);
        return;
    }

    //检查低油门值----------check for low throttle value
    if (throttle_pwm &lt; (uint16_t)g.failsafe_throttle_value) //g.failsafe_throttle_value通过地面站设置，FS_THR_VALUE=975
    {

        //如果我们已经在遥控器故障或电机没有解锁，油门直接通过和退出---- if we are already in failsafe or motors not armed pass through throttle and exit
        if (failsafe.radio || !(ap.rc_receiver_present || motors-&gt;armed())) 
        {
            channel_throttle-&gt;set_pwm(throttle_pwm);
            return;
        }

        //检查3个低油门值----- check for 3 low throttle values
        //注意：我们不通过低油门，直到接收到3个低油门值。--- Note: we do not pass through the low throttle until 3 low throttle values are received
        failsafe.radio_counter++;
        if( failsafe.radio_counter &gt;= FS_COUNTER ) 
        {
            failsafe.radio_counter = FS_COUNTER;      //检查以确保我们不会溢出计数器---- check to ensure we don&#39;t overflow the counter
            set_failsafe_radio(true);
            channel_throttle-&gt;set_pwm(throttle_pwm); //通过故障安全---- pass through failsafe throttle
        }
    }else
    {
        //我们有一个好油门值，所以减少故障安全计数器----we have a good throttle so reduce failsafe counter
        failsafe.radio_counter--;
        if( failsafe.radio_counter &lt;= 0 ) 
        {
            failsafe.radio_counter = 0;   //检查以确保我们不会溢出计数器---- check to ensure we don&#39;t underflow the counter

            //再三获取（几乎）连续有效油门值后，断开故障保险--- disengage failsafe after three (nearly) consecutive valid throttle values
            if (failsafe.radio) 
            {
                set_failsafe_radio(false);
            }
        }
        //通过油门值------pass through throttle
        channel_throttle-&gt;set_pwm(throttle_pwm);
    }
}
</code></pre><hr>
<p><strong>4&gt;&gt;set_throttle_zero_flag(channel_throttle-&gt;get_control_in());设置油门0标志</strong></p>
<hr>
<pre><code>void Copter::set_throttle_zero_flag(int16_t throttle_control)
{
    static uint32_t last_nonzero_throttle_ms = 0;
    uint32_t tnow_ms = millis();

    // if not using throttle interlock and non-zero throttle and not E-stopped,
    // or using motor interlock and it&#39;s enabled, then motors are running, 
    // and we are flying. Immediately set as non-zero
    if ((!ap.using_interlock &amp;&amp; (throttle_control &gt; 0) &amp;&amp; !ap.motor_emergency_stop) || (ap.using_interlock &amp;&amp; motors-&gt;get_interlock())) 
    {
        last_nonzero_throttle_ms = tnow_ms;
        ap.throttle_zero = false;
    } else if (tnow_ms - last_nonzero_throttle_ms &gt; THROTTLE_ZERO_DEBOUNCE_TIME_MS) 
    {
        ap.throttle_zero = true;
    }
}
</code></pre><hr>
<p><strong>5&gt;&gt;radio_passthrough_to_motors();控制输入传递到电机库</strong></p>
<hr>
<pre><code>void Copter::radio_passthrough_to_motors()
{
    motors-&gt;set_radio_passthrough(channel_roll-&gt;norm_input(), //范围【-1，+1】
                                  channel_pitch-&gt;norm_input(),//范围【-1，+1】
                                  channel_throttle-&gt;get_control_in_zero_dz()*0.001,//范围【0，+1】
                                  channel_yaw-&gt;norm_input());//范围【-1，+1】
}
</code></pre><p><strong>我们先看下set_radio_passthrough（）这个函数的实现过程。</strong></p>
<pre><code>void AP_Motors::set_radio_passthrough(float roll_input, float pitch_input, float throttle_input, float yaw_input)
{
    _roll_radio_passthrough = roll_input;//_roll_radio_passthrough 横滚受保护的值【-1，+1】
    _pitch_radio_passthrough = pitch_input;//_pitch_radio_passthrough俯仰受保护的值【-1，+1】 
    _throttle_radio_passthrough = throttle_input;//_throttle_radio_passthrough 油门受保护的值【0，+1】
    _yaw_radio_passthrough = yaw_input;//_yaw_radio_passthrough 偏航受保护的值【-1，+1】
}
</code></pre><p><strong>上面函数就是传递数据到电机库，参与PID运算，进而控制无人机</strong><br>继续分析float RC_Channel::norm_input()这个函数是处理输入到规定的范围值</p>
<pre><code>float RC_Channel::norm_input()//这个函数不用解释，跟上面的计算【-4500，+4500】类似
{
    float ret;
    int16_t reverse_mul = (reversed?-1:1);
    if (radio_in &lt; radio_trim) 
    {
        if (radio_min &gt;= radio_trim) 
        {
            return 0.0f;
        }
        ret = reverse_mul * (float)(radio_in - radio_trim) / (float)(radio_trim - radio_min);
    } else 
    {
        if (radio_max &lt;= radio_trim) 
        {
            return 0.0f;
        }
        ret = reverse_mul * (float)(radio_in - radio_trim) / (float)(radio_max  - radio_trim);
    }
    return constrain_float(ret, -1.0f, 1.0f);
}
</code></pre><hr>
<p><strong>6&gt;&gt; rc_throttle_control_in_filter.apply(channel_throttle-&gt;get_control_in(), dt)</strong><br>//不讲解这个滤波，可以看下网上的低通滤波推导过程</p>
<pre><code>template &lt;class T&gt;
T LowPassFilter&lt;T&gt;::apply(T sample, float dt) 
{
    return _filter.apply(sample, _cutoff_freq, dt);
}
</code></pre><p>template<br>T DigitalLPF::apply(const T &amp;sample)<br>{<br>_output += (sample - _output) * alpha;<br>return _output;<br>}</p>
<hr>
<hr>
<hr>
<p><strong>(3)void Copter::read_control_switch()//读取三段开关，切换飞行模式</strong><br>上面的函数主要处理1，2，3，4，6，7，8通道数据，但是没有处理外部开关5通道数据，那是因为5通道数据，默认被apm固件作为控制切换无人机的飞行模式。<br><img src="https://img-blog.csdn.net/20180815102931234?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"><br><img src="https://img-blog.csdn.net/20180815103034411?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeGlhb3dlaW1hc2hpeGlhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<pre><code>void Copter::read_control_switch()
{
    uint32_t tnow_ms = millis();//获取系统时间

    //计算飞行模式开关位置--------------------calculate position of flight mode switch
    int8_t switch_position;                //获取5通道遥控器的位置设定飞行模式
    uint16_t rc5_in = RC_Channels::rc_channel(CH_5)-&gt;get_radio_in();  //获取5通道数据
    //判断5通道PWM值得大小在哪个范围
    if      (rc5_in &lt; 1231) switch_position = 0;
    else if (rc5_in &lt; 1361) switch_position = 1;
    else if (rc5_in &lt; 1491) switch_position = 2;
    else if (rc5_in &lt; 1621) switch_position = 3;
    else if (rc5_in &lt; 1750) switch_position = 4;
    else switch_position = 5;

    //存储上次切换的时间---- store time that switch last moved
    if (control_switch_state.last_switch_position != switch_position)
    {
        control_switch_state.last_edge_time_ms = tnow_ms;
    }

    //开关去抖动处理----debounce switch
    bool control_switch_changed = control_switch_state.debounced_switch_position != switch_position;
    bool sufficient_time_elapsed = tnow_ms - control_switch_state.last_edge_time_ms &gt; CONTROL_SWITCH_DEBOUNCE_TIME_MS;
    bool failsafe_disengaged = !failsafe.radio &amp;&amp; failsafe.radio_counter == 0;

    if (control_switch_changed &amp;&amp; sufficient_time_elapsed &amp;&amp; failsafe_disengaged)
    {
        //设置飞行模式和简单模式设置---- set flight mode and simple mode setting
        if (set_mode((control_mode_t)flight_modes[switch_position].get(), MODE_REASON_TX_COMMAND))//核心函数在这里
        {
            // play a tone
            if (control_switch_state.debounced_switch_position != -1)
            {
                // alert user to mode change failure (except if autopilot is just starting up)
                if (ap.initialised) 
                {
                    AP_Notify::events.user_mode_change = 1;
                }
            }

            if (!check_if_auxsw_mode_used(AUXSW_SIMPLE_MODE) &amp;&amp; !check_if_auxsw_mode_used(AUXSW_SUPERSIMPLE_MODE))
            {
                // if none of the Aux Switches are set to Simple or Super Simple Mode then
                // set Simple Mode using stored parameters from EEPROM
                //遥控器模式设置：如果没有AUX开关设置为简单或超级简单模式，那么使用EEPROM存储参数设置简单模式
                if (BIT_IS_SET(g.super_simple, switch_position))
                {
                    set_simple_mode(2);
                } else
                {
                    set_simple_mode(BIT_IS_SET(g.simple_modes, switch_position));
                }
            }

        } else if (control_switch_state.last_switch_position != -1) 
        {
            //警告用户更改模式失败--- alert user to mode change failure
            AP_Notify::events.user_mode_change_failed = 1;
        }

        //设置去抖动开关位置---set the debounced switch position
        control_switch_state.debounced_switch_position = switch_position;
    }

    control_switch_state.last_switch_position = switch_position;
}
</code></pre><hr>
<hr>
<p><strong>分析重点函数：</strong></p>
<pre><code>set_mode((control_mode_t)flight_modes[switch_position].get(), MODE_REASON_TX_COMMAND)
</code></pre><p><strong>bool Copter::set_mode(control_mode_t mode, mode_reason_t reason)有两个参数传入</strong><br>（1）control_mode_t mode, //控制模式<br>（2）mode_reason_t reason//遥控器类型</p>
<pre><code>enum control_mode_t 
{
    STABILIZE =     0,  //手动模式--- manual airframe angle with manual throttle
    ACRO =          1,  //速率模式--- manual body-frame angular rate with manual throttle
    ALT_HOLD =      2,  // manual airframe angle with automatic throttle
    AUTO =          3,  // fully automatic waypoint control using mission commands
    GUIDED =        4,  // fully automatic fly to coordinate or fly at velocity/direction using GCS immediate commands
    LOITER =        5,  // automatic horizontal acceleration with automatic throttle
    RTL =           6,  // automatic return to launching point
    CIRCLE =        7,  // automatic circular flight with automatic throttle
    LAND =          9,  // automatic landing with horizontal position control
    DRIFT =        11,  // semi-automous position, yaw and throttle control
    SPORT =        13,  // manual earth-frame angular rate control with manual throttle
    FLIP =         14,  // automatically flip the vehicle on the roll axis
    AUTOTUNE =     15,  // automatically tune the vehicle&#39;s roll and pitch gains
    POSHOLD =      16,  // automatic position hold with manual override, with automatic throttle
    BRAKE =        17,  // full-brake using inertial/GPS system, no pilot input
    THROW =        18,  // throw to launch mode using inertial/GPS system, no pilot input
    AVOID_ADSB =   19,  // automatic avoidance of obstacles in the macro scale - e.g. full-sized aircraft
    GUIDED_NOGPS = 20,  // guided mode but only accepts attitude and altitude
    POSITION =  21,  // poshold, but sticks control speed in corresponding directions
};

//模式类型
enum mode_reason_t 
{
    MODE_REASON_UNKNOWN=0,
    MODE_REASON_TX_COMMAND,
    MODE_REASON_GCS_COMMAND,
    MODE_REASON_RADIO_FAILSAFE,
    MODE_REASON_BATTERY_FAILSAFE,
    MODE_REASON_GCS_FAILSAFE,
    MODE_REASON_EKF_FAILSAFE,
    MODE_REASON_GPS_GLITCH,
    MODE_REASON_MISSION_END,
    MODE_REASON_THROTTLE_LAND_ESCAPE,
    MODE_REASON_FENCE_BREACH,
    MODE_REASON_TERRAIN_FAILSAFE,
    MODE_REASON_BRAKE_TIMEOUT,
    MODE_REASON_FLIP_COMPLETE,
    MODE_REASON_AVOIDANCE,
    MODE_REASON_AVOIDANCE_RECOVERY,
    MODE_REASON_THROW_COMPLETE,
};


bool Copter::set_mode(control_mode_t mode, mode_reason_t reason)
{
    //如果飞行模式可以设置，则记录布尔值。---- boolean to record if flight mode could be set
    bool success = false;
    //如果没有解锁，允许开关在任何模式，我们依赖解锁检查执行
    bool ignore_checks = !motors-&gt;armed();   // allow switching to any mode if disarmed.  We rely on the arming check to perform

    //如果我们已经处于期望的模式，立即返回---- return immediately if we are already in the desired mode
    if (mode == control_mode)//设置好模式，就不用往下运行，没有设置好，继续设置
    {
        prev_control_mode = control_mode;
        prev_control_mode_reason = control_mode_reason;

        control_mode_reason = reason;
        return true;
    }


#if FRAME_CONFIG == HELI_FRAME
    // do not allow helis to enter a non-manual throttle mode if the
    // rotor runup is not complete
    if (!ignore_checks &amp;&amp; !mode_has_manual_throttle(mode) &amp;&amp; !motors-&gt;rotor_runup_complete())
    {
        goto failed;
    }
#endif

    switch (mode) 
    {
        case ACRO: //速率模式
            #if FRAME_CONFIG == HELI_FRAME
                success = heli_acro_init(ignore_checks);
            #else
                success = acro_init(ignore_checks);
            #endif
            break;

        case STABILIZE://自稳模式
            #if FRAME_CONFIG == HELI_FRAME
                success = heli_stabilize_init(ignore_checks);
            #else
                success = stabilize_init(ignore_checks);
            #endif
            break;

        case ALT_HOLD://定高模式
            success = althold_init(ignore_checks);
            break;

        case AUTO:  //自动模式
            success = auto_init(ignore_checks);
            break;

        case CIRCLE://绕圈模式
            success = circle_init(ignore_checks);
            break;

        case LOITER://留待模式
            success = loiter_init(ignore_checks);
            break;

        case GUIDED://指点模式
            success = guided_init(ignore_checks);
            break;

        case LAND://降落模式
            success = land_init(ignore_checks);
            break;

        case RTL: //返航模式
            success = rtl_init(ignore_checks);
            break;

        case DRIFT://漂移模式
            success = drift_init(ignore_checks);
            break;

        case SPORT://运动模式
            success = sport_init(ignore_checks);
            break;

        case FLIP://斜坡模式
            success = flip_init(ignore_checks);
            break;

#if AUTOTUNE_ENABLED == ENABLED
        case AUTOTUNE://自动调参模式
            success = autotune_init(ignore_checks);
            break;
#endif

#if POSHOLD_ENABLED == ENABLED
        case POSHOLD://位置控制模式
            success = poshold_init(ignore_checks);
            break;
#endif

        case BRAKE://刹车模式
            success = brake_init(ignore_checks);
            break;

        case THROW://抛投模式
            success = throw_init(ignore_checks);
            break;

        case AVOID_ADSB://自动广播模式
            success = avoid_adsb_init(ignore_checks);
            break;

        case GUIDED_NOGPS://指点模式没有GPS
            success = guided_nogps_init(ignore_checks);
            break;


        case POSITION://位置
            success = position_init(ignore_checks);
            break;

        default:
            success = false;
            break;
    }

#if FRAME_CONFIG == HELI_FRAME
failed:
#endif

    // update flight mode
    if (success) //更新飞行模式，如果设置成功
    {
        //执行先前飞行模式需要清理--- perform any cleanup required by previous flight mode
        exit_mode(control_mode, mode);

        prev_control_mode = control_mode;
        prev_control_mode_reason = control_mode_reason;

        control_mode = mode;
        control_mode_reason = reason;
        DataFlash.Log_Write_Mode(control_mode, control_mode_reason);

        adsb.set_is_auto_mode((mode == AUTO) || (mode == RTL) || (mode == GUIDED));

#if AC_FENCE == ENABLED
        // pilot requested flight mode change during a fence breach indicates pilot is attempting to manually recover
        // this flight mode change could be automatic (i.e. fence, battery, GPS or GCS failsafe)
        // but it should be harmless to disable the fence temporarily in these situations as well
        fence.manual_recovery_start();
#endif

#if FRSKY_TELEM_ENABLED == ENABLED
        frsky_telemetry.update_control_mode(control_mode);
#endif

    } else {
        // Log error that we failed to enter desired flight mode
        Log_Write_Error(ERROR_SUBSYSTEM_FLIGHT_MODE,mode);
        gcs_send_text(MAV_SEVERITY_WARNING,&quot;Flight mode change failed&quot;);
    }

    //发送更新模式到OreoLED---update notify object
    if (success) 
    {
        notify_flight_mode(control_mode);
    }

    //返回成功或者失败------return success or failure
    return success;
}
</code></pre><hr>
<p><strong>通知OreoLED处理函数：notify_flight_mode(control_mode);（OreoLED这个不是RGBled不知道是什么？）</strong></p>
<hr>
<pre><code>void Copter::notify_flight_mode(control_mode_t mode)
{
    AP_Notify::flags.flight_mode = mode;

    switch (mode) 
    {
        case AUTO:
        case GUIDED:
        case RTL:
        case CIRCLE:
        case AVOID_ADSB:
        case GUIDED_NOGPS:
        case LAND:
            // autopilot modes
            AP_Notify::flags.autopilot_mode = true;
            break;
        default:
            // all other are manual flight modes
            AP_Notify::flags.autopilot_mode = false;
            break;
    }

    // set flight mode string
    switch (mode) {
        case STABILIZE:
            notify.set_flight_mode_str(&quot;STAB&quot;);
            break;
        case ACRO:
            notify.set_flight_mode_str(&quot;ACRO&quot;);
            break;
        case ALT_HOLD:
            notify.set_flight_mode_str(&quot;ALTH&quot;);
            break;
        case AUTO:
            notify.set_flight_mode_str(&quot;AUTO&quot;);
            break;
        case GUIDED:
            notify.set_flight_mode_str(&quot;GUID&quot;);
            break;
        case LOITER:
            notify.set_flight_mode_str(&quot;LOIT&quot;);
            break;
        case RTL:
            notify.set_flight_mode_str(&quot;RTL &quot;);
            break;
        case CIRCLE:
            notify.set_flight_mode_str(&quot;CIRC&quot;);
            break;
        case LAND:
            notify.set_flight_mode_str(&quot;LAND&quot;);
            break;
        case DRIFT:
            notify.set_flight_mode_str(&quot;DRIF&quot;);
            break;
        case SPORT:
            notify.set_flight_mode_str(&quot;SPRT&quot;);
            break;
        case FLIP:
            notify.set_flight_mode_str(&quot;FLIP&quot;);
            break;
        case AUTOTUNE:
            notify.set_flight_mode_str(&quot;ATUN&quot;);
            break;
        case POSHOLD:
            notify.set_flight_mode_str(&quot;PHLD&quot;);
            break;
        case BRAKE:
            notify.set_flight_mode_str(&quot;BRAK&quot;);
            break;
        case THROW:
            notify.set_flight_mode_str(&quot;THRW&quot;);
            break;
        case AVOID_ADSB:
            notify.set_flight_mode_str(&quot;AVOI&quot;);
            break;
        case GUIDED_NOGPS:
            notify.set_flight_mode_str(&quot;GNGP&quot;);
            break;
        case POSITION:
            notify.set_flight_mode_str(&quot;POS&quot;);
        default:
            notify.set_flight_mode_str(&quot;----&quot;);
            break;
    }
}
</code></pre><hr>
<hr>
<h1 id="3-遥控器代码调用逻辑"><a href="#3-遥控器代码调用逻辑" class="headerlink" title="3.遥控器代码调用逻辑"></a>3.遥控器代码调用逻辑</h1><p><img src="-" alt="这里写图片描述"></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/13/Ardupilot%E9%81%A5%E6%8E%A7%E5%99%A8%E8%BE%93%E5%85%A5%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-APM源码解读（三）" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/09/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/">APM源码解读（三）</a>
    </h1>
  

        
        <a href="/2020/05/09/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/" class="archive-article-date">
  	<time datetime="2020-05-09T12:47:34.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-09</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-multicopter-attitude-rate-update"><a href="#1-multicopter-attitude-rate-update" class="headerlink" title="1 multicopter_attitude_rate_update"></a>1 multicopter_attitude_rate_update</h2>
        
          <a class="article-more-a" href="/2020/05/09/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/#more">more >></a>
        
      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/09/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-plane学习（一）" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/08/plane%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/">plane学习（一）</a>
    </h1>
  

        
        <a href="/2020/05/08/plane%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/" class="archive-article-date">
  	<time datetime="2020-05-08T12:53:30.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-08</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>QuadPlane support:</p>
<h2 id="过渡"><a href="#过渡" class="headerlink" title="过渡"></a>过渡</h2><p>QuadPlane过渡是飞机在主要以VTOL（类似直升机）飞机飞行和以传统固定翼飞机飞行之间转换的地方。过渡在两个方向上发生，并且可以由飞行员命令或根据空速和飞行模式自动发生。</p>
<p>发起过渡的主要方法是更改​​飞行模式，可以使用发射机上的飞行模式通道，也可以使用地面站命令更改模式。</p>
<p>如果过渡到手动，则VTOL电动机将立即停止。如果是倾转旋翼，则电动机将立即旋转到向前的飞行方向。</p>
<p>如果您转换到任何其他固定翼模式，则VTOL电动机将继续提供升力和稳定性，直到达到ARSPD_FBW_MIN空速（如果没有空速传感器，则达到 空速估算值）。对于倾转旋翼，电机将倾斜至Q_TILT_MAX开始为过渡建立前进的空速。VTOL电动机的行为与QHOVER中的类似，并且将尝试在过渡过程中保持当前的高度。前推力由油门杆以与进入任何固定翼模式相似的方式控制。在FBWA中，它是直接控制的，即低摇杆为零推力，QuadPlane只会悬停。对于倾转旋翼，低于中间操纵杆的操纵杆位置将使VTOL电动机按比例旋转回垂直方向，因为这可以控制正向推力分量。在FBWB / CRUISE中，根据是否使用空速传感器，油门操纵杆会像在该模式下一样将前进推力控制为速度或油门值。</p>
<h2 id="典型飞行"><a href="#典型飞行" class="headerlink" title="典型飞行"></a>典型飞行</h2><ul>
<li>VTOL在QLOITER或QHOVER中起飞</li>
<li>切换至FBWA模式，将油门提前50％以上并开始飞行固定翼</li>
<li>切换到QHOVER模式以返回四模式并将油门减小至50％以进行悬停。</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/08/plane%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-飞控硬件" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/08/%E9%A3%9E%E6%8E%A7%E7%A1%AC%E4%BB%B6/">飞控硬件</a>
    </h1>
  

        
        <a href="/2020/05/08/%E9%A3%9E%E6%8E%A7%E7%A1%AC%E4%BB%B6/" class="archive-article-date">
  	<time datetime="2020-05-08T06:58:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-08</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>飞控硬件主要包括两种：APM和PIXHAWK.</p>
<p> APM内置六轴MEMS传感器MPU6000，气压计MS-5611，三轴磁力计HMC5883，一般还会配置GPS模块，以便更精确的惯性导航。其中，MPU6000整合了三轴陀螺仪和三轴加速度计，积分可得速度和位姿。MS-5611通过测量气压得到高度，辅助GPS定位。HMC5883通过测量地磁场得到方位，辅助无人机定向。</p>
<p> POXHAWK可以说是APM的进化版：PX4和PIXHAWK，来自苏黎世联邦理工大学。“PX4是一个软硬件开源项目（遵守BSD协议），目的在于为学术、爱好和工业团体提供一款低成本、高性能的高端自驾仪。PX4FMU自驾仪模块运行高效的实时操作系统（RTOS），Nuttx提供可移植操作系统接口（POSIX）类型的环境。由3DR联合APM小组与PX4小组于2014年推出的PIXHAWK飞控是PX4飞控的升级版本，拥有PX4和APM（ArduPilot）两套固件和相应的地面站软件，也是目前全世界飞控产品中硬件规格最高的产品。”</p>
<p> 简而言之：主流就有两种：APM和<strong>PIXHAWK</strong>。。有时指硬件，有时指软件（固件），为了明确，在此做个区分。<strong>硬件分2种：APM和PIXHAWK。</strong>APM<strong>的版本有2.5，2.6和2.8，PIXHAWK的版本有v1和v2。</strong>软件也分2种：APM和PX4<strong>软件版本就多了去了，详见github。APM硬件由于存储空间有限，最高支持到3.2.1的APM软件。PIXHAWK硬件是</strong>STM32F4**，存储空间大，对APM软件（3.2.1之后的版本也支持）和PX4都支持。</p>
<p>PIXHAWK和APM本身是两个集成的硬件，内部包含很多独立的小硬件，我们编译时飞控板的选择是跟据不同的产品名称来的以及所对应的FMU标准，FMU是板子。</p>
<p>下一步 ./waf copter是如何执行的？ ./waf plane是如何执行的，如何选择机架构型？比如说 copter包括四旋翼，六旋翼，八旋翼，plane包括普通固定翼，quadplane,以及tiltrotor这些机架构型是不同的，也就是电机（舵机）的动力分配是不一样的，那么是如何实现对不同机型的编译呢？</p>
<p>./waf configure —board （px4-v2）指选择烧录板子的类型。</p>
<p>明确./waf都编译了哪些东西。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/08/%E9%A3%9E%E6%8E%A7%E7%A1%AC%E4%BB%B6/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-性能曲面与最优点" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/08/%E6%80%A7%E8%83%BD%E6%9B%B2%E9%9D%A2%E4%B8%8E%E6%9C%80%E4%BC%98%E7%82%B9/">性能曲面与最优点</a>
    </h1>
  

        
        <a href="/2020/05/08/%E6%80%A7%E8%83%BD%E6%9B%B2%E9%9D%A2%E4%B8%8E%E6%9C%80%E4%BC%98%E7%82%B9/" class="archive-article-date">
  	<time datetime="2020-05-08T03:33:31.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-08</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>本文转载于：<a href="https://zhuanlan.zhihu.com/p/67628678" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/67628678</a></strong></p>
<h3 id="性能学习法则"><a href="#性能学习法则" class="headerlink" title="性能学习法则"></a>性能学习法则</h3><p>性能学习法则区别于其他学习法则的依据是：在网络训练过程中，网络参数（权值和偏置值）的改变旨在优化网络的性能。<br>
        
          <a class="article-more-a" href="/2020/05/08/%E6%80%A7%E8%83%BD%E6%9B%B2%E9%9D%A2%E4%B8%8E%E6%9C%80%E4%BC%98%E7%82%B9/#more">more >></a>
        
      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">神经网络</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/08/%E6%80%A7%E8%83%BD%E6%9B%B2%E9%9D%A2%E4%B8%8E%E6%9C%80%E4%BC%98%E7%82%B9/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-APM源码解读（二）" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/01/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/">APM源码解读（二）</a>
    </h1>
  

        
        <a href="/2020/05/01/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/" class="archive-article-date">
  	<time datetime="2020-05-01T05:42:05.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>所述AC_AttitudeControl 库提供5种可能的方式来控制所述无人机，最常见的3下面描述的姿态。</p>
<h1 id="1-angle-ef-roll-pitch-rate-ef-yaw"><a href="#1-angle-ef-roll-pitch-rate-ef-yaw" class="headerlink" title="1 angle_ef_roll_pitch_rate_ef_yaw()"></a>1 angle_ef_roll_pitch_rate_ef_yaw()</h1><p>位置：libraries/AC_AttitudeControl.cpp<br>该函数需要一个地轴系坐标下滚转和俯仰角度，一个地轴系坐标下的偏航速率。例如：传递给该函数三个参数分别为，roll = -1000， pitch = -1500， yaw = 500代表飞行器此时向左倾斜10°，低头15°，向右偏航速率为5°/s。<br>代码展示：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Command an euler roll and pitch angle and an euler yaw rate with angular velocity feedforward and smoothing</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AC_AttitudeControl::input_euler_angle_roll_pitch_euler_rate_yaw</span><span class="params">(<span class="keyword">float</span> euler_roll_angle_cd, <span class="keyword">float</span> euler_pitch_angle_cd, <span class="keyword">float</span> euler_yaw_rate_cds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Convert from centidegrees on public interface to radians</span></span><br><span class="line">    <span class="keyword">float</span> euler_roll_angle = radians(euler_roll_angle_cd * <span class="number">0.01f</span>);</span><br><span class="line">    <span class="keyword">float</span> euler_pitch_angle = radians(euler_pitch_angle_cd * <span class="number">0.01f</span>);</span><br><span class="line">    <span class="keyword">float</span> euler_yaw_rate = radians(euler_yaw_rate_cds * <span class="number">0.01f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate the attitude target euler angles</span></span><br><span class="line">    _attitude_target_quat.to_euler(_attitude_target_euler_angle.x, _attitude_target_euler_angle.y, _attitude_target_euler_angle.z);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add roll trim to compensate tail rotor thrust in heli (will return zero on multirotors)</span></span><br><span class="line">    euler_roll_angle += get_roll_trim_rad();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_rate_bf_ff_enabled) &#123;</span><br><span class="line">        <span class="comment">// translate the roll pitch and yaw acceleration limits to the euler axis</span></span><br><span class="line">        Vector3f euler_accel = euler_accel_limit(_attitude_target_euler_angle, Vector3f(get_accel_roll_max_radss(), get_accel_pitch_max_radss(), get_accel_yaw_max_radss()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When acceleration limiting and feedforward are enabled, the sqrt controller is used to compute an euler</span></span><br><span class="line">        <span class="comment">// angular velocity that will cause the euler angle to smoothly stop at the input angle with limited deceleration</span></span><br><span class="line">        <span class="comment">// and an exponential decay specified by smoothing_gain at the end.</span></span><br><span class="line">        _attitude_target_euler_rate.x = input_shaping_angle(wrap_PI(euler_roll_angle - _attitude_target_euler_angle.x), _input_tc, euler_accel.x, _attitude_target_euler_rate.x, _dt);</span><br><span class="line">        _attitude_target_euler_rate.y = input_shaping_angle(wrap_PI(euler_pitch_angle - _attitude_target_euler_angle.y), _input_tc, euler_accel.y, _attitude_target_euler_rate.y, _dt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When yaw acceleration limiting is enabled, the yaw input shaper constrains angular acceleration about the yaw axis, slewing</span></span><br><span class="line">        <span class="comment">// the output rate towards the input rate.</span></span><br><span class="line">        _attitude_target_euler_rate.z = input_shaping_ang_vel(_attitude_target_euler_rate.z, euler_yaw_rate, euler_accel.z, _dt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert euler angle derivative of desired attitude into a body-frame angular velocity vector for feedforward</span></span><br><span class="line">        euler_rate_to_ang_vel(_attitude_target_euler_angle, _attitude_target_euler_rate, _attitude_target_ang_vel);</span><br><span class="line">        <span class="comment">// Limit the angular velocity</span></span><br><span class="line">        ang_vel_limit(_attitude_target_ang_vel, radians(_ang_vel_roll_max), radians(_ang_vel_pitch_max), radians(_ang_vel_yaw_max));</span><br><span class="line">        <span class="comment">// Convert body-frame angular velocity into euler angle derivative of desired attitude</span></span><br><span class="line">        ang_vel_to_euler_rate(_attitude_target_euler_angle, _attitude_target_ang_vel, _attitude_target_euler_rate);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// When feedforward is not enabled, the target euler angle is input into the target and the feedforward rate is zeroed.</span></span><br><span class="line">        _attitude_target_euler_angle.x = euler_roll_angle;</span><br><span class="line">        _attitude_target_euler_angle.y = euler_pitch_angle;</span><br><span class="line">        _attitude_target_euler_angle.z += euler_yaw_rate * _dt;</span><br><span class="line">        <span class="comment">// Compute quaternion target attitude</span></span><br><span class="line">        _attitude_target_quat.from_euler(_attitude_target_euler_angle.x, _attitude_target_euler_angle.y, _attitude_target_euler_angle.z);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set rate feedforward requests to zero</span></span><br><span class="line">        _attitude_target_euler_rate = Vector3f(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">        _attitude_target_ang_vel = Vector3f(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call quaternion attitude controller</span></span><br><span class="line">    attitude_controller_run_quat();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-angle-ef-roll-pitch-yaw"><a href="#2-angle-ef-roll-pitch-yaw" class="headerlink" title="2 angle_ef_roll_pitch_yaw()"></a>2 angle_ef_roll_pitch_yaw()</h1><p>位置：libraries/AC_AttitudeControl.cpp</p>
<h1 id="3-rate-bf-roll-pitch-yaw"><a href="#3-rate-bf-roll-pitch-yaw" class="headerlink" title="3 rate_bf_roll_pitch_yaw()"></a>3 rate_bf_roll_pitch_yaw()</h1><p>位置：libraries/AC_AttitudeControl.cpp</p>
<h1 id="4-thrust-heading-rotation-angles"><a href="#4-thrust-heading-rotation-angles" class="headerlink" title="4 thrust_heading_rotation_angles"></a>4 thrust_heading_rotation_angles</h1><p>位置：libraries\AC_AttitudeControl\AC_AttitudeControl.cpp<br>目的：倾转分离的目的是让姿态更加迅速的稳定。<br>代码展示：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AC_AttitudeControl::thrust_heading_rotation_angles</span><br><span class="line"></span><br><span class="line">(Quaternion&amp; att_to_quat, <span class="keyword">const</span> Quaternion&amp; att_from_quat, </span><br><span class="line"></span><br><span class="line">Vector3f&amp; att_diff_angle, <span class="keyword">float</span>&amp; thrust_vec_dot)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把期望姿态的四元数转换为旋转矩阵 期望旋转att_to_rot_matrix</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//期望旋转att_to_rot_matrix 表示 期望机体坐标系 转到 NED 的旋转</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//记为：Ctb-&gt;n 期望姿态机体坐标系 转 NED </span></span><br><span class="line"></span><br><span class="line">    Matrix3f att_to_rot_matrix;     </span><br><span class="line"></span><br><span class="line">    att_to_quat.rotation_matrix(att_to_rot_matrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//机体坐标系的z轴向量（0,0,1）乘以期望旋转 既把期望机体坐标系的z轴转到NED系</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//zing-note:期望姿态的旋转矩阵 取出z轴列（z轴单位向量）</span></span><br><span class="line"></span><br><span class="line">    Vector3f  att_to_thrust_vec  = att_to_rot_matrix*Vector3f(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取当前姿态对应的旋转矩阵</span></span><br><span class="line"></span><br><span class="line">    Matrix3f att_from_rot_matrix; </span><br><span class="line"></span><br><span class="line">    att_from_quat.rotation_matrix(att_from_rot_matrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把当前姿态的z轴坐标系转到NED系下</span></span><br><span class="line"></span><br><span class="line">    Vector3f att_from_thrust_vec = att_from_rot_matrix*Vector3f(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前机体坐标系的z轴 与 期望机体坐标系的z轴 叉乘 可以得到旋转向量 </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//叉乘： a X b 代表 a 转到 b  a为初始 b为目标</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绕着这个向量可以将两个z轴 转至重合</span></span><br><span class="line"></span><br><span class="line">    Vector3f thrust_vec_cross = att_from_thrust_vec % att_to_thrust_vec;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前机体坐标系的z轴 与 期望机体坐标系的z轴 点乘 可以得到两个向量的夹角的余弦 即 cos theta</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过反余弦函数 求得 旋转角度 theta   即 thrust_vec_dot 表示 轴角的角</span></span><br><span class="line"></span><br><span class="line">    thrust_vec_dot = acosf(constrain_float(att_from_thrust_vec * att_to_thrust_vec,<span class="number">-1.0f</span>,<span class="number">1.0f</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//旋转向量标幺化 得到单位旋转向量 即 轴角的轴</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> thrust_vector_length = thrust_vec_cross.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(is_zero(thrust_vector_length) || is_zero(thrust_vec_dot))&#123;</span><br><span class="line"></span><br><span class="line">        thrust_vec_cross = Vector3f(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        thrust_vec_dot = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        thrust_vec_cross /= thrust_vector_length;</span><br><span class="line"></span><br><span class="line">    &#125; 你，，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过 求得的 旋转轴 和 旋转角度 可以构造轴角 然后将其转换为四元数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该轴角描述的是 初始-&gt;目标 的旋转 转成四元素描述的是 目标-&gt;初始 的旋转</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的目标 仅仅是 z轴重合的状态 不考虑yaw是否对齐.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//因为这是个中间状态所以把这次旋转叫做 tb1-&gt;cb(n系)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//（当前转轴 thrust_vec_cross 是N系下的）</span></span><br><span class="line"></span><br><span class="line">    Quaternion thrust_vec_correction_quat;</span><br><span class="line"></span><br><span class="line">    thrust_vec_correction_quat.from_axis_angle(thrust_vec_cross, thrust_vec_dot);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//旋转 tb1-&gt;cb(n系) 转到 tb1-&gt;cb(cb系) </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里用的不是标准的四元数描述旋转，不是0标量四元数，</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//目的是 将 这个误差旋转从N系转到机体系 虽然结果相同但是显的思路很乱</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//清晰的思路是 1.将转轴从N系转到机体坐标系 2.再把新的轴角转到四元数 就得到了机体坐标系下的旋转</span></span><br><span class="line"></span><br><span class="line">    thrust_vec_correction_quat = att_from_quat.inverse()*thrust_vec_correction_quat*att_from_quat;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//至此 得到的这个旋转可以把z轴对齐 ， 现在需要考虑如何把yaw对齐</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//总误差: att_from_quat.inverse()*att_to_quat</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前姿态的逆*期望姿态 就是 期望姿态-当前姿态的意思 得到的是总误差</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//旋转误差: 倾斜误差的逆*总误差 就是 总误差减去倾斜误差的意思 得到的是 剩余的旋转误差                                       </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//向量的旋转需要使用四元数旋转公式，四元数的连乘类似于旋转矩阵 可以约去坐标系</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Qcb-&gt;tb1 * Qn-&gt;cb * Qtb-&gt;n = Qtb-&gt;tb1 (即旋转误差)</span></span><br><span class="line"></span><br><span class="line">    Quaternion yaw_vec_correction_quat = thrust_vec_correction_quat.inverse()*att_from_quat.inverse()*att_to_quat;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//倾斜误差转换成 轴角 取其中的x,y</span></span><br><span class="line"></span><br><span class="line">    Vector3f rotation;</span><br><span class="line"></span><br><span class="line">    thrust_vec_correction_quat.to_axis_angle(rotation);</span><br><span class="line"></span><br><span class="line">    att_diff_angle.x = rotation.x;</span><br><span class="line"></span><br><span class="line">    att_diff_angle.y = rotation.y;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//旋转误差转换成 轴角 取其中的z</span></span><br><span class="line"></span><br><span class="line">    yaw_vec_correction_quat.to_axis_angle(rotation);</span><br><span class="line"></span><br><span class="line">    att_diff_angle.z = rotation.z;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//至此 得到了 期望姿态 与 当前姿态的全部误差 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!is_zero(_p_angle_yaw.kP()) &amp;&amp; fabsf(att_diff_angle.z) &gt; AC_ATTITUDE_ACCEL_Y_CONTROLLER_MAX_RADSS/_p_angle_yaw.kP())&#123;</span><br><span class="line"></span><br><span class="line">        att_diff_angle.z = constrain_float(wrap_PI(att_diff_angle.z), -AC_ATTITUDE_ACCEL_Y_CONTROLLER_MAX_RADSS/_p_angle_yaw.kP(), AC_ATTITUDE_ACCEL_Y_CONTROLLER_MAX_RADSS/_p_angle_yaw.kP());</span><br><span class="line"></span><br><span class="line">        yaw_vec_correction_quat.from_axis_angle(Vector3f(<span class="number">0.0f</span>,<span class="number">0.0f</span>,att_diff_angle.z));</span><br><span class="line"></span><br><span class="line">        att_to_quat = att_from_quat*thrust_vec_correction_quat*yaw_vec_correction_quat;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/01/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-APM源码解读（一）" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/30/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">APM源码解读（一）</a>
    </h1>
  

        
        <a href="/2020/04/30/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/" class="archive-article-date">
  	<time datetime="2020-04-30T05:26:32.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-04-30</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-AC-PosControl-accel-to-lean-angles"><a href="#1-AC-PosControl-accel-to-lean-angles" class="headerlink" title="1 AC_PosControl::accel_to_lean_angles"></a>1 AC_PosControl::accel_to_lean_angles</h1><hr>
<p>位置：libraries\AC_AttitudeControl\AC_PosControl.cpp<br>用途：将NED坐标系下的期望加速度转换成机体坐标系下的倾斜角度(pitch,roll)<br>源程序：</p>
<pre><code>void AC_PosControl::accel_to_lean_angles(float accel_x_cmss, float accel_y_cmss, float&amp; roll_target, float&amp; pitch_target) const
{
    float accel_right, accel_forward;

    // rotate accelerations into body forward-right frame
    accel_forward = accel_x_cmss*_ahrs.cos_yaw() + accel_y_cmss*_ahrs.sin_yaw();
    accel_right = -accel_x_cmss*_ahrs.sin_yaw() + accel_y_cmss*_ahrs.cos_yaw();

    // update angle targets that will be passed to stabilize controller
    pitch_target = atanf(-accel_forward/(GRAVITY_MSS * 100.0f))*(18000.0f/M_PI);
    float cos_pitch_target = cosf(pitch_target*M_PI/18000.0f);
    roll_target = atanf(accel_right*cos_pitch_target/(GRAVITY_MSS * 100.0f))*(18000.0f/M_PI);
}
</code></pre><p>数学推导：<br>假设飞行器z轴受力平衡，即在z轴上保持静止。<br>已知NED坐标系下期望加速度accel_x_cmss，accel_y_cmss(融合之后的加速度数据为NED坐标系下)和遥控输入的yaw，求机体坐标系下pitch角和roll角。<br>1.需要先将yaw角进行补偿，即只剩下倾斜角。<br>将NED坐标系下的水平加速度做绕z旋转，得到没有旋转只有倾斜的中间状态,该状态下的x轴方向加速度为accel_forward，y轴加速度为accel_righ。<br>NED坐标系转机体坐标系绕z轴旋转矩阵为：  </p>
<p><img src="https://pic3.zhimg.com/v2-f08f4e899a2802c9a750272c4128a606_b.jpg" alt=""></p>
<p><img src="https://pic3.zhimg.com/80/v2-f08f4e899a2802c9a750272c4128a606_720w.jpg" alt=""></p>
<p>2.通过accel_forward，accel_righ，计算pitch，roll。<br>应为飞机在z轴上受力平衡，所以机体坐标系下飞机受到的合外力将在z轴方向上产生一个-G的力才能使飞机在z轴受力平衡。<br>如图</p>
<p><img src="https://pic1.zhimg.com/v2-58f5b203c07b3c0400a2bb4486153930_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-58f5b203c07b3c0400a2bb4486153930_720w.jpg" alt=""></p>
<p>即支持飞机在NED坐标系z轴保持静止需要-G，而且需要x轴上产生accel_forward，y轴上产生accel_righ，这些都是由机体坐标系下的合外力-F提供的。</p>
<p>所以有：</p>
<p><img src="https://pic4.zhimg.com/v2-42591d1b924f3494a89576c2336e3927_b.jpg" alt=""></p>
<p><img src="https://pic4.zhimg.com/80/v2-42591d1b924f3494a89576c2336e3927_720w.jpg" alt=""></p>
<p>其中</p>
<p><img src="https://pic3.zhimg.com/v2-0eb01385fcc650bf3acf19c2384889b2_b.jpg" alt=""></p>
<p>$R_B^N$是机体坐标系转到NED坐标系的旋转矩阵(之前已经进行过yaw方向的旋转了所以这个矩阵里的yaw为0)。</p>
<p><img src="https://pic1.zhimg.com/v2-568a76a8cc99a7195ea4133dd9b56734_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-568a76a8cc99a7195ea4133dd9b56734_720w.jpg" alt=""></p>
<p>可得：</p>
<p><img src="https://pic4.zhimg.com/v2-1d656ee7378f80df9d1129f559ced537_b.jpg" alt=""></p>
<p><img src="https://pic4.zhimg.com/80/v2-1d656ee7378f80df9d1129f559ced537_720w.jpg" alt=""></p>
<p>所以有：</p>
<p><img src="https://pic3.zhimg.com/v2-582783e489702eb874e5e7033f24660e_b.jpg" alt=""></p>
<p><img src="https://pic3.zhimg.com/80/v2-582783e489702eb874e5e7033f24660e_720w.jpg" alt=""></p>
<p>所以：</p>
<p><img src="https://pic1.zhimg.com/v2-c892064cbc88514ff4fec063c9599398_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-c892064cbc88514ff4fec063c9599398_720w.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/v2-598b043d6162fb6b7bfefb2e840ececd_b.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/80/v2-598b043d6162fb6b7bfefb2e840ececd_720w.jpg" alt=""></p>
<h1 id="2-函数名：void-Quaternion-to-axis-angle"><a href="#2-函数名：void-Quaternion-to-axis-angle" class="headerlink" title="2 函数名：void Quaternion::to_axis_angle"></a>2 函数名：void Quaternion::to_axis_angle</h1><hr>
<p>位置：libraries\AP_Math\quaternion.cpp<br>功能：将四元数转换成轴角形式<br>原函数：</p>
<pre><code>void Quaternion::to_axis_angle(Vector3f &amp;v)
{
    float l = sqrtf(sq(q2)+sq(q3)+sq(q4));
    v = Vector3f(q2,q3,q4);
    if (!is_zero(l)) {
        v /= l;
        v *= wrap_PI(2.0f * atan2f(l,q1));
    }
}
</code></pre><p>单位四元素可以表示为：  </p>
<p><img src="https://pic2.zhimg.com/v2-d4370d03efc8d6a31f73563cd16a0df1_b.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/80/v2-d4370d03efc8d6a31f73563cd16a0df1_720w.jpg" alt=""></p>
<p>单位四元数有：  </p>
<p><img src="https://pic1.zhimg.com/v2-5ab71fd0084665242c112caf074adaa4_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-5ab71fd0084665242c112caf074adaa4_720w.jpg" alt=""></p>
<p>又因为：  </p>
<p><img src="https://pic1.zhimg.com/v2-3a4d891fed98d06ca87f0301b60b1cf8_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-3a4d891fed98d06ca87f0301b60b1cf8_720w.jpg" alt=""></p>
<p>可以得到：  </p>
<p><img src="https://pic1.zhimg.com/v2-43da3412fe18a02c37270e8263bed04c_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-43da3412fe18a02c37270e8263bed04c_720w.jpg" alt=""></p>
<p>所以：  </p>
<p><img src="https://pic2.zhimg.com/v2-ad253d2f465e58887899a9b2103761e1_b.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/80/v2-ad253d2f465e58887899a9b2103761e1_720w.jpg" alt=""></p>
<p>但是函数里的四元素不是单位四元素所以要进行单位化  </p>
<p><img src="https://pic1.zhimg.com/v2-534732d4e186568f75f4b01fc65b12f0_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-534732d4e186568f75f4b01fc65b12f0_720w.jpg" alt=""></p>
<p>令:  </p>
<p><img src="https://pic2.zhimg.com/v2-6b0f8dc619c8f506f6ed599aa8353831_b.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/80/v2-6b0f8dc619c8f506f6ed599aa8353831_720w.jpg" alt=""></p>
<p>所以：  </p>
<p><img src="https://pic2.zhimg.com/v2-a144a55613ef9b7175c2f273842e3115_b.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/80/v2-a144a55613ef9b7175c2f273842e3115_720w.jpg" alt=""></p>
<h1 id="3-函数名：sqrt-controller-开方控制器"><a href="#3-函数名：sqrt-controller-开方控制器" class="headerlink" title="3 函数名：sqrt_controller(开方控制器)"></a>3 函数名：sqrt_controller(开方控制器)</h1><p>位置：libraries\AC_AttitudeControl\AC_AttitudeControl.cpp(1047行)<br>用途：经过改良的kp控制，当kp过大时，会呈现根号曲线，使响应变软</p>
<pre><code>_vel_target.z = AC_AttitudeControl::sqrt_controller(_pos_error.z, _p_pos_z.kP(), _accel_z_cms, _dt);
</code></pre><p>原函数</p>
<pre><code>float AC_AttitudeControl::sqrt_controller(float error, float p, float second_ord_lim, float dt)
{                                       
    float correction_rate; 
    if (is_negative(second_ord_lim) || is_zero(second_ord_lim)) {
        //二阶限制为零或负数 在这为 _accel_z_cms
        correction_rate = error*p;  
    } else if (is_zero(p)) {
        //p为0 在这_p_pos_z.kP()=1
        if (is_positive(error)) {
            correction_rate = safe_sqrt(2.0f*second_ord_lim*(error));
        } else if (is_negative(error)) {
            correction_rate = -safe_sqrt(2.0f*second_ord_lim*(-error));
        } else {
            correction_rate = 0.0f;
        }
    } else {//zing-note:正常进这个函数
        float linear_dist = second_ord_lim/sq(p);
        if (error &gt; linear_dist) {//误差非常大
            correction_rate = safe_sqrt(2.0f*second_ord_lim*(error-(linear_dist/2.0f)));
        } else if (error &lt; -linear_dist) {//误差非常小
            correction_rate = -safe_sqrt(2.0f*second_ord_lim*(-error-(linear_dist/2.0f)));
        } else {//正常状态
            correction_rate = error*p;
        }
    }
    if (!is_zero(dt)) {
        return constrain_float(correction_rate, -fabsf(error)/dt, fabsf(error)/dt);
    } else {
        return correction_rate;
    }
}
</code></pre><p>可以看出这个函数是在KP控制上加了一些限制，如果超过限制就做一些处理，如果没有超过限制，这个控制的效果就是普通的KP，<br>_vel_target.z=_pos_error.z*_p_pos_z.kP()<br>在物理上可以理解为这个KP=1/dt，所以这个算法可以认为是位置误差微分得到速度，这个思路在APM中被广泛应用。</p>
<p>那么经过限制后会有一个什么效果呢？最直观的方式就是把函数图像画出来，假设误差是从[-10,10]匀速变化，经过这个控制器在不同p值下的输出曲线。  </p>
<p><img src="https://pic1.zhimg.com/v2-1f838e34e7a5a536587cc0b0c6c8edb0_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-1f838e34e7a5a536587cc0b0c6c8edb0_720w.jpg" alt=""></p>
<p>可以很明显的看出，在没有达到限制时，输出曲线斜率随着p值增大而变大，慢慢的限制要求达到，曲线慢慢逼近一条曲线，p越大输出越接近这条曲线，这条曲线类似于根号函数的曲线，所以这个函数取名为开方控制器。</p>
<p>这个控制器被广泛应用在APM的控制过程中，甚至是用在处理遥控器的输入信号，来控制遥控器的软硬程度，<strong>看的代码多了就发现，大家思路都差不多，区别就是这些不起眼的限制条件，先学习框架在学习细节，比如这个误差乘kp得到微分的思路你学会了吗？</strong></p>
<h1 id="4-函数名：lean-angles-to-accel"><a href="#4-函数名：lean-angles-to-accel" class="headerlink" title="4 函数名：lean_angles_to_accel"></a>4 函数名：lean_angles_to_accel</h1><p>位置：libraries\AC_AttitudeControl\AC_PosControl.cpp<br>用途：倾斜角转加速度<br>原函数：</p>
<pre><code>void AC_PosControl::lean_angles_to_accel(float&amp; accel_x_cmss, float&amp; accel_y_cmss) const
{    
    accel_x_cmss = (GRAVITY_MSS * 100) * (-_ahrs.cos_yaw() * _ahrs.sin_pitch() * _ahrs.cos_roll() - _ahrs.sin_yaw() * _ahrs.sin_roll()) / MAX(_ahrs.cos_roll()*_ahrs.cos_pitch(), 0.5f);
    accel_y_cmss = (GRAVITY_MSS * 100) * (-_ahrs.sin_yaw() * _ahrs.sin_pitch() * _ahrs.cos_roll() + _ahrs.cos_yaw() * _ahrs.sin_roll()) / MAX(_ahrs.cos_roll()*_ahrs.cos_pitch(), 0.5f);
}
</code></pre><p>上次讲了加速度转倾斜角，不知道有没有人去思考倾斜角转加速度呢？<br>我们已知倾斜角，也就是已知旋转矩阵，使用该旋转矩阵，将机体坐标系下的加速度转换到地理坐标系下即可。<br>倾斜角转加速度的思路是一样的，假设当前飞机只受重力和旋翼产生的支持力，保持z轴平衡状态。<br>所以有：  </p>
<p><img src="https://pic2.zhimg.com/v2-9515be91617976a00fcf3438f86b6dd5_b.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/80/v2-9515be91617976a00fcf3438f86b6dd5_720w.jpg" alt=""></p>
<p>其中</p>
<p><img src="https://pic3.zhimg.com/v2-ae382104b39449d111559ea0d03a2076_b.jpg" alt=""></p>
<p><img src="https://pic3.zhimg.com/80/v2-ae382104b39449d111559ea0d03a2076_720w.jpg" alt=""></p>
<p>是机体坐标系转NED坐标系的旋转矩阵。<br>可得：  </p>
<p><img src="https://pic1.zhimg.com/v2-6988120891b1deb8d8d8598a2a80c7f4_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-6988120891b1deb8d8d8598a2a80c7f4_720w.jpg" alt=""></p>
<p>所以有：  </p>
<p><img src="https://pic1.zhimg.com/v2-a543beaf69270a58895fe3e64c4101a0_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-a543beaf69270a58895fe3e64c4101a0_720w.jpg" alt=""></p>
<p>因为</p>
<p><img src="https://pic2.zhimg.com/v2-8bcd51dcaf66d2a26819c0b3dde30629_b.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/80/v2-8bcd51dcaf66d2a26819c0b3dde30629_720w.jpg" alt=""></p>
<p>产生在NED坐标系下的加速度有：  </p>
<p><img src="https://pic1.zhimg.com/v2-eb2b55a3610d2e4052f809d93e74a464_b.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/80/v2-eb2b55a3610d2e4052f809d93e74a464_720w.jpg" alt=""></p>
<p>所以：  </p>
<p><img src="https://pic4.zhimg.com/v2-5b4e005792f8d513ff142b488430e85f_b.jpg" alt=""></p>
<p><img src="https://pic4.zhimg.com/80/v2-5b4e005792f8d513ff142b488430e85f_720w.jpg" alt=""></p>
<p>至于最后为什么有个MAX，作者是这样说的</p>
<blockquote>
<p>3 is dependent on there being a large lean angle and angle boost running. If we are in ACRO and at a large lean angle then you are probably holding altitude and the Fbz is probably closer to -mg/(cos_theta * cos_rho). Using the result of 3 will also have the effect of the aircraft going through the unconstrained acceleration part of the Fbz curve on it’s way to the low angle causing a large acceleration as it levels. So 3 is not a good option in general.<br>1 and 2 are reasonable and both will result in a good starting point. 2 will result in a twitch as you say but due to the acceleration limiting in most navigation modes 1 will to. In any case we have to limit the angle to something to prevent the cos terms going to zero so we need some version of 2.<br>For now I will leave it using the 2 version until we update the output of the navigation to a full 3D acceleration controller.  </p>
</blockquote>
<p>其实这个限制有三种情况，最终选择了第二种限制方法得到了现在的函数。<br>这个函数的讨论的全过程在<br><a href="https://link.zhihu.com/?target=https%3A//github.com/ArduPilot/ardupilot/issues/7267">https://github.com/ArduPilot/ardupilot/issues/7267</a><br>可以看看这个最终函数是如何修改得到的。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/04/30/APM%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-倾转分离" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/29/%E5%80%BE%E8%BD%AC%E5%88%86%E7%A6%BB/">倾转分离</a>
    </h1>
  

        
        <a href="/2020/04/29/%E5%80%BE%E8%BD%AC%E5%88%86%E7%A6%BB/" class="archive-article-date">
  	<time datetime="2020-04-29T13:51:41.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-04-29</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-倾转扭矩分离设计"><a href="#1-倾转扭矩分离设计" class="headerlink" title="1 倾转扭矩分离设计"></a>1 倾转扭矩分离设计</h1><p>在四旋翼的工程应用中，roll和pitch是靠螺旋桨直接产生的力矩改变，响应较快。yaw是靠螺旋桨差速产生的旋转力矩改变，响应较慢。旋翼稳定飞行的首要任务是维持由滚转和俯仰运动决定的桨平面稳定，这需要更为精确的控制，也需要更多的能量分配来实现稳定，从而保证滚转-俯仰运动所决定的桨平面没有误差，相较而言，偏航运动的误差在一定范围是可以接受的，并且由扭矩对偏航角的调整缓慢，产生的误差较大，会占用大部分姿态控制的能量，反过来对整个姿态控制产生负面的影响。因此将由滚转-俯仰的控制优先级提前，先满足主要的桨平面稳定，即Z轴对齐，再进行偏航运动的控制，倾转分离过程如图所示。<br><img src="https://i.loli.net/2020/04/29/FVpkoJNC6arDe8g.jpg" alt="倾转扭矩分离.jpg"><br>将当前姿态向目标姿态的整个旋转过程分为两个部分，第一部分是先进行俯仰和滚转运动组合的旋转，然后再进行偏航运动的旋转，即当前状态-&gt;中间状态-&gt;目标状态。图中蓝色实线的坐标系是当前状态，进行了俯仰和滚转运动组合的旋转后，红色实线的坐标系为对齐了Z轴的中间状态，Z轴已没有误差的与目标旋转的Z轴所对齐，蓝色虚线代表初始状态，最后是进行偏航运动的旋转，目标姿态由黑色实线表示。</p>
<h1 id="2-倾转扭矩分离算法步骤"><a href="#2-倾转扭矩分离算法步骤" class="headerlink" title="2 倾转扭矩分离算法步骤"></a>2 倾转扭矩分离算法步骤</h1><p>对四旋翼姿态控制进行倾转分离可分成如下步骤进行：</p>
<ul>
<li>1 将目标姿态与当前姿态从NED坐标系转到机体坐标系，提取出Z轴，通过在机体坐标系下对齐目标姿态和当前姿态的Z轴得到倾斜误差；</li>
<li>2 通过四元数转换的旋转矩阵计算轴角，并将计算得到的倾斜误差转化成四元数，记倾斜误差为$Q_{E1}$；</li>
<li>3 用总的旋转误差减去倾斜误差，从而得到尚未对齐的扭矩误差$Q<em>{E2}$ ，对扭矩误差进行处理后得到新的扭矩误差$Q </em>{E2d}$ ；</li>
<li>4 将处理过的倾斜误差和扭矩误差合成为新的总误差，以轴角的形式传递给下一级控制器。</li>
</ul>
<p><img src="https://i.loli.net/2020/04/30/KSU8cy1dkC9uNzn.png" alt="倾转扭矩分离步骤.png"></p>
<p>记倾转分离算法使用规范化四元数$Q$的矩阵形式为$Q=\begin{bmatrix}q_0\q_1\q_2\q_3\end{bmatrix}$ ,则当前状态的四元数为$Q_0$ ，目标状态的四元数为$Q_1$ 。<br>对于步骤一，使用四元数转化为旋转矩阵。</p>
<script type="math/tex; mode=display">C_b^R=\begin{bmatrix}1-2q_2^2-2q_3^2&2q_1q_2-2q_3q_0&2q_1q_3+2q_2q_0\\2a_1q_2+2q_3q_0&1-2q_1^2-2q_3^2&2q_2q_3-2q_1q_0\\2q_1q_3-2q_2q_0&2q_2q_3+2q_1q_0&1-2q_1^2-2q_2^2\end{bmatrix}</script><p>左乘旋转矩阵$C<em>b^R$，，完成NED坐标系向体坐标系的转换，目标姿态的旋转矩阵为$C</em>{b1}^R$，从目标姿态提取出Z轴记为$a_1$：</p>
<script type="math/tex; mode=display">a_1=C_{b1}^R\begin{bmatrix}0\\0\\1\end{bmatrix}</script><p>当前姿态的旋转矩阵为$C_{b2}^R$，从当前姿态提取出Z轴记为$a_0$：</p>
<script type="math/tex; mode=display">a_0=C_{b1}^R\begin{bmatrix}0\\0\\1\end{bmatrix}</script><p>使用轴角描述的旋转需要旋转矢量轴$u_A$以及旋转角度$\theta$，其中$u_A=\begin{bmatrix}l\m\n\end{bmatrix}$ 。<br>从当前姿态到目标姿态的旋转矢量轴$u_1^A$:</p>
<script type="math/tex; mode=display">u_1^A=a_0\times a_1</script><p>从当前姿态到目标姿态的旋转角度$\theta$$</p>
<script type="math/tex; mode=display">\theta=arccoc(a_0.a_1)</script><p>则轴角$V_1$可以表示为：</p>
<script type="math/tex; mode=display">V_1=u_1^A.\theta=\begin{bmatrix}l.\theta\\m.\theta\\n.\theta\end{bmatrix}</script><p>对于步骤二：将轴角$V_1$转化为四元数$Q_z$。</p>
<script type="math/tex; mode=display">\begin{cases}q_0=cos{\frac{\theta}{2}}\\q_1=l.sin{\frac{\theta}{2}}\\q_2=m.sin{\frac{\theta}{2}}\\q_3=n.sin{\frac{\theta}{2}}\end{cases}</script><p>使用四元数计算先对其Z轴所产生的倾斜误差$Q_{E1}$,</p>
<script type="math/tex; mode=display">Q_{E1}=a_0^T.Q_z.a_0</script><p>对于步骤三，从总误差E中减去倾斜误差$Q<em>{E1}$,获得扭矩误差$Q</em>{E2}$,</p>
<script type="math/tex; mode=display">Q_{E2}=Q_Z^T.Q_0^T.Q_1</script><p>利用固定衰减系数$\beta$处理扭转误差，从而获得处理后的扭转误差$Q_{E2d}$</p>
<script type="math/tex; mode=display">Q_{E2d}=\beta.Q_{E2}</script><p>其中固定衰减系数$\beta$由仿真确定。<br>对于步骤四，将$Q<em>{E1},Q</em>{E2d}$分别转化为轴角：</p>
<script type="math/tex; mode=display">\theta=2.arccosq_0</script><script type="math/tex; mode=display">\begin{cases} l=\frac{q_1}{\sqrt{1-q_0^2}}\\m=\frac{q_2}{\sqrt{1-q_0^2}}\\n=\frac{q_3}{\sqrt{1-q_0^2}}\end{cases}</script><p>从而得到以轴角形式表示的角度差，通过P控制环，传递给角速度环进行后续的PID计算。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">APM</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/04/29/%E5%80%BE%E8%BD%AC%E5%88%86%E7%A6%BB/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2021 若枫
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
<!--页面点击小红心-->
<script type="text/javascript" src="/love.js"></script>

    </div>
    <script>
	var yiliaConfig = {
		mathjax: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">APM</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">计算机系统</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">数据结构</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">神经网络</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">飞行器理论知识</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>